<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3.2.6. Prefer Specifying Container Capacity &mdash; AI 模型国内加速  文档</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/style.css" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/translations.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="author" title="关于这些文档" href="../../about.html" />
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="3.2.7. Copy Slices and Maps at Boundaries" href="container-copy.html" />
    <link rel="prev" title="3.2.5. Be Consistent" href="consistency.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            AI 模型国内加速
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" aria-label="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">目录:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../best-practice/index.html">1. 【AI网盘】人工智能资源汇总</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../stable-diffusion/index.html">2. Stable Diffusion</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">3. 编程语言 规范</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../uber_go_cn/index.html">3.1. Uber Go语言规范 中文</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">3.2. Uber: Go语言规范</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="SUMMARY.html">3.2.1. Uber Go Style Guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="atomic.html">3.2.2. Use go.uber.org/atomic</a></li>
<li class="toctree-l3"><a class="reference internal" href="builtin-name.html">3.2.3. Avoid Using Built-In Names</a></li>
<li class="toctree-l3"><a class="reference internal" href="channel-size.html">3.2.4. Channel Size is One or None</a></li>
<li class="toctree-l3"><a class="reference internal" href="consistency.html">3.2.5. Be Consistent</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">3.2.6. Prefer Specifying Container Capacity</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#specifying-map-capacity-hints">3.2.6.1. Specifying Map Capacity Hints</a></li>
<li class="toctree-l4"><a class="reference internal" href="#specifying-slice-capacity">3.2.6.2. Specifying Slice Capacity</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="container-copy.html">3.2.7. Copy Slices and Maps at Boundaries</a></li>
<li class="toctree-l3"><a class="reference internal" href="decl-group.html">3.2.8. Group Similar Declarations</a></li>
<li class="toctree-l3"><a class="reference internal" href="defer-clean.html">3.2.9. Defer to Clean Up</a></li>
<li class="toctree-l3"><a class="reference internal" href="else-unnecessary.html">3.2.10. Unnecessary Else</a></li>
<li class="toctree-l3"><a class="reference internal" href="embed-public.html">3.2.11. Avoid Embedding Types in Public Structs</a></li>
<li class="toctree-l3"><a class="reference internal" href="enum-start.html">3.2.12. Start Enums at One</a></li>
<li class="toctree-l3"><a class="reference internal" href="error-name.html">3.2.13. Error Naming</a></li>
<li class="toctree-l3"><a class="reference internal" href="error-once.html">3.2.14. Handle Errors Once</a></li>
<li class="toctree-l3"><a class="reference internal" href="error-type.html">3.2.15. Error Types</a></li>
<li class="toctree-l3"><a class="reference internal" href="error-wrap.html">3.2.16. Error Wrapping</a></li>
<li class="toctree-l3"><a class="reference internal" href="exit-main.html">3.2.17. Exit in Main</a></li>
<li class="toctree-l3"><a class="reference internal" href="exit-once.html">3.2.18. Exit Once</a></li>
<li class="toctree-l3"><a class="reference internal" href="function-name.html">3.2.19. Function Names</a></li>
<li class="toctree-l3"><a class="reference internal" href="function-order.html">3.2.20. Function Grouping and Ordering</a></li>
<li class="toctree-l3"><a class="reference internal" href="functional-option.html">3.2.21. Functional Options</a></li>
<li class="toctree-l3"><a class="reference internal" href="global-decl.html">3.2.22. Top-level Variable Declarations</a></li>
<li class="toctree-l3"><a class="reference internal" href="global-mut.html">3.2.23. Avoid Mutable Globals</a></li>
<li class="toctree-l3"><a class="reference internal" href="global-name.html">3.2.24. Prefix Unexported Globals with _</a></li>
<li class="toctree-l3"><a class="reference internal" href="goroutine-exit.html">3.2.25. Wait for goroutines to exit</a></li>
<li class="toctree-l3"><a class="reference internal" href="goroutine-forget.html">3.2.26. Don’t fire-and-forget goroutines</a></li>
<li class="toctree-l3"><a class="reference internal" href="goroutine-init.html">3.2.27. No goroutines in <code class="docutils literal notranslate"><span class="pre">init()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="import-alias.html">3.2.28. Import Aliasing</a></li>
<li class="toctree-l3"><a class="reference internal" href="import-group.html">3.2.29. Import Group Ordering</a></li>
<li class="toctree-l3"><a class="reference internal" href="init.html">3.2.30. Avoid <code class="docutils literal notranslate"><span class="pre">init()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="interface-compliance.html">3.2.31. Verify Interface Compliance</a></li>
<li class="toctree-l3"><a class="reference internal" href="interface-pointer.html">3.2.32. Pointers to Interfaces</a></li>
<li class="toctree-l3"><a class="reference internal" href="interface-receiver.html">3.2.33. Receivers and Interfaces</a></li>
<li class="toctree-l3"><a class="reference internal" href="intro.html">3.2.34. Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="line-length.html">3.2.35. Avoid overly long lines</a></li>
<li class="toctree-l3"><a class="reference internal" href="lint.html">3.2.36. Linting</a></li>
<li class="toctree-l3"><a class="reference internal" href="map-init.html">3.2.37. Initializing Maps</a></li>
<li class="toctree-l3"><a class="reference internal" href="mutex-zero-value.html">3.2.38. Zero-value Mutexes are Valid</a></li>
<li class="toctree-l3"><a class="reference internal" href="nest-less.html">3.2.39. Reduce Nesting</a></li>
<li class="toctree-l3"><a class="reference internal" href="package-name.html">3.2.40. Package Names</a></li>
<li class="toctree-l3"><a class="reference internal" href="panic.html">3.2.41. Don’t Panic</a></li>
<li class="toctree-l3"><a class="reference internal" href="param-naked.html">3.2.42. Avoid Naked Parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="performance.html">3.2.43. Performance</a></li>
<li class="toctree-l3"><a class="reference internal" href="printf-const.html">3.2.44. Format Strings outside Printf</a></li>
<li class="toctree-l3"><a class="reference internal" href="printf-name.html">3.2.45. Naming Printf-style Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="slice-nil.html">3.2.46. nil is a valid slice</a></li>
<li class="toctree-l3"><a class="reference internal" href="strconv.html">3.2.47. Prefer strconv over fmt</a></li>
<li class="toctree-l3"><a class="reference internal" href="string-byte-slice.html">3.2.48. Avoid repeated string-to-byte conversions</a></li>
<li class="toctree-l3"><a class="reference internal" href="string-escape.html">3.2.49. Use Raw String Literals to Avoid Escaping</a></li>
<li class="toctree-l3"><a class="reference internal" href="struct-embed.html">3.2.50. Embedding in Structs</a></li>
<li class="toctree-l3"><a class="reference internal" href="struct-field-key.html">3.2.51. Use Field Names to Initialize Structs</a></li>
<li class="toctree-l3"><a class="reference internal" href="struct-field-zero.html">3.2.52. Omit Zero Value Fields in Structs</a></li>
<li class="toctree-l3"><a class="reference internal" href="struct-pointer.html">3.2.53. Initializing Struct References</a></li>
<li class="toctree-l3"><a class="reference internal" href="struct-tag.html">3.2.54. Use field tags in marshaled structs</a></li>
<li class="toctree-l3"><a class="reference internal" href="struct-zero.html">3.2.55. Use <code class="docutils literal notranslate"><span class="pre">var</span></code> for Zero Value Structs</a></li>
<li class="toctree-l3"><a class="reference internal" href="test-table.html">3.2.56. Test Tables</a></li>
<li class="toctree-l3"><a class="reference internal" href="time.html">3.2.57. Use <code class="docutils literal notranslate"><span class="pre">&quot;time&quot;</span></code> to handle time</a></li>
<li class="toctree-l3"><a class="reference internal" href="type-assert.html">3.2.58. Handle Type Assertion Failures</a></li>
<li class="toctree-l3"><a class="reference internal" href="var-decl.html">3.2.59. Local Variable Declarations</a></li>
<li class="toctree-l3"><a class="reference internal" href="var-scope.html">3.2.60. Reduce Scope of Variables</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../coding/index.html">4. 编程语言 语法</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cheatsheet/index.html">5. Cheat Sheet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">6. 关于</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">AI 模型国内加速</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html"><span class="section-number">3. </span>编程语言 规范</a></li>
          <li class="breadcrumb-item"><a href="index.html"><span class="section-number">3.2. </span>Uber: Go语言规范</a></li>
      <li class="breadcrumb-item active"><span class="section-number">3.2.6. </span>Prefer Specifying Container Capacity</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/style-guides/uber_go/container-capacity.md.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="prefer-specifying-container-capacity">
<h1><span class="section-number">3.2.6. </span>Prefer Specifying Container Capacity<a class="headerlink" href="#prefer-specifying-container-capacity" title="Permalink to this heading"></a></h1>
<p>Specify container capacity where possible in order to allocate memory for the
container up front. This minimizes subsequent allocations (by copying and
resizing of the container) as elements are added.</p>
<section id="specifying-map-capacity-hints">
<h2><span class="section-number">3.2.6.1. </span>Specifying Map Capacity Hints<a class="headerlink" href="#specifying-map-capacity-hints" title="Permalink to this heading"></a></h2>
<p>Where possible, provide capacity hints when initializing
maps with <code class="docutils literal notranslate"><span class="pre">make()</span></code>.</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="nx">T1</span><span class="p">]</span><span class="nx">T2</span><span class="p">,</span><span class="w"> </span><span class="nx">hint</span><span class="p">)</span>
</pre></div>
</div>
<p>Providing a capacity hint to <code class="docutils literal notranslate"><span class="pre">make()</span></code> tries to right-size the
map at initialization time, which reduces the need for growing
the map and allocations as elements are added to the map.</p>
<p>Note that, unlike slices, map capacity hints do not guarantee complete,
preemptive allocation, but are used to approximate the number of hashmap buckets
required. Consequently, allocations may still occur when adding elements to the
map, even up to the specified capacity.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">m</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">os</span><span class="p">.</span><span class="nx">FileInfo</span><span class="p">)</span>

<span class="nx">files</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">ReadDir</span><span class="p">(</span><span class="s">&quot;./files&quot;</span><span class="p">)</span>
<span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">f</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">files</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">m</span><span class="p">[</span><span class="nx">f</span><span class="p">.</span><span class="nx">Name</span><span class="p">()]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">f</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">files</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">ReadDir</span><span class="p">(</span><span class="s">&quot;./files&quot;</span><span class="p">)</span>

<span class="nx">m</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">os</span><span class="p">.</span><span class="nx">DirEntry</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">files</span><span class="p">))</span>
<span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">f</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">files</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">m</span><span class="p">[</span><span class="nx">f</span><span class="p">.</span><span class="nx">Name</span><span class="p">()]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">f</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
<tr><td><p><code class="docutils literal notranslate"><span class="pre">m</span></code> is created without a size hint; there may be more
allocations at assignment time.</p>
</td><td><p><code class="docutils literal notranslate"><span class="pre">m</span></code> is created with a size hint; there may be fewer
allocations at assignment time.</p>
</td></tr>
</tbody></table></section>
<section id="specifying-slice-capacity">
<h2><span class="section-number">3.2.6.2. </span>Specifying Slice Capacity<a class="headerlink" href="#specifying-slice-capacity" title="Permalink to this heading"></a></h2>
<p>Where possible, provide capacity hints when initializing slices with <code class="docutils literal notranslate"><span class="pre">make()</span></code>,
particularly when appending.</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nb">make</span><span class="p">([]</span><span class="nx">T</span><span class="p">,</span><span class="w"> </span><span class="nx">length</span><span class="p">,</span><span class="w"> </span><span class="nx">capacity</span><span class="p">)</span>
</pre></div>
</div>
<p>Unlike maps, slice capacity is not a hint: the compiler will allocate enough
memory for the capacity of the slice as provided to <code class="docutils literal notranslate"><span class="pre">make()</span></code>, which means that
subsequent <code class="docutils literal notranslate"><span class="pre">append()</span></code> operations will incur zero allocations (until the length
of the slice matches the capacity, after which any appends will require a resize
to hold additional elements).</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span><span class="w"> </span><span class="nx">n</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">data</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">size</span><span class="p">;</span><span class="w"> </span><span class="nx">k</span><span class="o">++</span><span class="p">{</span>
<span class="w">    </span><span class="nx">data</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">k</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span><span class="w"> </span><span class="nx">n</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">data</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">size</span><span class="p">)</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">size</span><span class="p">;</span><span class="w"> </span><span class="nx">k</span><span class="o">++</span><span class="p">{</span>
<span class="w">    </span><span class="nx">data</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">k</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
<tr><td><div class="highlight-plain notranslate"><div class="highlight"><pre><span></span>BenchmarkBad-4    100000000    2.48s
</pre></div>
</div>
</td><td><div class="highlight-plain notranslate"><div class="highlight"><pre><span></span>BenchmarkGood-4   100000000    0.21s
</pre></div>
</div>
</td></tr>
</tbody></table></section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="页脚">
        <a href="consistency.html" class="btn btn-neutral float-left" title="3.2.5. Be Consistent" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="container-copy.html" class="btn btn-neutral float-right" title="3.2.7. Copy Slices and Maps at Boundaries" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2024.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
  
<div class="view_counter">
      <img class="img_view_counter" src="https://s01.flagcounter.com/count2/m02K/bg_FFFFFF/txt_F77B1B/border_CCCCCC/columns_3/maxflags_6/viewers_3/labels_1/pageviews_0/flags_0/percent_0/" alt="View Counter" border="0" />
</div>


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="版本">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Read the Docs</span>
        v: latest
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>版本</dt>
            <dd><a href="#">latest</a></dd>
        </dl>
    </div>
</div>

</body>
</html>