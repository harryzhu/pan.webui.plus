<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>4.1. Uber: Go Style Guide - English &mdash; AI 模型国内加速  文档</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/style.css" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/translations.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="author" title="关于这些文档" href="../../about.html" />
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="4.2. Uber: Go语言 风格指南" href="../uber_go_cn/index.html" />
    <link rel="prev" title="4. 编程语言 风格指南" href="../index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            AI 模型国内加速
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" aria-label="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">目录:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../best-practice/index.html">1. 【AI网盘】人工智能资源汇总</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../stable-diffusion/index.html">2. Stable Diffusion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pytorch-guides/index.html">3. Pytorch 教程</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">4. 编程语言 风格指南</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">4.1. Uber: Go Style Guide - English</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#introduction">4.1.1. Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#guidelines">4.1.2. Guidelines</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#pointers-to-interfaces">4.1.2.1. Pointers to Interfaces</a></li>
<li class="toctree-l4"><a class="reference internal" href="#verify-interface-compliance">4.1.2.2. Verify Interface Compliance</a></li>
<li class="toctree-l4"><a class="reference internal" href="#receivers-and-interfaces">4.1.2.3. Receivers and Interfaces</a></li>
<li class="toctree-l4"><a class="reference internal" href="#zero-value-mutexes-are-valid">4.1.2.4. Zero-value Mutexes are Valid</a></li>
<li class="toctree-l4"><a class="reference internal" href="#copy-slices-and-maps-at-boundaries">4.1.2.5. Copy Slices and Maps at Boundaries</a></li>
<li class="toctree-l4"><a class="reference internal" href="#defer-to-clean-up">4.1.2.6. Defer to Clean Up</a></li>
<li class="toctree-l4"><a class="reference internal" href="#channel-size-is-one-or-none">4.1.2.7. Channel Size is One or None</a></li>
<li class="toctree-l4"><a class="reference internal" href="#start-enums-at-one">4.1.2.8. Start Enums at One</a></li>
<li class="toctree-l4"><a class="reference internal" href="#use-time-to-handle-time">4.1.2.9. Use <code class="docutils literal notranslate"><span class="pre">&quot;time&quot;</span></code> to handle time</a></li>
<li class="toctree-l4"><a class="reference internal" href="#errors">4.1.2.10. Errors</a></li>
<li class="toctree-l4"><a class="reference internal" href="#handle-type-assertion-failures">4.1.2.11. Handle Type Assertion Failures</a></li>
<li class="toctree-l4"><a class="reference internal" href="#don-t-panic">4.1.2.12. Don’t Panic</a></li>
<li class="toctree-l4"><a class="reference internal" href="#use-go-uber-org-atomic">4.1.2.13. Use go.uber.org/atomic</a></li>
<li class="toctree-l4"><a class="reference internal" href="#avoid-mutable-globals">4.1.2.14. Avoid Mutable Globals</a></li>
<li class="toctree-l4"><a class="reference internal" href="#avoid-embedding-types-in-public-structs">4.1.2.15. Avoid Embedding Types in Public Structs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#avoid-using-built-in-names">4.1.2.16. Avoid Using Built-In Names</a></li>
<li class="toctree-l4"><a class="reference internal" href="#avoid-init">4.1.2.17. Avoid <code class="docutils literal notranslate"><span class="pre">init()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#exit-in-main">4.1.2.18. Exit in Main</a></li>
<li class="toctree-l4"><a class="reference internal" href="#use-field-tags-in-marshaled-structs">4.1.2.19. Use field tags in marshaled structs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#don-t-fire-and-forget-goroutines">4.1.2.20. Don’t fire-and-forget goroutines</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#performance">4.1.3. Performance</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#prefer-strconv-over-fmt">4.1.3.1. Prefer strconv over fmt</a></li>
<li class="toctree-l4"><a class="reference internal" href="#avoid-repeated-string-to-byte-conversions">4.1.3.2. Avoid repeated string-to-byte conversions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#prefer-specifying-container-capacity">4.1.3.3. Prefer Specifying Container Capacity</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#style">4.1.4. Style</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#avoid-overly-long-lines">4.1.4.1. Avoid overly long lines</a></li>
<li class="toctree-l4"><a class="reference internal" href="#be-consistent">4.1.4.2. Be Consistent</a></li>
<li class="toctree-l4"><a class="reference internal" href="#group-similar-declarations">4.1.4.3. Group Similar Declarations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#import-group-ordering">4.1.4.4. Import Group Ordering</a></li>
<li class="toctree-l4"><a class="reference internal" href="#package-names">4.1.4.5. Package Names</a></li>
<li class="toctree-l4"><a class="reference internal" href="#function-names">4.1.4.6. Function Names</a></li>
<li class="toctree-l4"><a class="reference internal" href="#import-aliasing">4.1.4.7. Import Aliasing</a></li>
<li class="toctree-l4"><a class="reference internal" href="#function-grouping-and-ordering">4.1.4.8. Function Grouping and Ordering</a></li>
<li class="toctree-l4"><a class="reference internal" href="#reduce-nesting">4.1.4.9. Reduce Nesting</a></li>
<li class="toctree-l4"><a class="reference internal" href="#unnecessary-else">4.1.4.10. Unnecessary Else</a></li>
<li class="toctree-l4"><a class="reference internal" href="#top-level-variable-declarations">4.1.4.11. Top-level Variable Declarations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#prefix-unexported-globals-with">4.1.4.12. Prefix Unexported Globals with _</a></li>
<li class="toctree-l4"><a class="reference internal" href="#embedding-in-structs">4.1.4.13. Embedding in Structs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#local-variable-declarations">4.1.4.14. Local Variable Declarations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#nil-is-a-valid-slice">4.1.4.15. nil is a valid slice</a></li>
<li class="toctree-l4"><a class="reference internal" href="#reduce-scope-of-variables">4.1.4.16. Reduce Scope of Variables</a></li>
<li class="toctree-l4"><a class="reference internal" href="#avoid-naked-parameters">4.1.4.17. Avoid Naked Parameters</a></li>
<li class="toctree-l4"><a class="reference internal" href="#use-raw-string-literals-to-avoid-escaping">4.1.4.18. Use Raw String Literals to Avoid Escaping</a></li>
<li class="toctree-l4"><a class="reference internal" href="#initializing-structs">4.1.4.19. Initializing Structs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#initializing-maps">4.1.4.20. Initializing Maps</a></li>
<li class="toctree-l4"><a class="reference internal" href="#format-strings-outside-printf">4.1.4.21. Format Strings outside Printf</a></li>
<li class="toctree-l4"><a class="reference internal" href="#naming-printf-style-functions">4.1.4.22. Naming Printf-style Functions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#patterns">4.1.5. Patterns</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#test-tables">4.1.5.1. Test Tables</a></li>
<li class="toctree-l4"><a class="reference internal" href="#functional-options">4.1.5.2. Functional Options</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#linting">4.1.6. Linting</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#lint-runners">4.1.6.1. Lint Runners</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../uber_go_cn/index.html">4.2. Uber: Go语言 风格指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../google-python-styleguide/contents.html">4.3. Google: Python 风格指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../google-shell-styleguide/contents.html">4.4. Google: Shell 风格指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../google-typescript-styleguide/contents.html">4.5. Google: TypeScript 风格指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../google-javascript-styleguide/contents.html">4.6. Google: Javascript 风格指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../google-html-css-styleguide/contents.html">4.7. Google: HTML/CSS 风格指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../google-cpp-styleguide/contents.html">4.8. Google: C++ 风格指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../google-objc-styleguide/contents.html">4.9. Google: Objective-C 风格指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../google-java-styleguide/contents.html">4.10. Google: Java 风格指南</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../coding/index.html">5. 编程语言 语法</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cheatsheet/index.html">6. Cheat Sheet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">7. 关于</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">AI 模型国内加速</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html"><span class="section-number">4. </span>编程语言 风格指南</a></li>
      <li class="breadcrumb-item active"><span class="section-number">4.1. </span>Uber: Go Style Guide - English</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/style-guides/uber_go/uber_go_style_en.md.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <!--
  This file was generated by stitchmd. DO NOT EDIT.
  To make changes, edit the files in the "src" directory.
--><!-- markdownlint-disable MD033 --><section id="uber-go-style-guide-english">
<h1><span class="section-number">4.1. </span>Uber: Go Style Guide - English<a class="headerlink" href="#uber-go-style-guide-english" title="Permalink to this heading"></a></h1>
<ul class="simple">
<li><p><a class="reference external" href="#introduction">Introduction</a></p></li>
<li><p><a class="reference external" href="#guidelines">Guidelines</a></p>
<ul>
<li><p><a class="reference external" href="#pointers-to-interfaces">Pointers to Interfaces</a></p></li>
<li><p><a class="reference external" href="#verify-interface-compliance">Verify Interface Compliance</a></p></li>
<li><p><a class="reference external" href="#receivers-and-interfaces">Receivers and Interfaces</a></p></li>
<li><p><a class="reference external" href="#zero-value-mutexes-are-valid">Zero-value Mutexes are Valid</a></p></li>
<li><p><a class="reference external" href="#copy-slices-and-maps-at-boundaries">Copy Slices and Maps at Boundaries</a></p></li>
<li><p><a class="reference external" href="#defer-to-clean-up">Defer to Clean Up</a></p></li>
<li><p><a class="reference external" href="#channel-size-is-one-or-none">Channel Size is One or None</a></p></li>
<li><p><a class="reference external" href="#start-enums-at-one">Start Enums at One</a></p></li>
<li><p><a class="reference external" href="#use-time-to-handle-time">Use <code class="docutils literal notranslate"><span class="pre">&quot;time&quot;</span></code> to handle time</a></p></li>
<li><p><a class="reference external" href="#errors">Errors</a></p>
<ul>
<li><p><a class="reference external" href="#error-types">Error Types</a></p></li>
<li><p><a class="reference external" href="#error-wrapping">Error Wrapping</a></p></li>
<li><p><a class="reference external" href="#error-naming">Error Naming</a></p></li>
<li><p><a class="reference external" href="#handle-errors-once">Handle Errors Once</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#handle-type-assertion-failures">Handle Type Assertion Failures</a></p></li>
<li><p><a class="reference external" href="#dont-panic">Don’t Panic</a></p></li>
<li><p><a class="reference external" href="#use-gouberorgatomic">Use go.uber.org/atomic</a></p></li>
<li><p><a class="reference external" href="#avoid-mutable-globals">Avoid Mutable Globals</a></p></li>
<li><p><a class="reference external" href="#avoid-embedding-types-in-public-structs">Avoid Embedding Types in Public Structs</a></p></li>
<li><p><a class="reference external" href="#avoid-using-built-in-names">Avoid Using Built-In Names</a></p></li>
<li><p><a class="reference external" href="#avoid-init">Avoid <code class="docutils literal notranslate"><span class="pre">init()</span></code></a></p></li>
<li><p><a class="reference external" href="#exit-in-main">Exit in Main</a></p>
<ul>
<li><p><a class="reference external" href="#exit-once">Exit Once</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#use-field-tags-in-marshaled-structs">Use field tags in marshaled structs</a></p></li>
<li><p><a class="reference external" href="#dont-fire-and-forget-goroutines">Don’t fire-and-forget goroutines</a></p>
<ul>
<li><p><a class="reference external" href="#wait-for-goroutines-to-exit">Wait for goroutines to exit</a></p></li>
<li><p><a class="reference external" href="#no-goroutines-in-init">No goroutines in <code class="docutils literal notranslate"><span class="pre">init()</span></code></a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference external" href="#performance">Performance</a></p>
<ul>
<li><p><a class="reference external" href="#prefer-strconv-over-fmt">Prefer strconv over fmt</a></p></li>
<li><p><a class="reference external" href="#avoid-repeated-string-to-byte-conversions">Avoid repeated string-to-byte conversions</a></p></li>
<li><p><a class="reference external" href="#prefer-specifying-container-capacity">Prefer Specifying Container Capacity</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#style">Style</a></p>
<ul>
<li><p><a class="reference external" href="#avoid-overly-long-lines">Avoid overly long lines</a></p></li>
<li><p><a class="reference external" href="#be-consistent">Be Consistent</a></p></li>
<li><p><a class="reference external" href="#group-similar-declarations">Group Similar Declarations</a></p></li>
<li><p><a class="reference external" href="#import-group-ordering">Import Group Ordering</a></p></li>
<li><p><a class="reference external" href="#package-names">Package Names</a></p></li>
<li><p><a class="reference external" href="#function-names">Function Names</a></p></li>
<li><p><a class="reference external" href="#import-aliasing">Import Aliasing</a></p></li>
<li><p><a class="reference external" href="#function-grouping-and-ordering">Function Grouping and Ordering</a></p></li>
<li><p><a class="reference external" href="#reduce-nesting">Reduce Nesting</a></p></li>
<li><p><a class="reference external" href="#unnecessary-else">Unnecessary Else</a></p></li>
<li><p><a class="reference external" href="#top-level-variable-declarations">Top-level Variable Declarations</a></p></li>
<li><p><a class="reference external" href="#prefix-unexported-globals-with-_">Prefix Unexported Globals with _</a></p></li>
<li><p><a class="reference external" href="#embedding-in-structs">Embedding in Structs</a></p></li>
<li><p><a class="reference external" href="#local-variable-declarations">Local Variable Declarations</a></p></li>
<li><p><a class="reference external" href="#nil-is-a-valid-slice">nil is a valid slice</a></p></li>
<li><p><a class="reference external" href="#reduce-scope-of-variables">Reduce Scope of Variables</a></p></li>
<li><p><a class="reference external" href="#avoid-naked-parameters">Avoid Naked Parameters</a></p></li>
<li><p><a class="reference external" href="#use-raw-string-literals-to-avoid-escaping">Use Raw String Literals to Avoid Escaping</a></p></li>
<li><p><a class="reference external" href="#initializing-structs">Initializing Structs</a></p>
<ul>
<li><p><a class="reference external" href="#use-field-names-to-initialize-structs">Use Field Names to Initialize Structs</a></p></li>
<li><p><a class="reference external" href="#omit-zero-value-fields-in-structs">Omit Zero Value Fields in Structs</a></p></li>
<li><p><a class="reference external" href="#use-var-for-zero-value-structs">Use <code class="docutils literal notranslate"><span class="pre">var</span></code> for Zero Value Structs</a></p></li>
<li><p><a class="reference external" href="#initializing-struct-references">Initializing Struct References</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#initializing-maps">Initializing Maps</a></p></li>
<li><p><a class="reference external" href="#format-strings-outside-printf">Format Strings outside Printf</a></p></li>
<li><p><a class="reference external" href="#naming-printf-style-functions">Naming Printf-style Functions</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#patterns">Patterns</a></p>
<ul>
<li><p><a class="reference external" href="#test-tables">Test Tables</a></p></li>
<li><p><a class="reference external" href="#functional-options">Functional Options</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#linting">Linting</a></p></li>
</ul>
<section id="introduction">
<h2><span class="section-number">4.1.1. </span>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h2>
<p>Styles are the conventions that govern our code. The term style is a bit of a
misnomer, since these conventions cover far more than just source file
formatting—gofmt handles that for us.</p>
<p>The goal of this guide is to manage this complexity by describing in detail the
Dos and Don’ts of writing Go code at Uber. These rules exist to keep the code
base manageable while still allowing engineers to use Go language features
productively.</p>
<p>This guide was originally created by <a class="reference external" href="https://github.com/prashantv">Prashant Varanasi</a> and <a class="reference external" href="https://github.com/nomis52">Simon Newton</a> as
a way to bring some colleagues up to speed with using Go. Over the years it has
been amended based on feedback from others.</p>
<p>This documents idiomatic conventions in Go code that we follow at Uber. A lot
of these are general guidelines for Go, while others extend upon external
resources:</p>
<ol class="simple">
<li><p><a class="reference external" href="https://go.dev/doc/effective_go">Effective Go</a></p></li>
<li><p><a class="reference external" href="https://go.dev/wiki/CommonMistakes">Go Common Mistakes</a></p></li>
<li><p><a class="reference external" href="https://go.dev/wiki/CodeReviewComments">Go Code Review Comments</a></p></li>
</ol>
<p>We aim for the code samples to be accurate for the two most recent minor versions
of Go <a class="reference external" href="https://go.dev/doc/devel/release">releases</a>.</p>
<p>All code should be error-free when run through <code class="docutils literal notranslate"><span class="pre">golint</span></code> and <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">vet</span></code>. We
recommend setting up your editor to:</p>
<ul class="simple">
<li><p>Run <code class="docutils literal notranslate"><span class="pre">goimports</span></code> on save</p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">golint</span></code> and <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">vet</span></code> to check for errors</p></li>
</ul>
<p>You can find information in editor support for Go tools here:
https://go.dev/wiki/IDEsAndTextEditorPlugins</p>
</section>
<section id="guidelines">
<h2><span class="section-number">4.1.2. </span>Guidelines<a class="headerlink" href="#guidelines" title="Permalink to this heading"></a></h2>
<section id="pointers-to-interfaces">
<h3><span class="section-number">4.1.2.1. </span>Pointers to Interfaces<a class="headerlink" href="#pointers-to-interfaces" title="Permalink to this heading"></a></h3>
<p>You almost never need a pointer to an interface. You should be passing
interfaces as values—the underlying data can still be a pointer.</p>
<p>An interface is two fields:</p>
<ol class="simple">
<li><p>A pointer to some type-specific information. You can think of this as
“type.”</p></li>
<li><p>Data pointer. If the data stored is a pointer, it’s stored directly. If
the data stored is a value, then a pointer to the value is stored.</p></li>
</ol>
<p>If you want interface methods to modify the underlying data, you must use a
pointer.</p>
</section>
<section id="verify-interface-compliance">
<h3><span class="section-number">4.1.2.2. </span>Verify Interface Compliance<a class="headerlink" href="#verify-interface-compliance" title="Permalink to this heading"></a></h3>
<p>Verify interface compliance at compile time where appropriate. This includes:</p>
<ul class="simple">
<li><p>Exported types that are required to implement specific interfaces as part of
their API contract</p></li>
<li><p>Exported or unexported types that are part of a collection of types
implementing the same interface</p></li>
<li><p>Other cases where violating an interface would break users</p></li>
</ul>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Handler</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>



<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">h</span><span class="w"> </span><span class="o">*</span><span class="nx">Handler</span><span class="p">)</span><span class="w"> </span><span class="nx">ServeHTTP</span><span class="p">(</span>
<span class="w">  </span><span class="nx">w</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span>
<span class="w">  </span><span class="nx">r</span><span class="w"> </span><span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Handler</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>

<span class="kd">var</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">Handler</span><span class="p">)(</span><span class="kc">nil</span><span class="p">)</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">h</span><span class="w"> </span><span class="o">*</span><span class="nx">Handler</span><span class="p">)</span><span class="w"> </span><span class="nx">ServeHTTP</span><span class="p">(</span>
<span class="w">  </span><span class="nx">w</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span>
<span class="w">  </span><span class="nx">r</span><span class="w"> </span><span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>The statement <code class="docutils literal notranslate"><span class="pre">var</span> <span class="pre">_</span> <span class="pre">http.Handler</span> <span class="pre">=</span> <span class="pre">(*Handler)(nil)</span></code> will fail to compile if
<code class="docutils literal notranslate"><span class="pre">*Handler</span></code> ever stops matching the <code class="docutils literal notranslate"><span class="pre">http.Handler</span></code> interface.</p>
<p>The right hand side of the assignment should be the zero value of the asserted
type. This is <code class="docutils literal notranslate"><span class="pre">nil</span></code> for pointer types (like <code class="docutils literal notranslate"><span class="pre">*Handler</span></code>), slices, and maps, and
an empty struct for struct types.</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">LogHandler</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">h</span><span class="w">   </span><span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span>
<span class="w">  </span><span class="nx">log</span><span class="w"> </span><span class="o">*</span><span class="nx">zap</span><span class="p">.</span><span class="nx">Logger</span>
<span class="p">}</span>

<span class="kd">var</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">LogHandler</span><span class="p">{}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">h</span><span class="w"> </span><span class="nx">LogHandler</span><span class="p">)</span><span class="w"> </span><span class="nx">ServeHTTP</span><span class="p">(</span>
<span class="w">  </span><span class="nx">w</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span>
<span class="w">  </span><span class="nx">r</span><span class="w"> </span><span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="receivers-and-interfaces">
<h3><span class="section-number">4.1.2.3. </span>Receivers and Interfaces<a class="headerlink" href="#receivers-and-interfaces" title="Permalink to this heading"></a></h3>
<p>Methods with value receivers can be called on pointers as well as values.
Methods with pointer receivers can only be called on pointers or <a class="reference external" href="https://go.dev/ref/spec#Method_values">addressable values</a>.</p>
<p>For example,</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">S</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">data</span><span class="w"> </span><span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="nx">S</span><span class="p">)</span><span class="w"> </span><span class="nx">Read</span><span class="p">()</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">data</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">S</span><span class="p">)</span><span class="w"> </span><span class="nx">Write</span><span class="p">(</span><span class="nx">str</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">s</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">str</span>
<span class="p">}</span>

<span class="c1">// We cannot get pointers to values stored in maps, because they are not</span>
<span class="c1">// addressable values.</span>
<span class="nx">sVals</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="nx">S</span><span class="p">{</span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;A&quot;</span><span class="p">}}</span>

<span class="c1">// We can call Read on values stored in the map because Read</span>
<span class="c1">// has a value receiver, which does not require the value to</span>
<span class="c1">// be addressable.</span>
<span class="nx">sVals</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">Read</span><span class="p">()</span>

<span class="c1">// We cannot call Write on values stored in the map because Write</span>
<span class="c1">// has a pointer receiver, and it&#39;s not possible to get a pointer</span>
<span class="c1">// to a value stored in a map.</span>
<span class="c1">//</span>
<span class="c1">//  sVals[1].Write(&quot;test&quot;)</span>

<span class="nx">sPtrs</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="o">*</span><span class="nx">S</span><span class="p">{</span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;A&quot;</span><span class="p">}}</span>

<span class="c1">// You can call both Read and Write if the map stores pointers,</span>
<span class="c1">// because pointers are intrinsically addressable.</span>
<span class="nx">sPtrs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">Read</span><span class="p">()</span>
<span class="nx">sPtrs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">Write</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Similarly, an interface can be satisfied by a pointer, even if the method has a
value receiver.</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">F</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">f</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">S1</span><span class="w"> </span><span class="kd">struct</span><span class="p">{}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="nx">S1</span><span class="p">)</span><span class="w"> </span><span class="nx">f</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">S2</span><span class="w"> </span><span class="kd">struct</span><span class="p">{}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">S2</span><span class="p">)</span><span class="w"> </span><span class="nx">f</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>

<span class="nx">s1Val</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">S1</span><span class="p">{}</span>
<span class="nx">s1Ptr</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">S1</span><span class="p">{}</span>
<span class="nx">s2Val</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">S2</span><span class="p">{}</span>
<span class="nx">s2Ptr</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">S2</span><span class="p">{}</span>

<span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="nx">F</span>
<span class="nx">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">s1Val</span>
<span class="nx">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">s1Ptr</span>
<span class="nx">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">s2Ptr</span>

<span class="c1">// The following doesn&#39;t compile, since s2Val is a value, and there is no value receiver for f.</span>
<span class="c1">//   i = s2Val</span>
</pre></div>
</div>
<p>Effective Go has a good write up on <a class="reference external" href="https://go.dev/doc/effective_go#pointers_vs_values">Pointers vs. Values</a>.</p>
</section>
<section id="zero-value-mutexes-are-valid">
<h3><span class="section-number">4.1.2.4. </span>Zero-value Mutexes are Valid<a class="headerlink" href="#zero-value-mutexes-are-valid" title="Permalink to this heading"></a></h3>
<p>The zero-value of <code class="docutils literal notranslate"><span class="pre">sync.Mutex</span></code> and <code class="docutils literal notranslate"><span class="pre">sync.RWMutex</span></code> is valid, so you almost
never need a pointer to a mutex.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">mu</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">new</span><span class="p">(</span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span><span class="p">)</span>
<span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">mu</span><span class="w"> </span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
<span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>If you use a struct by pointer, then the mutex should be a non-pointer field on
it. Do not embed the mutex on the struct, even if the struct is not exported.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">SMap</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>

<span class="w">  </span><span class="nx">data</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">NewSMap</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="nx">SMap</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">SMap</span><span class="p">{</span>
<span class="w">    </span><span class="nx">data</span><span class="p">:</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">),</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">m</span><span class="w"> </span><span class="o">*</span><span class="nx">SMap</span><span class="p">)</span><span class="w"> </span><span class="nx">Get</span><span class="p">(</span><span class="nx">k</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">m</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">  </span><span class="k">defer</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">SMap</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">mu</span><span class="w"> </span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>

<span class="w">  </span><span class="nx">data</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">NewSMap</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="nx">SMap</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">SMap</span><span class="p">{</span>
<span class="w">    </span><span class="nx">data</span><span class="p">:</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">),</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">m</span><span class="w"> </span><span class="o">*</span><span class="nx">SMap</span><span class="p">)</span><span class="w"> </span><span class="nx">Get</span><span class="p">(</span><span class="nx">k</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">m</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">  </span><span class="k">defer</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr><tr><td><p>The <code class="docutils literal notranslate"><span class="pre">Mutex</span></code> field, and the <code class="docutils literal notranslate"><span class="pre">Lock</span></code> and <code class="docutils literal notranslate"><span class="pre">Unlock</span></code> methods are unintentionally part
of the exported API of <code class="docutils literal notranslate"><span class="pre">SMap</span></code>.</p>
</td><td><p>The mutex and its methods are implementation details of <code class="docutils literal notranslate"><span class="pre">SMap</span></code> hidden from its
callers.</p>
</td></tr>
</tbody></table></section>
<section id="copy-slices-and-maps-at-boundaries">
<h3><span class="section-number">4.1.2.5. </span>Copy Slices and Maps at Boundaries<a class="headerlink" href="#copy-slices-and-maps-at-boundaries" title="Permalink to this heading"></a></h3>
<p>Slices and maps contain pointers to the underlying data so be wary of scenarios
when they need to be copied.</p>
<section id="receiving-slices-and-maps">
<h4><span class="section-number">4.1.2.5.1. </span>Receiving Slices and Maps<a class="headerlink" href="#receiving-slices-and-maps" title="Permalink to this heading"></a></h4>
<p>Keep in mind that users can modify a map or slice you received as an argument
if you store a reference to it.</p>
<table>
<thead><tr><th>Bad</th> <th>Good</th></tr></thead>
<tbody>
<tr>
<td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">d</span><span class="w"> </span><span class="o">*</span><span class="nx">Driver</span><span class="p">)</span><span class="w"> </span><span class="nx">SetTrips</span><span class="p">(</span><span class="nx">trips</span><span class="w"> </span><span class="p">[]</span><span class="nx">Trip</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">d</span><span class="p">.</span><span class="nx">trips</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">trips</span>
<span class="p">}</span>

<span class="nx">trips</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">...</span>
<span class="nx">d1</span><span class="p">.</span><span class="nx">SetTrips</span><span class="p">(</span><span class="nx">trips</span><span class="p">)</span>

<span class="c1">// Did you mean to modify d1.trips?</span>
<span class="nx">trips</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">...</span>
</pre></div>
</div>
</td>
<td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">d</span><span class="w"> </span><span class="o">*</span><span class="nx">Driver</span><span class="p">)</span><span class="w"> </span><span class="nx">SetTrips</span><span class="p">(</span><span class="nx">trips</span><span class="w"> </span><span class="p">[]</span><span class="nx">Trip</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">d</span><span class="p">.</span><span class="nx">trips</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">make</span><span class="p">([]</span><span class="nx">Trip</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">trips</span><span class="p">))</span>
<span class="w">  </span><span class="nb">copy</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">trips</span><span class="p">,</span><span class="w"> </span><span class="nx">trips</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">trips</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">...</span>
<span class="nx">d1</span><span class="p">.</span><span class="nx">SetTrips</span><span class="p">(</span><span class="nx">trips</span><span class="p">)</span>

<span class="c1">// We can now modify trips[0] without affecting d1.trips.</span>
<span class="nx">trips</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">...</span>
</pre></div>
</div>
</td>
</tr></tbody>
</table></section>
<section id="returning-slices-and-maps">
<h4><span class="section-number">4.1.2.5.2. </span>Returning Slices and Maps<a class="headerlink" href="#returning-slices-and-maps" title="Permalink to this heading"></a></h4>
<p>Similarly, be wary of user modifications to maps or slices exposing internal
state.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Stats</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">mu</span><span class="w"> </span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
<span class="w">  </span><span class="nx">counters</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span>
<span class="p">}</span>

<span class="c1">// Snapshot returns the current stats.</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Stats</span><span class="p">)</span><span class="w"> </span><span class="nx">Snapshot</span><span class="p">()</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">  </span><span class="k">defer</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">counters</span>
<span class="p">}</span>

<span class="c1">// snapshot is no longer protected by the mutex, so any</span>
<span class="c1">// access to the snapshot is subject to data races.</span>
<span class="nx">snapshot</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">stats</span><span class="p">.</span><span class="nx">Snapshot</span><span class="p">()</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Stats</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">mu</span><span class="w"> </span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
<span class="w">  </span><span class="nx">counters</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Stats</span><span class="p">)</span><span class="w"> </span><span class="nx">Snapshot</span><span class="p">()</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">  </span><span class="k">defer</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>

<span class="w">  </span><span class="nx">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">counters</span><span class="p">))</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="nx">k</span><span class="p">,</span><span class="w"> </span><span class="nx">v</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">counters</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">result</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">v</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span>
<span class="p">}</span>

<span class="c1">// Snapshot is now a copy.</span>
<span class="nx">snapshot</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">stats</span><span class="p">.</span><span class="nx">Snapshot</span><span class="p">()</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
</section>
<section id="defer-to-clean-up">
<h3><span class="section-number">4.1.2.6. </span>Defer to Clean Up<a class="headerlink" href="#defer-to-clean-up" title="Permalink to this heading"></a></h3>
<p>Use defer to clean up resources such as files and locks.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">p</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="k">if</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">count</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">p</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">count</span>
<span class="p">}</span>

<span class="nx">p</span><span class="p">.</span><span class="nx">count</span><span class="o">++</span>
<span class="nx">newCount</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">count</span>
<span class="nx">p</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>

<span class="k">return</span><span class="w"> </span><span class="nx">newCount</span>

<span class="c1">// easy to miss unlocks due to multiple returns</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">p</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="k">defer</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>

<span class="k">if</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">count</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">count</span>
<span class="p">}</span>

<span class="nx">p</span><span class="p">.</span><span class="nx">count</span><span class="o">++</span>
<span class="k">return</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">count</span>

<span class="c1">// more readable</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>Defer has an extremely small overhead and should be avoided only if you can
prove that your function execution time is in the order of nanoseconds. The
readability win of using defers is worth the miniscule cost of using them. This
is especially true for larger methods that have more than simple memory
accesses, where the other computations are more significant than the <code class="docutils literal notranslate"><span class="pre">defer</span></code>.</p>
</section>
<section id="channel-size-is-one-or-none">
<h3><span class="section-number">4.1.2.7. </span>Channel Size is One or None<a class="headerlink" href="#channel-size-is-one-or-none" title="Permalink to this heading"></a></h3>
<p>Channels should usually have a size of one or be unbuffered. By default,
channels are unbuffered and have a size of zero. Any other size
must be subject to a high level of scrutiny. Consider how the size is
determined, what prevents the channel from filling up under load and blocking
writers, and what happens when this occurs.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// Ought to be enough for anybody!</span>
<span class="nx">c</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">)</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// Size of one</span>
<span class="nx">c</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c1">// or</span>
<span class="c1">// Unbuffered channel, size of zero</span>
<span class="nx">c</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
<section id="start-enums-at-one">
<h3><span class="section-number">4.1.2.8. </span>Start Enums at One<a class="headerlink" href="#start-enums-at-one" title="Permalink to this heading"></a></h3>
<p>The standard way of introducing enumerations in Go is to declare a custom type
and a <code class="docutils literal notranslate"><span class="pre">const</span></code> group with <code class="docutils literal notranslate"><span class="pre">iota</span></code>. Since variables have a 0 default value, you
should usually start your enums on a non-zero value.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Operation</span><span class="w"> </span><span class="kt">int</span>

<span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="nx">Add</span><span class="w"> </span><span class="nx">Operation</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">iota</span>
<span class="w">  </span><span class="nx">Subtract</span>
<span class="w">  </span><span class="nx">Multiply</span>
<span class="p">)</span>

<span class="c1">// Add=0, Subtract=1, Multiply=2</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Operation</span><span class="w"> </span><span class="kt">int</span>

<span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="nx">Add</span><span class="w"> </span><span class="nx">Operation</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">iota</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="nx">Subtract</span>
<span class="w">  </span><span class="nx">Multiply</span>
<span class="p">)</span>

<span class="c1">// Add=1, Subtract=2, Multiply=3</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>There are cases where using the zero value makes sense, for example when the
zero value case is the desirable default behavior.</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">LogOutput</span><span class="w"> </span><span class="kt">int</span>

<span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="nx">LogToStdout</span><span class="w"> </span><span class="nx">LogOutput</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">iota</span>
<span class="w">  </span><span class="nx">LogToFile</span>
<span class="w">  </span><span class="nx">LogToRemote</span>
<span class="p">)</span>

<span class="c1">// LogToStdout=0, LogToFile=1, LogToRemote=2</span>
</pre></div>
</div>
<!-- TODO: section on String methods for enums --></section>
<section id="use-time-to-handle-time">
<h3><span class="section-number">4.1.2.9. </span>Use <code class="docutils literal notranslate"><span class="pre">&quot;time&quot;</span></code> to handle time<a class="headerlink" href="#use-time-to-handle-time" title="Permalink to this heading"></a></h3>
<p>Time is complicated. Incorrect assumptions often made about time include the
following.</p>
<ol class="simple">
<li><p>A day has 24 hours</p></li>
<li><p>An hour has 60 minutes</p></li>
<li><p>A week has 7 days</p></li>
<li><p>A year has 365 days</p></li>
<li><p><a class="reference external" href="https://infiniteundo.com/post/25326999628/falsehoods-programmers-believe-about-time">And a lot more</a></p></li>
</ol>
<p>For example, <em>1</em> means that adding 24 hours to a time instant will not always
yield a new calendar day.</p>
<p>Therefore, always use the <a class="reference external" href="https://pkg.go.dev/time"><code class="docutils literal notranslate"><span class="pre">&quot;time&quot;</span></code></a> package when dealing with time because it
helps deal with these incorrect assumptions in a safer, more accurate manner.</p>
<section id="use-time-time-for-instants-of-time">
<h4><span class="section-number">4.1.2.9.1. </span>Use <code class="docutils literal notranslate"><span class="pre">time.Time</span></code> for instants of time<a class="headerlink" href="#use-time-time-for-instants-of-time" title="Permalink to this heading"></a></h4>
<p>Use <a class="reference external" href="https://pkg.go.dev/time#Time"><code class="docutils literal notranslate"><span class="pre">time.Time</span></code></a> when dealing with instants of time, and the methods on
<code class="docutils literal notranslate"><span class="pre">time.Time</span></code> when comparing, adding, or subtracting time.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">isActive</span><span class="p">(</span><span class="nx">now</span><span class="p">,</span><span class="w"> </span><span class="nx">start</span><span class="p">,</span><span class="w"> </span><span class="nx">stop</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">now</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">now</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">stop</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">isActive</span><span class="p">(</span><span class="nx">now</span><span class="p">,</span><span class="w"> </span><span class="nx">start</span><span class="p">,</span><span class="w"> </span><span class="nx">stop</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">)</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="nx">start</span><span class="p">.</span><span class="nx">Before</span><span class="p">(</span><span class="nx">now</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">start</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">now</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">now</span><span class="p">.</span><span class="nx">Before</span><span class="p">(</span><span class="nx">stop</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
<section id="use-time-duration-for-periods-of-time">
<h4><span class="section-number">4.1.2.9.2. </span>Use <code class="docutils literal notranslate"><span class="pre">time.Duration</span></code> for periods of time<a class="headerlink" href="#use-time-duration-for-periods-of-time" title="Permalink to this heading"></a></h4>
<p>Use <a class="reference external" href="https://pkg.go.dev/time#Duration"><code class="docutils literal notranslate"><span class="pre">time.Duration</span></code></a> when dealing with periods of time.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">poll</span><span class="p">(</span><span class="nx">delay</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">(</span><span class="nx">delay</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">poll</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="c1">// was it seconds or milliseconds?</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">poll</span><span class="p">(</span><span class="nx">delay</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="nx">delay</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">poll</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>Going back to the example of adding 24 hours to a time instant, the method we
use to add time depends on intent. If we want the same time of the day, but on
the next calendar day, we should use <a class="reference external" href="https://pkg.go.dev/time#Time.AddDate"><code class="docutils literal notranslate"><span class="pre">Time.AddDate</span></code></a>. However, if we want an
instant of time guaranteed to be 24 hours after the previous time, we should
use <a class="reference external" href="https://pkg.go.dev/time#Time.Add"><code class="docutils literal notranslate"><span class="pre">Time.Add</span></code></a>.</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">newDay</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">AddDate</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="cm">/* years */</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="cm">/* months */</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="cm">/* days */</span><span class="p">)</span>
<span class="nx">maybeNewDay</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="mi">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Hour</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="use-time-time-and-time-duration-with-external-systems">
<h4><span class="section-number">4.1.2.9.3. </span>Use <code class="docutils literal notranslate"><span class="pre">time.Time</span></code> and <code class="docutils literal notranslate"><span class="pre">time.Duration</span></code> with external systems<a class="headerlink" href="#use-time-time-and-time-duration-with-external-systems" title="Permalink to this heading"></a></h4>
<p>Use <code class="docutils literal notranslate"><span class="pre">time.Duration</span></code> and <code class="docutils literal notranslate"><span class="pre">time.Time</span></code> in interactions with external systems when
possible. For example:</p>
<ul class="simple">
<li><p>Command-line flags: <a class="reference external" href="https://pkg.go.dev/flag"><code class="docutils literal notranslate"><span class="pre">flag</span></code></a> supports <code class="docutils literal notranslate"><span class="pre">time.Duration</span></code> via
<a class="reference external" href="https://pkg.go.dev/time#ParseDuration"><code class="docutils literal notranslate"><span class="pre">time.ParseDuration</span></code></a></p></li>
<li><p>JSON: <a class="reference external" href="https://pkg.go.dev/encoding/json"><code class="docutils literal notranslate"><span class="pre">encoding/json</span></code></a> supports encoding <code class="docutils literal notranslate"><span class="pre">time.Time</span></code> as an <a class="reference external" href="https://tools.ietf.org/html/rfc3339">RFC 3339</a>
string via its <a class="reference external" href="https://pkg.go.dev/time#Time.UnmarshalJSON"><code class="docutils literal notranslate"><span class="pre">UnmarshalJSON</span></code> method</a></p></li>
<li><p>SQL: <a class="reference external" href="https://pkg.go.dev/database/sql"><code class="docutils literal notranslate"><span class="pre">database/sql</span></code></a> supports converting <code class="docutils literal notranslate"><span class="pre">DATETIME</span></code> or <code class="docutils literal notranslate"><span class="pre">TIMESTAMP</span></code> columns
into <code class="docutils literal notranslate"><span class="pre">time.Time</span></code> and back if the underlying driver supports it</p></li>
<li><p>YAML: <a class="reference external" href="https://pkg.go.dev/gopkg.in/yaml.v2"><code class="docutils literal notranslate"><span class="pre">gopkg.in/yaml.v2</span></code></a> supports <code class="docutils literal notranslate"><span class="pre">time.Time</span></code> as an <a class="reference external" href="https://tools.ietf.org/html/rfc3339">RFC 3339</a> string, and
<code class="docutils literal notranslate"><span class="pre">time.Duration</span></code> via <a class="reference external" href="https://pkg.go.dev/time#ParseDuration"><code class="docutils literal notranslate"><span class="pre">time.ParseDuration</span></code></a>.</p></li>
</ul>
<p>When it is not possible to use <code class="docutils literal notranslate"><span class="pre">time.Duration</span></code> in these interactions, use
<code class="docutils literal notranslate"><span class="pre">int</span></code> or <code class="docutils literal notranslate"><span class="pre">float64</span></code> and include the unit in the name of the field.</p>
<p>For example, since <code class="docutils literal notranslate"><span class="pre">encoding/json</span></code> does not support <code class="docutils literal notranslate"><span class="pre">time.Duration</span></code>, the unit
is included in the name of the field.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// {&quot;interval&quot;: 2}</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">Interval</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="s">`json:&quot;interval&quot;`</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// {&quot;intervalMillis&quot;: 2000}</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">IntervalMillis</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="s">`json:&quot;intervalMillis&quot;`</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>When it is not possible to use <code class="docutils literal notranslate"><span class="pre">time.Time</span></code> in these interactions, unless an
alternative is agreed upon, use <code class="docutils literal notranslate"><span class="pre">string</span></code> and format timestamps as defined in
<a class="reference external" href="https://tools.ietf.org/html/rfc3339">RFC 3339</a>. This format is used by default by <a class="reference external" href="https://pkg.go.dev/time#Time.UnmarshalText"><code class="docutils literal notranslate"><span class="pre">Time.UnmarshalText</span></code></a> and is
available for use in <code class="docutils literal notranslate"><span class="pre">Time.Format</span></code> and <code class="docutils literal notranslate"><span class="pre">time.Parse</span></code> via <a class="reference external" href="https://pkg.go.dev/time#RFC3339"><code class="docutils literal notranslate"><span class="pre">time.RFC3339</span></code></a>.</p>
<p>Although this tends to not be a problem in practice, keep in mind that the
<code class="docutils literal notranslate"><span class="pre">&quot;time&quot;</span></code> package does not support parsing timestamps with leap seconds
(<a class="reference external" href="https://github.com/golang/go/issues/8728">8728</a>), nor does it account for leap seconds in calculations (<a class="reference external" href="https://github.com/golang/go/issues/15190">15190</a>). If
you compare two instants of time, the difference will not include the leap
seconds that may have occurred between those two instants.</p>
</section>
</section>
<section id="errors">
<h3><span class="section-number">4.1.2.10. </span>Errors<a class="headerlink" href="#errors" title="Permalink to this heading"></a></h3>
<section id="error-types">
<h4><span class="section-number">4.1.2.10.1. </span>Error Types<a class="headerlink" href="#error-types" title="Permalink to this heading"></a></h4>
<p>There are few options for declaring errors.
Consider the following before picking the option best suited for your use case.</p>
<ul class="simple">
<li><p>Does the caller need to match the error so that they can handle it?
If yes, we must support the <a class="reference external" href="https://pkg.go.dev/errors#Is"><code class="docutils literal notranslate"><span class="pre">errors.Is</span></code></a> or <a class="reference external" href="https://pkg.go.dev/errors#As"><code class="docutils literal notranslate"><span class="pre">errors.As</span></code></a> functions
by declaring a top-level error variable or a custom type.</p></li>
<li><p>Is the error message a static string,
or is it a dynamic string that requires contextual information?
For the former, we can use <a class="reference external" href="https://pkg.go.dev/errors#New"><code class="docutils literal notranslate"><span class="pre">errors.New</span></code></a>, but for the latter we must
use <a class="reference external" href="https://pkg.go.dev/fmt#Errorf"><code class="docutils literal notranslate"><span class="pre">fmt.Errorf</span></code></a> or a custom error type.</p></li>
<li><p>Are we propagating a new error returned by a downstream function?
If so, see the <a class="reference external" href="#error-wrapping">section on error wrapping</a>.</p></li>
</ul>
<table border="1" class="docutils">
<thead>
<tr>
<th>Error matching?</th>
<th>Error Message</th>
<th>Guidance</th>
</tr>
</thead>
<tbody>
<tr>
<td>No</td>
<td>static</td>
<td><a href="https://pkg.go.dev/errors#New"><code>errors.New</code></a></td>
</tr>
<tr>
<td>No</td>
<td>dynamic</td>
<td><a href="https://pkg.go.dev/fmt#Errorf"><code>fmt.Errorf</code></a></td>
</tr>
<tr>
<td>Yes</td>
<td>static</td>
<td>top-level <code>var</code> with <a href="https://pkg.go.dev/errors#New"><code>errors.New</code></a></td>
</tr>
<tr>
<td>Yes</td>
<td>dynamic</td>
<td>custom <code>error</code> type</td>
</tr>
</tbody>
</table><p>For example,
use <a class="reference external" href="https://pkg.go.dev/errors#New"><code class="docutils literal notranslate"><span class="pre">errors.New</span></code></a> for an error with a static string.
Export this error as a variable to support matching it with <code class="docutils literal notranslate"><span class="pre">errors.Is</span></code>
if the caller needs to match and handle this error.</p>
<table>
<thead><tr><th>No error matching</th><th>Error matching</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// package foo</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">Open</span><span class="p">()</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;could not open&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// package bar</span>

<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">foo</span><span class="p">.</span><span class="nx">Open</span><span class="p">();</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Can&#39;t handle the error.</span>
<span class="w">  </span><span class="nb">panic</span><span class="p">(</span><span class="s">&quot;unknown error&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// package foo</span>

<span class="kd">var</span><span class="w"> </span><span class="nx">ErrCouldNotOpen</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;could not open&quot;</span><span class="p">)</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">Open</span><span class="p">()</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">ErrCouldNotOpen</span>
<span class="p">}</span>

<span class="c1">// package bar</span>

<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">foo</span><span class="p">.</span><span class="nx">Open</span><span class="p">();</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">foo</span><span class="p">.</span><span class="nx">ErrCouldNotOpen</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// handle the error</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">panic</span><span class="p">(</span><span class="s">&quot;unknown error&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>For an error with a dynamic string,
use <a class="reference external" href="https://pkg.go.dev/fmt#Errorf"><code class="docutils literal notranslate"><span class="pre">fmt.Errorf</span></code></a> if the caller does not need to match it,
and a custom <code class="docutils literal notranslate"><span class="pre">error</span></code> if the caller does need to match it.</p>
<table>
<thead><tr><th>No error matching</th><th>Error matching</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// package foo</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">Open</span><span class="p">(</span><span class="nx">file</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;file %q not found&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// package bar</span>

<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">foo</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="s">&quot;testfile.txt&quot;</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Can&#39;t handle the error.</span>
<span class="w">  </span><span class="nb">panic</span><span class="p">(</span><span class="s">&quot;unknown error&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// package foo</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">NotFoundError</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">File</span><span class="w"> </span><span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="o">*</span><span class="nx">NotFoundError</span><span class="p">)</span><span class="w"> </span><span class="nx">Error</span><span class="p">()</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;file %q not found&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">File</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">Open</span><span class="p">(</span><span class="nx">file</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">NotFoundError</span><span class="p">{</span><span class="nx">File</span><span class="p">:</span><span class="w"> </span><span class="nx">file</span><span class="p">}</span>
<span class="p">}</span>


<span class="c1">// package bar</span>

<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">foo</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="s">&quot;testfile.txt&quot;</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">notFound</span><span class="w"> </span><span class="o">*</span><span class="nx">NotFoundError</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">As</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">notFound</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// handle the error</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">panic</span><span class="p">(</span><span class="s">&quot;unknown error&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>Note that if you export error variables or types from a package,
they will become part of the public API of the package.</p>
</section>
<section id="error-wrapping">
<h4><span class="section-number">4.1.2.10.2. </span>Error Wrapping<a class="headerlink" href="#error-wrapping" title="Permalink to this heading"></a></h4>
<p>There are three main options for propagating errors if a call fails:</p>
<ul class="simple">
<li><p>return the original error as-is</p></li>
<li><p>add context with <code class="docutils literal notranslate"><span class="pre">fmt.Errorf</span></code> and the <code class="docutils literal notranslate"><span class="pre">%w</span></code> verb</p></li>
<li><p>add context with <code class="docutils literal notranslate"><span class="pre">fmt.Errorf</span></code> and the <code class="docutils literal notranslate"><span class="pre">%v</span></code> verb</p></li>
</ul>
<p>Return the original error as-is if there is no additional context to add.
This maintains the original error type and message.
This is well suited for cases when the underlying error message
has sufficient information to track down where it came from.</p>
<p>Otherwise, add context to the error message where possible
so that instead of a vague error such as “connection refused”,
you get more useful errors such as “call service foo: connection refused”.</p>
<p>Use <code class="docutils literal notranslate"><span class="pre">fmt.Errorf</span></code> to add context to your errors,
picking between the <code class="docutils literal notranslate"><span class="pre">%w</span></code> or <code class="docutils literal notranslate"><span class="pre">%v</span></code> verbs
based on whether the caller should be able to
match and extract the underlying cause.</p>
<ul class="simple">
<li><p>Use <code class="docutils literal notranslate"><span class="pre">%w</span></code> if the caller should have access to the underlying error.
This is a good default for most wrapped errors,
but be aware that callers may begin to rely on this behavior.
So for cases where the wrapped error is a known <code class="docutils literal notranslate"><span class="pre">var</span></code> or type,
document and test it as part of your function’s contract.</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">%v</span></code> to obfuscate the underlying error.
Callers will be unable to match it,
but you can switch to <code class="docutils literal notranslate"><span class="pre">%w</span></code> in the future if needed.</p></li>
</ul>
<p>When adding context to returned errors, keep the context succinct by avoiding
phrases like “failed to”, which state the obvious and pile up as the error
percolates up through the stack:</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">s</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">store</span><span class="p">.</span><span class="nx">New</span><span class="p">()</span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span>
<span class="w">        </span><span class="s">&quot;failed to create new store: %w&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">s</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">store</span><span class="p">.</span><span class="nx">New</span><span class="p">()</span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span>
<span class="w">        </span><span class="s">&quot;new store: %w&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr><tr><td><div class="highlight-plain notranslate"><div class="highlight"><pre><span></span>failed to x: failed to y: failed to create new store: the error
</pre></div>
</div>
</td><td><div class="highlight-plain notranslate"><div class="highlight"><pre><span></span>x: y: new store: the error
</pre></div>
</div>
</td></tr>
</tbody></table><p>However once the error is sent to another system, it should be clear the
message is an error (e.g. an <code class="docutils literal notranslate"><span class="pre">err</span></code> tag or “Failed” prefix in logs).</p>
<p>See also <a class="reference external" href="https://dave.cheney.net/2016/04/27/dont-just-check-errors-handle-them-gracefully">Don’t just check errors, handle them gracefully</a>.</p>
</section>
<section id="error-naming">
<h4><span class="section-number">4.1.2.10.3. </span>Error Naming<a class="headerlink" href="#error-naming" title="Permalink to this heading"></a></h4>
<p>For error values stored as global variables,
use the prefix <code class="docutils literal notranslate"><span class="pre">Err</span></code> or <code class="docutils literal notranslate"><span class="pre">err</span></code> depending on whether they’re exported.
This guidance supersedes the <a class="reference external" href="#prefix-unexported-globals-with-_">Prefix Unexported Globals with _</a>.</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="c1">// The following two errors are exported</span>
<span class="w">  </span><span class="c1">// so that users of this package can match them</span>
<span class="w">  </span><span class="c1">// with errors.Is.</span>

<span class="w">  </span><span class="nx">ErrBrokenLink</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;link is broken&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="nx">ErrCouldNotOpen</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;could not open&quot;</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// This error is not exported because</span>
<span class="w">  </span><span class="c1">// we don&#39;t want to make it part of our public API.</span>
<span class="w">  </span><span class="c1">// We may still use it inside the package</span>
<span class="w">  </span><span class="c1">// with errors.Is.</span>

<span class="w">  </span><span class="nx">errNotFound</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;not found&quot;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>For custom error types, use the suffix <code class="docutils literal notranslate"><span class="pre">Error</span></code> instead.</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// Similarly, this error is exported</span>
<span class="c1">// so that users of this package can match it</span>
<span class="c1">// with errors.As.</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">NotFoundError</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">File</span><span class="w"> </span><span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="o">*</span><span class="nx">NotFoundError</span><span class="p">)</span><span class="w"> </span><span class="nx">Error</span><span class="p">()</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;file %q not found&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">File</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// And this error is not exported because</span>
<span class="c1">// we don&#39;t want to make it part of the public API.</span>
<span class="c1">// We can still use it inside the package</span>
<span class="c1">// with errors.As.</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">resolveError</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">Path</span><span class="w"> </span><span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="o">*</span><span class="nx">resolveError</span><span class="p">)</span><span class="w"> </span><span class="nx">Error</span><span class="p">()</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;resolve %q&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">Path</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="handle-errors-once">
<h4><span class="section-number">4.1.2.10.4. </span>Handle Errors Once<a class="headerlink" href="#handle-errors-once" title="Permalink to this heading"></a></h4>
<p>When a caller receives an error from a callee,
it can handle it in a variety of different ways
depending on what it knows about the error.</p>
<p>These include, but not are limited to:</p>
<ul class="simple">
<li><p>if the callee contract defines specific errors,
matching the error with <code class="docutils literal notranslate"><span class="pre">errors.Is</span></code> or <code class="docutils literal notranslate"><span class="pre">errors.As</span></code>
and handling the branches differently</p></li>
<li><p>if the error is recoverable,
logging the error and degrading gracefully</p></li>
<li><p>if the error represents a domain-specific failure condition,
returning a well-defined error</p></li>
<li><p>returning the error, either <a class="reference external" href="#error-wrapping">wrapped</a> or verbatim</p></li>
</ul>
<p>Regardless of how the caller handles the error,
it should typically handle each error only once.
The caller should not, for example, log the error and then return it,
because <em>its</em> callers may handle the error as well.</p>
<p>For example, consider the following cases:</p>
<table>
<thead><tr><th>Description</th><th>Code</th></tr></thead>
<tbody>
<tr><td><p><strong>Bad</strong>: Log the error and return it</p>
<p>Callers further up the stack will likely take a similar action with the error.
Doing so causing a lot of noise in the application logs for little value.</p>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">u</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">getUser</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// BAD: See description</span>
<span class="w">  </span><span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Could not get user %q: %v&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
<tr><td><p><strong>Good</strong>: Wrap the error and return it</p>
<p>Callers further up the stack will handle the error.
Use of <code class="docutils literal notranslate"><span class="pre">%w</span></code> ensures they can match the error with <code class="docutils literal notranslate"><span class="pre">errors.Is</span></code> or <code class="docutils literal notranslate"><span class="pre">errors.As</span></code>
if relevant.</p>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">u</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">getUser</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;get user %q: %w&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
<tr><td><p><strong>Good</strong>: Log the error and degrade gracefully</p>
<p>If the operation isn’t strictly necessary,
we can provide a degraded but unbroken experience
by recovering from it.</p>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">emitMetrics</span><span class="p">();</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Failure to write metrics should not</span>
<span class="w">  </span><span class="c1">// break the application.</span>
<span class="w">  </span><span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Could not emit metrics: %v&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
<tr><td><p><strong>Good</strong>: Match the error and degrade gracefully</p>
<p>If the callee defines a specific error in its contract,
and the failure is recoverable,
match on that error case and degrade gracefully.
For all other cases, wrap the error and return it.</p>
<p>Callers further up the stack will handle other errors.</p>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">tz</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">getUserTimeZone</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">ErrUserNotFound</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// User doesn&#39;t exist. Use UTC.</span>
<span class="w">    </span><span class="nx">tz</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">UTC</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;get user %q: %w&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
</section>
<section id="handle-type-assertion-failures">
<h3><span class="section-number">4.1.2.11. </span>Handle Type Assertion Failures<a class="headerlink" href="#handle-type-assertion-failures" title="Permalink to this heading"></a></h3>
<p>The single return value form of a <a class="reference external" href="https://go.dev/ref/spec#Type_assertions">type assertion</a> will panic on an incorrect
type. Therefore, always use the “comma ok” idiom.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">t</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">i</span><span class="p">.(</span><span class="kt">string</span><span class="p">)</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">i</span><span class="p">.(</span><span class="kt">string</span><span class="p">)</span>
<span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// handle the error gracefully</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><!-- TODO: There are a few situations where the single assignment form is
fine. --></section>
<section id="don-t-panic">
<h3><span class="section-number">4.1.2.12. </span>Don’t Panic<a class="headerlink" href="#don-t-panic" title="Permalink to this heading"></a></h3>
<p>Code running in production must avoid panics. Panics are a major source of
<a class="reference external" href="https://en.wikipedia.org/wiki/Cascading_failure">cascading failures</a>. If an error occurs, the function must return an error and
allow the caller to decide how to handle it.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">run</span><span class="p">(</span><span class="nx">args</span><span class="w"> </span><span class="p">[]</span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">panic</span><span class="p">(</span><span class="s">&quot;an argument is required&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">run</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">run</span><span class="p">(</span><span class="nx">args</span><span class="w"> </span><span class="p">[]</span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;an argument is required&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">run</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintln</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="nx">os</span><span class="p">.</span><span class="nx">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>Panic/recover is not an error handling strategy. A program must panic only when
something irrecoverable happens such as a nil dereference. An exception to this is
program initialization: bad things at program startup that should abort the
program may cause panic.</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">_statusTemplate</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">template</span><span class="p">.</span><span class="nx">Must</span><span class="p">(</span><span class="nx">template</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">).</span><span class="nx">Parse</span><span class="p">(</span><span class="s">&quot;_statusHTML&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>Even in tests, prefer <code class="docutils literal notranslate"><span class="pre">t.Fatal</span></code> or <code class="docutils literal notranslate"><span class="pre">t.FailNow</span></code> over panics to ensure that the
test is marked as failed.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// func TestFoo(t *testing.T)</span>

<span class="nx">f</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">CreateTemp</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;test&quot;</span><span class="p">)</span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nb">panic</span><span class="p">(</span><span class="s">&quot;failed to set up test&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// func TestFoo(t *testing.T)</span>

<span class="nx">f</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">CreateTemp</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;test&quot;</span><span class="p">)</span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">t</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">&quot;failed to set up test&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
<section id="use-go-uber-org-atomic">
<h3><span class="section-number">4.1.2.13. </span>Use go.uber.org/atomic<a class="headerlink" href="#use-go-uber-org-atomic" title="Permalink to this heading"></a></h3>
<p>Atomic operations with the <a class="reference external" href="https://pkg.go.dev/sync/atomic">sync/atomic</a> package operate on the raw types
(<code class="docutils literal notranslate"><span class="pre">int32</span></code>, <code class="docutils literal notranslate"><span class="pre">int64</span></code>, etc.) so it is easy to forget to use the atomic operation to
read or modify the variables.</p>
<p><a class="reference external" href="https://pkg.go.dev/go.uber.org/atomic">go.uber.org/atomic</a> adds type safety to these operations by hiding the
underlying type. Additionally, it includes a convenient <code class="docutils literal notranslate"><span class="pre">atomic.Bool</span></code> type.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">foo</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">running</span><span class="w"> </span><span class="kt">int32</span><span class="w">  </span><span class="c1">// atomic</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">f</span><span class="o">*</span><span class="w"> </span><span class="nx">foo</span><span class="p">)</span><span class="w"> </span><span class="nx">start</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">atomic</span><span class="p">.</span><span class="nx">SwapInt32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">f</span><span class="p">.</span><span class="nx">running</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="c1">// already running…</span>
<span class="w">     </span><span class="k">return</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// start the Foo</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">f</span><span class="w"> </span><span class="o">*</span><span class="nx">foo</span><span class="p">)</span><span class="w"> </span><span class="nx">isRunning</span><span class="p">()</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">running</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="c1">// race!</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">foo</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">running</span><span class="w"> </span><span class="nx">atomic</span><span class="p">.</span><span class="nx">Bool</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">f</span><span class="w"> </span><span class="o">*</span><span class="nx">foo</span><span class="p">)</span><span class="w"> </span><span class="nx">start</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">running</span><span class="p">.</span><span class="nx">Swap</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="c1">// already running…</span>
<span class="w">     </span><span class="k">return</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// start the Foo</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">f</span><span class="w"> </span><span class="o">*</span><span class="nx">foo</span><span class="p">)</span><span class="w"> </span><span class="nx">isRunning</span><span class="p">()</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">running</span><span class="p">.</span><span class="nx">Load</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
<section id="avoid-mutable-globals">
<h3><span class="section-number">4.1.2.14. </span>Avoid Mutable Globals<a class="headerlink" href="#avoid-mutable-globals" title="Permalink to this heading"></a></h3>
<p>Avoid mutating global variables, instead opting for dependency injection.
This applies to function pointers as well as other kinds of values.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// sign.go</span>

<span class="kd">var</span><span class="w"> </span><span class="nx">_timeNow</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">sign</span><span class="p">(</span><span class="nx">msg</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">now</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">_timeNow</span><span class="p">()</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">signWithTime</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span><span class="w"> </span><span class="nx">now</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// sign.go</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">signer</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">now</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">newSigner</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="nx">signer</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">signer</span><span class="p">{</span>
<span class="w">    </span><span class="nx">now</span><span class="p">:</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">,</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">signer</span><span class="p">)</span><span class="w"> </span><span class="nx">Sign</span><span class="p">(</span><span class="nx">msg</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">now</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">signWithTime</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span><span class="w"> </span><span class="nx">now</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// sign_test.go</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">TestSign</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">oldTimeNow</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">_timeNow</span>
<span class="w">  </span><span class="nx">_timeNow</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">someFixedTime</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">defer</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">_timeNow</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">oldTimeNow</span><span class="w"> </span><span class="p">}()</span>

<span class="w">  </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">want</span><span class="p">,</span><span class="w"> </span><span class="nx">sign</span><span class="p">(</span><span class="nx">give</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// sign_test.go</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">TestSigner</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">s</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">newSigner</span><span class="p">()</span>
<span class="w">  </span><span class="nx">s</span><span class="p">.</span><span class="nx">now</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">someFixedTime</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">want</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">Sign</span><span class="p">(</span><span class="nx">give</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
<section id="avoid-embedding-types-in-public-structs">
<h3><span class="section-number">4.1.2.15. </span>Avoid Embedding Types in Public Structs<a class="headerlink" href="#avoid-embedding-types-in-public-structs" title="Permalink to this heading"></a></h3>
<p>These embedded types leak implementation details, inhibit type evolution, and
obscure documentation.</p>
<p>Assuming you have implemented a variety of list types using a shared
<code class="docutils literal notranslate"><span class="pre">AbstractList</span></code>, avoid embedding the <code class="docutils literal notranslate"><span class="pre">AbstractList</span></code> in your concrete list
implementations.
Instead, hand-write only the methods to your concrete list that will delegate
to the abstract list.</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">AbstractList</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{}</span>

<span class="c1">// Add adds an entity to the list.</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">l</span><span class="w"> </span><span class="o">*</span><span class="nx">AbstractList</span><span class="p">)</span><span class="w"> </span><span class="nx">Add</span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="nx">Entity</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>

<span class="c1">// Remove removes an entity from the list.</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">l</span><span class="w"> </span><span class="o">*</span><span class="nx">AbstractList</span><span class="p">)</span><span class="w"> </span><span class="nx">Remove</span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="nx">Entity</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// ConcreteList is a list of entities.</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">ConcreteList</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="o">*</span><span class="nx">AbstractList</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// ConcreteList is a list of entities.</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">ConcreteList</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">list</span><span class="w"> </span><span class="o">*</span><span class="nx">AbstractList</span>
<span class="p">}</span>

<span class="c1">// Add adds an entity to the list.</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">l</span><span class="w"> </span><span class="o">*</span><span class="nx">ConcreteList</span><span class="p">)</span><span class="w"> </span><span class="nx">Add</span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="nx">Entity</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">l</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Remove removes an entity from the list.</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">l</span><span class="w"> </span><span class="o">*</span><span class="nx">ConcreteList</span><span class="p">)</span><span class="w"> </span><span class="nx">Remove</span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="nx">Entity</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">l</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">Remove</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>Go allows <a class="reference external" href="https://go.dev/doc/effective_go#embedding">type embedding</a> as a compromise between inheritance and composition.
The outer type gets implicit copies of the embedded type’s methods.
These methods, by default, delegate to the same method of the embedded
instance.</p>
<p>The struct also gains a field by the same name as the type.
So, if the embedded type is public, the field is public.
To maintain backward compatibility, every future version of the outer type must
keep the embedded type.</p>
<p>An embedded type is rarely necessary.
It is a convenience that helps you avoid writing tedious delegate methods.</p>
<p>Even embedding a compatible AbstractList <em>interface</em>, instead of the struct,
would offer the developer more flexibility to change in the future, but still
leak the detail that the concrete lists use an abstract implementation.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// AbstractList is a generalized implementation</span>
<span class="c1">// for various kinds of lists of entities.</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">AbstractList</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">Add</span><span class="p">(</span><span class="nx">Entity</span><span class="p">)</span>
<span class="w">  </span><span class="nx">Remove</span><span class="p">(</span><span class="nx">Entity</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// ConcreteList is a list of entities.</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">ConcreteList</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">AbstractList</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// ConcreteList is a list of entities.</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">ConcreteList</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">list</span><span class="w"> </span><span class="nx">AbstractList</span>
<span class="p">}</span>

<span class="c1">// Add adds an entity to the list.</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">l</span><span class="w"> </span><span class="o">*</span><span class="nx">ConcreteList</span><span class="p">)</span><span class="w"> </span><span class="nx">Add</span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="nx">Entity</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">l</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Remove removes an entity from the list.</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">l</span><span class="w"> </span><span class="o">*</span><span class="nx">ConcreteList</span><span class="p">)</span><span class="w"> </span><span class="nx">Remove</span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="nx">Entity</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">l</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">Remove</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>Either with an embedded struct or an embedded interface, the embedded type
places limits on the evolution of the type.</p>
<ul class="simple">
<li><p>Adding methods to an embedded interface is a breaking change.</p></li>
<li><p>Removing methods from an embedded struct is a breaking change.</p></li>
<li><p>Removing the embedded type is a breaking change.</p></li>
<li><p>Replacing the embedded type, even with an alternative that satisfies the same
interface, is a breaking change.</p></li>
</ul>
<p>Although writing these delegate methods is tedious, the additional effort hides
an implementation detail, leaves more opportunities for change, and also
eliminates indirection for discovering the full List interface in
documentation.</p>
</section>
<section id="avoid-using-built-in-names">
<h3><span class="section-number">4.1.2.16. </span>Avoid Using Built-In Names<a class="headerlink" href="#avoid-using-built-in-names" title="Permalink to this heading"></a></h3>
<p>The Go <a class="reference external" href="https://go.dev/ref/spec">language specification</a> outlines several built-in,
<a class="reference external" href="https://go.dev/ref/spec#Predeclared_identifiers">predeclared identifiers</a> that should not be used as names within Go programs.</p>
<p>Depending on context, reusing these identifiers as names will either shadow
the original within the current lexical scope (and any nested scopes) or make
affected code confusing. In the best case, the compiler will complain; in the
worst case, such code may introduce latent, hard-to-grep bugs.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="kt">string</span>
<span class="c1">// `error` shadows the builtin</span>

<span class="c1">// or</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">handleErrorMessage</span><span class="p">(</span><span class="kt">error</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// `error` shadows the builtin</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">errorMessage</span><span class="w"> </span><span class="kt">string</span>
<span class="c1">// `error` refers to the builtin</span>

<span class="c1">// or</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">handleErrorMessage</span><span class="p">(</span><span class="nx">msg</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// `error` refers to the builtin</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Foo</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// While these fields technically don&#39;t</span>
<span class="w">    </span><span class="c1">// constitute shadowing, grepping for</span>
<span class="w">    </span><span class="c1">// `error` or `string` strings is now</span>
<span class="w">    </span><span class="c1">// ambiguous.</span>
<span class="w">    </span><span class="kt">error</span><span class="w">  </span><span class="kt">error</span>
<span class="w">    </span><span class="kt">string</span><span class="w"> </span><span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">f</span><span class="w"> </span><span class="nx">Foo</span><span class="p">)</span><span class="w"> </span><span class="nx">Error</span><span class="p">()</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// `error` and `f.error` are</span>
<span class="w">    </span><span class="c1">// visually similar</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="kt">error</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">f</span><span class="w"> </span><span class="nx">Foo</span><span class="p">)</span><span class="w"> </span><span class="nx">String</span><span class="p">()</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// `string` and `f.string` are</span>
<span class="w">    </span><span class="c1">// visually similar</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="kt">string</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Foo</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// `error` and `string` strings are</span>
<span class="w">    </span><span class="c1">// now unambiguous.</span>
<span class="w">    </span><span class="nx">err</span><span class="w"> </span><span class="kt">error</span>
<span class="w">    </span><span class="nx">str</span><span class="w"> </span><span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">f</span><span class="w"> </span><span class="nx">Foo</span><span class="p">)</span><span class="w"> </span><span class="nx">Error</span><span class="p">()</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">err</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">f</span><span class="w"> </span><span class="nx">Foo</span><span class="p">)</span><span class="w"> </span><span class="nx">String</span><span class="p">()</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">str</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>Note that the compiler will not generate errors when using predeclared
identifiers, but tools such as <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">vet</span></code> should correctly point out these and
other cases of shadowing.</p>
</section>
<section id="avoid-init">
<h3><span class="section-number">4.1.2.17. </span>Avoid <code class="docutils literal notranslate"><span class="pre">init()</span></code><a class="headerlink" href="#avoid-init" title="Permalink to this heading"></a></h3>
<p>Avoid <code class="docutils literal notranslate"><span class="pre">init()</span></code> where possible. When <code class="docutils literal notranslate"><span class="pre">init()</span></code> is unavoidable or desirable, code
should attempt to:</p>
<ol class="simple">
<li><p>Be completely deterministic, regardless of program environment or invocation.</p></li>
<li><p>Avoid depending on the ordering or side-effects of other <code class="docutils literal notranslate"><span class="pre">init()</span></code> functions.
While <code class="docutils literal notranslate"><span class="pre">init()</span></code> ordering is well-known, code can change, and thus
relationships between <code class="docutils literal notranslate"><span class="pre">init()</span></code> functions can make code brittle and
error-prone.</p></li>
<li><p>Avoid accessing or manipulating global or environment state, such as machine
information, environment variables, working directory, program
arguments/inputs, etc.</p></li>
<li><p>Avoid I/O, including both filesystem, network, and system calls.</p></li>
</ol>
<p>Code that cannot satisfy these requirements likely belongs as a helper to be
called as part of <code class="docutils literal notranslate"><span class="pre">main()</span></code> (or elsewhere in a program’s lifecycle), or be
written as part of <code class="docutils literal notranslate"><span class="pre">main()</span></code> itself. In particular, libraries that are intended
to be used by other programs should take special care to be completely
deterministic and not perform “init magic”.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Foo</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>

<span class="kd">var</span><span class="w"> </span><span class="nx">_defaultFoo</span><span class="w"> </span><span class="nx">Foo</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">_defaultFoo</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">Foo</span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ...</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">_defaultFoo</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">Foo</span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>

<span class="c1">// or, better, for testability:</span>

<span class="kd">var</span><span class="w"> </span><span class="nx">_defaultFoo</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">defaultFoo</span><span class="p">()</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">defaultFoo</span><span class="p">()</span><span class="w"> </span><span class="nx">Foo</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">Foo</span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ...</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>

<span class="kd">var</span><span class="w"> </span><span class="nx">_config</span><span class="w"> </span><span class="nx">Config</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Bad: based on current directory</span>
<span class="w">    </span><span class="nx">cwd</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Getwd</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// Bad: I/O</span>
<span class="w">    </span><span class="nx">raw</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">ReadFile</span><span class="p">(</span>
<span class="w">        </span><span class="nx">path</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="nx">cwd</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;config&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;config.yaml&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="nx">yaml</span><span class="p">.</span><span class="nx">Unmarshal</span><span class="p">(</span><span class="nx">raw</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">_config</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">loadConfig</span><span class="p">()</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">cwd</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Getwd</span><span class="p">()</span>
<span class="w">    </span><span class="c1">// handle err</span>

<span class="w">    </span><span class="nx">raw</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">ReadFile</span><span class="p">(</span>
<span class="w">        </span><span class="nx">path</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="nx">cwd</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;config&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;config.yaml&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="c1">// handle err</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="nx">Config</span>
<span class="w">    </span><span class="nx">yaml</span><span class="p">.</span><span class="nx">Unmarshal</span><span class="p">(</span><span class="nx">raw</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">config</span><span class="p">)</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">config</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>Considering the above, some situations in which <code class="docutils literal notranslate"><span class="pre">init()</span></code> may be preferable or
necessary might include:</p>
<ul class="simple">
<li><p>Complex expressions that cannot be represented as single assignments.</p></li>
<li><p>Pluggable hooks, such as <code class="docutils literal notranslate"><span class="pre">database/sql</span></code> dialects, encoding type registries, etc.</p></li>
<li><p>Optimizations to <a class="reference external" href="https://cloud.google.com/functions/docs/bestpractices/tips#use_global_variables_to_reuse_objects_in_future_invocations">Google Cloud Functions</a> and other forms of deterministic
precomputation.</p></li>
</ul>
</section>
<section id="exit-in-main">
<h3><span class="section-number">4.1.2.18. </span>Exit in Main<a class="headerlink" href="#exit-in-main" title="Permalink to this heading"></a></h3>
<p>Go programs use <a class="reference external" href="https://pkg.go.dev/os#Exit"><code class="docutils literal notranslate"><span class="pre">os.Exit</span></code></a> or <a class="reference external" href="https://pkg.go.dev/log#Fatal"><code class="docutils literal notranslate"><span class="pre">log.Fatal*</span></code></a> to exit immediately. (Panicking
is not a good way to exit programs, please <a class="reference external" href="#dont-panic">don’t panic</a>.)</p>
<p>Call one of <code class="docutils literal notranslate"><span class="pre">os.Exit</span></code> or <code class="docutils literal notranslate"><span class="pre">log.Fatal*</span></code> <strong>only in <code class="docutils literal notranslate"><span class="pre">main()</span></code></strong>. All other
functions should return errors to signal failure.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">body</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">readFile</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
<span class="w">  </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">readFile</span><span class="p">(</span><span class="nx">path</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">f</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">io</span><span class="p">.</span><span class="nx">ReadAll</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">body</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">readFile</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">readFile</span><span class="p">(</span><span class="nx">path</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">f</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">io</span><span class="p">.</span><span class="nx">ReadAll</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>Rationale: Programs with multiple functions that exit present a few issues:</p>
<ul class="simple">
<li><p>Non-obvious control flow: Any function can exit the program so it becomes
difficult to reason about the control flow.</p></li>
<li><p>Difficult to test: A function that exits the program will also exit the test
calling it. This makes the function difficult to test and introduces risk of
skipping other tests that have not yet been run by <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">test</span></code>.</p></li>
<li><p>Skipped cleanup: When a function exits the program, it skips function calls
enqueued with <code class="docutils literal notranslate"><span class="pre">defer</span></code> statements. This adds risk of skipping important
cleanup tasks.</p></li>
</ul>
<section id="exit-once">
<h4><span class="section-number">4.1.2.18.1. </span>Exit Once<a class="headerlink" href="#exit-once" title="Permalink to this heading"></a></h4>
<p>If possible, prefer to call <code class="docutils literal notranslate"><span class="pre">os.Exit</span></code> or <code class="docutils literal notranslate"><span class="pre">log.Fatal</span></code> <strong>at most once</strong> in your
<code class="docutils literal notranslate"><span class="pre">main()</span></code>. If there are multiple error scenarios that halt program execution,
put that logic under a separate function and return errors from it.</p>
<p>This has the effect of shortening your <code class="docutils literal notranslate"><span class="pre">main()</span></code> function and putting all key
business logic into a separate, testable function.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">args</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">&quot;missing file&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="nx">name</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="w">  </span><span class="nx">f</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">defer</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>

<span class="w">  </span><span class="c1">// If we call log.Fatal after this line,</span>
<span class="w">  </span><span class="c1">// f.Close will not be called.</span>

<span class="w">  </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">io</span><span class="p">.</span><span class="nx">ReadAll</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">run</span><span class="p">();</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">run</span><span class="p">()</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">args</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;missing file&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="nx">name</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="w">  </span><span class="nx">f</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">defer</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>

<span class="w">  </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">io</span><span class="p">.</span><span class="nx">ReadAll</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>The example above uses <code class="docutils literal notranslate"><span class="pre">log.Fatal</span></code>, but the guidance also applies to
<code class="docutils literal notranslate"><span class="pre">os.Exit</span></code> or any library code that calls <code class="docutils literal notranslate"><span class="pre">os.Exit</span></code>.</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">run</span><span class="p">();</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintln</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="nx">os</span><span class="p">.</span><span class="nx">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You may alter the signature of <code class="docutils literal notranslate"><span class="pre">run()</span></code> to fit your needs.
For example, if your program must exit with specific exit codes for failures,
<code class="docutils literal notranslate"><span class="pre">run()</span></code> may return the exit code instead of an error.
This allows unit tests to verify this behavior directly as well.</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">os</span><span class="p">.</span><span class="nx">Exit</span><span class="p">(</span><span class="nx">run</span><span class="p">(</span><span class="nx">args</span><span class="p">))</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">run</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="nx">exitCode</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>More generally, note that the <code class="docutils literal notranslate"><span class="pre">run()</span></code> function used in these examples
is not intended to be prescriptive.
There’s flexibility in the name, signature, and setup of the <code class="docutils literal notranslate"><span class="pre">run()</span></code> function.
Among other things, you may:</p>
<ul class="simple">
<li><p>accept unparsed command line arguments (e.g., <code class="docutils literal notranslate"><span class="pre">run(os.Args[1:])</span></code>)</p></li>
<li><p>parse command line arguments in <code class="docutils literal notranslate"><span class="pre">main()</span></code> and pass them onto <code class="docutils literal notranslate"><span class="pre">run</span></code></p></li>
<li><p>use a custom error type to carry the exit code back to <code class="docutils literal notranslate"><span class="pre">main()</span></code></p></li>
<li><p>put business logic in a different layer of abstraction from <code class="docutils literal notranslate"><span class="pre">package</span> <span class="pre">main</span></code></p></li>
</ul>
<p>This guidance only requires that there’s a single place in your <code class="docutils literal notranslate"><span class="pre">main()</span></code>
responsible for actually exiting the process.</p>
</section>
</section>
<section id="use-field-tags-in-marshaled-structs">
<h3><span class="section-number">4.1.2.19. </span>Use field tags in marshaled structs<a class="headerlink" href="#use-field-tags-in-marshaled-structs" title="Permalink to this heading"></a></h3>
<p>Any struct field that is marshaled into JSON, YAML,
or other formats that support tag-based field naming
should be annotated with the relevant tag.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Stock</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">Price</span><span class="w"> </span><span class="kt">int</span>
<span class="w">  </span><span class="nx">Name</span><span class="w">  </span><span class="kt">string</span>
<span class="p">}</span>

<span class="nx">bytes</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">json</span><span class="p">.</span><span class="nx">Marshal</span><span class="p">(</span><span class="nx">Stock</span><span class="p">{</span>
<span class="w">  </span><span class="nx">Price</span><span class="p">:</span><span class="w"> </span><span class="mi">137</span><span class="p">,</span>
<span class="w">  </span><span class="nx">Name</span><span class="p">:</span><span class="w">  </span><span class="s">&quot;UBER&quot;</span><span class="p">,</span>
<span class="p">})</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Stock</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">Price</span><span class="w"> </span><span class="kt">int</span><span class="w">    </span><span class="s">`json:&quot;price&quot;`</span>
<span class="w">  </span><span class="nx">Name</span><span class="w">  </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;name&quot;`</span>
<span class="w">  </span><span class="c1">// Safe to rename Name to Symbol.</span>
<span class="p">}</span>

<span class="nx">bytes</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">json</span><span class="p">.</span><span class="nx">Marshal</span><span class="p">(</span><span class="nx">Stock</span><span class="p">{</span>
<span class="w">  </span><span class="nx">Price</span><span class="p">:</span><span class="w"> </span><span class="mi">137</span><span class="p">,</span>
<span class="w">  </span><span class="nx">Name</span><span class="p">:</span><span class="w">  </span><span class="s">&quot;UBER&quot;</span><span class="p">,</span>
<span class="p">})</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>Rationale:
The serialized form of the structure is a contract between different systems.
Changes to the structure of the serialized form–including field names–break
this contract. Specifying field names inside tags makes the contract explicit,
and it guards against accidentally breaking the contract by refactoring or
renaming fields.</p>
</section>
<section id="don-t-fire-and-forget-goroutines">
<h3><span class="section-number">4.1.2.20. </span>Don’t fire-and-forget goroutines<a class="headerlink" href="#don-t-fire-and-forget-goroutines" title="Permalink to this heading"></a></h3>
<p>Goroutines are lightweight, but they’re not free:
at minimum, they cost memory for their stack and CPU to be scheduled.
While these costs are small for typical uses of goroutines,
they can cause significant performance issues
when spawned in large numbers without controlled lifetimes.
Goroutines with unmanaged lifetimes can also cause other issues
like preventing unused objects from being garbage collected
and holding onto resources that are otherwise no longer used.</p>
<p>Therefore, do not leak goroutines in production code.
Use <a class="reference external" href="https://pkg.go.dev/go.uber.org/goleak">go.uber.org/goleak</a>
to test for goroutine leaks inside packages that may spawn goroutines.</p>
<p>In general, every goroutine:</p>
<ul class="simple">
<li><p>must have a predictable time at which it will stop running; or</p></li>
<li><p>there must be a way to signal to the goroutine that it should stop</p></li>
</ul>
<p>In both cases, there must be a way code to block and wait for the goroutine to
finish.</p>
<p>For example:</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">flush</span><span class="p">()</span>
<span class="w">    </span><span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="nx">delay</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}()</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="nx">stop</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kd">struct</span><span class="p">{})</span><span class="w"> </span><span class="c1">// tells the goroutine to stop</span>
<span class="w">  </span><span class="nx">done</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kd">struct</span><span class="p">{})</span><span class="w"> </span><span class="c1">// tells us that the goroutine exited</span>
<span class="p">)</span>
<span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">defer</span><span class="w"> </span><span class="nb">close</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span>

<span class="w">  </span><span class="nx">ticker</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">NewTicker</span><span class="p">(</span><span class="nx">delay</span><span class="p">)</span>
<span class="w">  </span><span class="k">defer</span><span class="w"> </span><span class="nx">ticker</span><span class="p">.</span><span class="nx">Stop</span><span class="p">()</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">ticker</span><span class="p">.</span><span class="nx">C</span><span class="p">:</span>
<span class="w">      </span><span class="nx">flush</span><span class="p">()</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">stop</span><span class="p">:</span>
<span class="w">      </span><span class="k">return</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}()</span>

<span class="c1">// Elsewhere...</span>
<span class="nb">close</span><span class="p">(</span><span class="nx">stop</span><span class="p">)</span><span class="w">  </span><span class="c1">// signal the goroutine to stop</span>
<span class="o">&lt;-</span><span class="nx">done</span><span class="w">       </span><span class="c1">// and wait for it to exit</span>
</pre></div>
</div>
</td></tr>
<tr><td><p>There’s no way to stop this goroutine.
This will run until the application exits.</p>
</td><td><p>This goroutine can be stopped with <code class="docutils literal notranslate"><span class="pre">close(stop)</span></code>,
and we can wait for it to exit with <code class="docutils literal notranslate"><span class="pre">&lt;-done</span></code>.</p>
</td></tr>
</tbody></table><section id="wait-for-goroutines-to-exit">
<h4><span class="section-number">4.1.2.20.1. </span>Wait for goroutines to exit<a class="headerlink" href="#wait-for-goroutines-to-exit" title="Permalink to this heading"></a></h4>
<p>Given a goroutine spawned by the system,
there must be a way to wait for the goroutine to exit.
There are two popular ways to do this:</p>
<ul>
<li><p>Use a <code class="docutils literal notranslate"><span class="pre">sync.WaitGroup</span></code>.
Do this if there are multiple goroutines that you want to wait for</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">wg</span><span class="w"> </span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
<span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">N</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">wg</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">  </span><span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">wg</span><span class="p">.</span><span class="nx">Done</span><span class="p">()</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">  </span><span class="p">}()</span>
<span class="p">}</span>

<span class="c1">// To wait for all to finish:</span>
<span class="nx">wg</span><span class="p">.</span><span class="nx">Wait</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p>Add another <code class="docutils literal notranslate"><span class="pre">chan</span> <span class="pre">struct{}</span></code> that the goroutine closes when it’s done.
Do this if there’s only one goroutine.</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">done</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kd">struct</span><span class="p">{})</span>
<span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">defer</span><span class="w"> </span><span class="nb">close</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}()</span>

<span class="c1">// To wait for the goroutine to finish:</span>
<span class="o">&lt;-</span><span class="nx">done</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="no-goroutines-in-init">
<h4><span class="section-number">4.1.2.20.2. </span>No goroutines in <code class="docutils literal notranslate"><span class="pre">init()</span></code><a class="headerlink" href="#no-goroutines-in-init" title="Permalink to this heading"></a></h4>
<p><code class="docutils literal notranslate"><span class="pre">init()</span></code> functions should not spawn goroutines.
See also <a class="reference external" href="#avoid-init">Avoid init()</a>.</p>
<p>If a package has need of a background goroutine,
it must expose an object that is responsible for managing a goroutine’s
lifetime.
The object must provide a method (<code class="docutils literal notranslate"><span class="pre">Close</span></code>, <code class="docutils literal notranslate"><span class="pre">Stop</span></code>, <code class="docutils literal notranslate"><span class="pre">Shutdown</span></code>, etc)
that signals the background goroutine to stop, and waits for it to exit.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">go</span><span class="w"> </span><span class="nx">doWork</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">doWork</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Worker</span><span class="w"> </span><span class="kd">struct</span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">NewWorker</span><span class="p">(</span><span class="o">...</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="nx">Worker</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">w</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">Worker</span><span class="p">{</span>
<span class="w">    </span><span class="nx">stop</span><span class="p">:</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kd">struct</span><span class="p">{}),</span>
<span class="w">    </span><span class="nx">done</span><span class="p">:</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kd">struct</span><span class="p">{}),</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">go</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">doWork</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">w</span><span class="w"> </span><span class="o">*</span><span class="nx">Worker</span><span class="p">)</span><span class="w"> </span><span class="nx">doWork</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">defer</span><span class="w"> </span><span class="nb">close</span><span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nx">done</span><span class="p">)</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">w</span><span class="p">.</span><span class="nx">stop</span><span class="p">:</span>
<span class="w">      </span><span class="k">return</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Shutdown tells the worker to stop</span>
<span class="c1">// and waits until it has finished.</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">w</span><span class="w"> </span><span class="o">*</span><span class="nx">Worker</span><span class="p">)</span><span class="w"> </span><span class="nx">Shutdown</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nb">close</span><span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nx">stop</span><span class="p">)</span>
<span class="w">  </span><span class="o">&lt;-</span><span class="nx">w</span><span class="p">.</span><span class="nx">done</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
<tr><td><p>Spawns a background goroutine unconditionally when the user exports this package.
The user has no control over the goroutine or a means of stopping it.</p>
</td><td><p>Spawns the worker only if the user requests it.
Provides a means of shutting down the worker so that the user can free up
resources used by the worker.</p>
<p>Note that you should use <code class="docutils literal notranslate"><span class="pre">WaitGroup</span></code>s if the worker manages multiple
goroutines.
See <a class="reference external" href="#wait-for-goroutines-to-exit">Wait for goroutines to exit</a>.</p>
</td></tr>
</tbody></table></section>
</section>
</section>
<section id="performance">
<h2><span class="section-number">4.1.3. </span>Performance<a class="headerlink" href="#performance" title="Permalink to this heading"></a></h2>
<p>Performance-specific guidelines apply only to the hot path.</p>
<section id="prefer-strconv-over-fmt">
<h3><span class="section-number">4.1.3.1. </span>Prefer strconv over fmt<a class="headerlink" href="#prefer-strconv-over-fmt" title="Permalink to this heading"></a></h3>
<p>When converting primitives to/from strings, <code class="docutils literal notranslate"><span class="pre">strconv</span></code> is faster than
<code class="docutils literal notranslate"><span class="pre">fmt</span></code>.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">s</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprint</span><span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nx">Int</span><span class="p">())</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">s</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">strconv</span><span class="p">.</span><span class="nx">Itoa</span><span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nx">Int</span><span class="p">())</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
<tr><td><div class="highlight-plain notranslate"><div class="highlight"><pre><span></span>BenchmarkFmtSprint-4    143 ns/op    2 allocs/op
</pre></div>
</div>
</td><td><div class="highlight-plain notranslate"><div class="highlight"><pre><span></span>BenchmarkStrconv-4    64.2 ns/op    1 allocs/op
</pre></div>
</div>
</td></tr>
</tbody></table></section>
<section id="avoid-repeated-string-to-byte-conversions">
<h3><span class="section-number">4.1.3.2. </span>Avoid repeated string-to-byte conversions<a class="headerlink" href="#avoid-repeated-string-to-byte-conversions" title="Permalink to this heading"></a></h3>
<p>Do not create byte slices from a fixed string repeatedly. Instead, perform the
conversion once and capture the result.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">w</span><span class="p">.</span><span class="nx">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;Hello world&quot;</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">data</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;Hello world&quot;</span><span class="p">)</span>
<span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">w</span><span class="p">.</span><span class="nx">Write</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
<tr><td><div class="highlight-plain notranslate"><div class="highlight"><pre><span></span>BenchmarkBad-4   50000000   22.2 ns/op
</pre></div>
</div>
</td><td><div class="highlight-plain notranslate"><div class="highlight"><pre><span></span>BenchmarkGood-4  500000000   3.25 ns/op
</pre></div>
</div>
</td></tr>
</tbody></table></section>
<section id="prefer-specifying-container-capacity">
<h3><span class="section-number">4.1.3.3. </span>Prefer Specifying Container Capacity<a class="headerlink" href="#prefer-specifying-container-capacity" title="Permalink to this heading"></a></h3>
<p>Specify container capacity where possible in order to allocate memory for the
container up front. This minimizes subsequent allocations (by copying and
resizing of the container) as elements are added.</p>
<section id="specifying-map-capacity-hints">
<h4><span class="section-number">4.1.3.3.1. </span>Specifying Map Capacity Hints<a class="headerlink" href="#specifying-map-capacity-hints" title="Permalink to this heading"></a></h4>
<p>Where possible, provide capacity hints when initializing
maps with <code class="docutils literal notranslate"><span class="pre">make()</span></code>.</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="nx">T1</span><span class="p">]</span><span class="nx">T2</span><span class="p">,</span><span class="w"> </span><span class="nx">hint</span><span class="p">)</span>
</pre></div>
</div>
<p>Providing a capacity hint to <code class="docutils literal notranslate"><span class="pre">make()</span></code> tries to right-size the
map at initialization time, which reduces the need for growing
the map and allocations as elements are added to the map.</p>
<p>Note that, unlike slices, map capacity hints do not guarantee complete,
preemptive allocation, but are used to approximate the number of hashmap buckets
required. Consequently, allocations may still occur when adding elements to the
map, even up to the specified capacity.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">m</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">os</span><span class="p">.</span><span class="nx">FileInfo</span><span class="p">)</span>

<span class="nx">files</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">ReadDir</span><span class="p">(</span><span class="s">&quot;./files&quot;</span><span class="p">)</span>
<span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">f</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">files</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">m</span><span class="p">[</span><span class="nx">f</span><span class="p">.</span><span class="nx">Name</span><span class="p">()]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">f</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">files</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">ReadDir</span><span class="p">(</span><span class="s">&quot;./files&quot;</span><span class="p">)</span>

<span class="nx">m</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">os</span><span class="p">.</span><span class="nx">DirEntry</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">files</span><span class="p">))</span>
<span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">f</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">files</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">m</span><span class="p">[</span><span class="nx">f</span><span class="p">.</span><span class="nx">Name</span><span class="p">()]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">f</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
<tr><td><p><code class="docutils literal notranslate"><span class="pre">m</span></code> is created without a size hint; there may be more
allocations at assignment time.</p>
</td><td><p><code class="docutils literal notranslate"><span class="pre">m</span></code> is created with a size hint; there may be fewer
allocations at assignment time.</p>
</td></tr>
</tbody></table></section>
<section id="specifying-slice-capacity">
<h4><span class="section-number">4.1.3.3.2. </span>Specifying Slice Capacity<a class="headerlink" href="#specifying-slice-capacity" title="Permalink to this heading"></a></h4>
<p>Where possible, provide capacity hints when initializing slices with <code class="docutils literal notranslate"><span class="pre">make()</span></code>,
particularly when appending.</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nb">make</span><span class="p">([]</span><span class="nx">T</span><span class="p">,</span><span class="w"> </span><span class="nx">length</span><span class="p">,</span><span class="w"> </span><span class="nx">capacity</span><span class="p">)</span>
</pre></div>
</div>
<p>Unlike maps, slice capacity is not a hint: the compiler will allocate enough
memory for the capacity of the slice as provided to <code class="docutils literal notranslate"><span class="pre">make()</span></code>, which means that
subsequent <code class="docutils literal notranslate"><span class="pre">append()</span></code> operations will incur zero allocations (until the length
of the slice matches the capacity, after which any appends will require a resize
to hold additional elements).</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span><span class="w"> </span><span class="nx">n</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">data</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">size</span><span class="p">;</span><span class="w"> </span><span class="nx">k</span><span class="o">++</span><span class="p">{</span>
<span class="w">    </span><span class="nx">data</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">k</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span><span class="w"> </span><span class="nx">n</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">data</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">size</span><span class="p">)</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">size</span><span class="p">;</span><span class="w"> </span><span class="nx">k</span><span class="o">++</span><span class="p">{</span>
<span class="w">    </span><span class="nx">data</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">k</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
<tr><td><div class="highlight-plain notranslate"><div class="highlight"><pre><span></span>BenchmarkBad-4    100000000    2.48s
</pre></div>
</div>
</td><td><div class="highlight-plain notranslate"><div class="highlight"><pre><span></span>BenchmarkGood-4   100000000    0.21s
</pre></div>
</div>
</td></tr>
</tbody></table></section>
</section>
</section>
<section id="style">
<h2><span class="section-number">4.1.4. </span>Style<a class="headerlink" href="#style" title="Permalink to this heading"></a></h2>
<section id="avoid-overly-long-lines">
<h3><span class="section-number">4.1.4.1. </span>Avoid overly long lines<a class="headerlink" href="#avoid-overly-long-lines" title="Permalink to this heading"></a></h3>
<p>Avoid lines of code that require readers to scroll horizontally
or turn their heads too much.</p>
<p>We recommend a soft line length limit of <strong>99 characters</strong>.
Authors should aim to wrap lines before hitting this limit,
but it is not a hard limit.
Code is allowed to exceed this limit.</p>
</section>
<section id="be-consistent">
<h3><span class="section-number">4.1.4.2. </span>Be Consistent<a class="headerlink" href="#be-consistent" title="Permalink to this heading"></a></h3>
<p>Some of the guidelines outlined in this document can be evaluated objectively;
others are situational, contextual, or subjective.</p>
<p>Above all else, <strong>be consistent</strong>.</p>
<p>Consistent code is easier to maintain, is easier to rationalize, requires less
cognitive overhead, and is easier to migrate or update as new conventions emerge
or classes of bugs are fixed.</p>
<p>Conversely, having multiple disparate or conflicting styles within a single
codebase causes maintenance overhead, uncertainty, and cognitive dissonance,
all of which can directly contribute to lower velocity, painful code reviews,
and bugs.</p>
<p>When applying these guidelines to a codebase, it is recommended that changes
are made at a package (or larger) level: application at a sub-package level
violates the above concern by introducing multiple styles into the same code.</p>
</section>
<section id="group-similar-declarations">
<h3><span class="section-number">4.1.4.3. </span>Group Similar Declarations<a class="headerlink" href="#group-similar-declarations" title="Permalink to this heading"></a></h3>
<p>Go supports grouping similar declarations.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="s">&quot;a&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="s">&quot;b&quot;</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="s">&quot;a&quot;</span>
<span class="w">  </span><span class="s">&quot;b&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>This also applies to constants, variables, and type declarations.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span>



<span class="kd">var</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span>



<span class="kd">type</span><span class="w"> </span><span class="nx">Area</span><span class="w"> </span><span class="kt">float64</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">Volume</span><span class="w"> </span><span class="kt">float64</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="nx">a</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="nx">b</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span>
<span class="p">)</span>

<span class="kd">var</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="nx">a</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="nx">b</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span>
<span class="p">)</span>

<span class="kd">type</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="nx">Area</span><span class="w"> </span><span class="kt">float64</span>
<span class="w">  </span><span class="nx">Volume</span><span class="w"> </span><span class="kt">float64</span>
<span class="p">)</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>Only group related declarations. Do not group declarations that are unrelated.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Operation</span><span class="w"> </span><span class="kt">int</span>

<span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="nx">Add</span><span class="w"> </span><span class="nx">Operation</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">iota</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="nx">Subtract</span>
<span class="w">  </span><span class="nx">Multiply</span>
<span class="w">  </span><span class="nx">EnvVar</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;MY_ENV&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Operation</span><span class="w"> </span><span class="kt">int</span>

<span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="nx">Add</span><span class="w"> </span><span class="nx">Operation</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">iota</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="nx">Subtract</span>
<span class="w">  </span><span class="nx">Multiply</span>
<span class="p">)</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">EnvVar</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;MY_ENV&quot;</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>Groups are not limited in where they can be used. For example, you can use them
inside of functions.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">f</span><span class="p">()</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">red</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">color</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="mh">0xff0000</span><span class="p">)</span>
<span class="w">  </span><span class="nx">green</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">color</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="mh">0x00ff00</span><span class="p">)</span>
<span class="w">  </span><span class="nx">blue</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">color</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="mh">0x0000ff</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">f</span><span class="p">()</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="nx">red</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="nx">color</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="mh">0xff0000</span><span class="p">)</span>
<span class="w">    </span><span class="nx">green</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">color</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="mh">0x00ff00</span><span class="p">)</span>
<span class="w">    </span><span class="nx">blue</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="nx">color</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="mh">0x0000ff</span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>Exception: Variable declarations, particularly inside functions, should be
grouped together if declared adjacent to other variables. Do this for variables
declared together even if they are unrelated.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">client</span><span class="p">)</span><span class="w"> </span><span class="nx">request</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">caller</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">name</span>
<span class="w">  </span><span class="nx">format</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;json&quot;</span>
<span class="w">  </span><span class="nx">timeout</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">5</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="kt">error</span>

<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">client</span><span class="p">)</span><span class="w"> </span><span class="nx">request</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="nx">caller</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">name</span>
<span class="w">    </span><span class="nx">format</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;json&quot;</span>
<span class="w">    </span><span class="nx">timeout</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">5</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span>
<span class="w">    </span><span class="nx">err</span><span class="w"> </span><span class="kt">error</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
<section id="import-group-ordering">
<h3><span class="section-number">4.1.4.4. </span>Import Group Ordering<a class="headerlink" href="#import-group-ordering" title="Permalink to this heading"></a></h3>
<p>There should be two import groups:</p>
<ul class="simple">
<li><p>Standard library</p></li>
<li><p>Everything else</p></li>
</ul>
<p>This is the grouping applied by goimports by default.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="s">&quot;fmt&quot;</span>
<span class="w">  </span><span class="s">&quot;os&quot;</span>
<span class="w">  </span><span class="s">&quot;go.uber.org/atomic&quot;</span>
<span class="w">  </span><span class="s">&quot;golang.org/x/sync/errgroup&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="s">&quot;fmt&quot;</span>
<span class="w">  </span><span class="s">&quot;os&quot;</span>

<span class="w">  </span><span class="s">&quot;go.uber.org/atomic&quot;</span>
<span class="w">  </span><span class="s">&quot;golang.org/x/sync/errgroup&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
<section id="package-names">
<h3><span class="section-number">4.1.4.5. </span>Package Names<a class="headerlink" href="#package-names" title="Permalink to this heading"></a></h3>
<p>When naming packages, choose a name that is:</p>
<ul class="simple">
<li><p>All lower-case. No capitals or underscores.</p></li>
<li><p>Does not need to be renamed using named imports at most call sites.</p></li>
<li><p>Short and succinct. Remember that the name is identified in full at every call
site.</p></li>
<li><p>Not plural. For example, <code class="docutils literal notranslate"><span class="pre">net/url</span></code>, not <code class="docutils literal notranslate"><span class="pre">net/urls</span></code>.</p></li>
<li><p>Not “common”, “util”, “shared”, or “lib”. These are bad, uninformative names.</p></li>
</ul>
<p>See also <a class="reference external" href="https://go.dev/blog/package-names">Package Names</a> and <a class="reference external" href="https://rakyll.org/style-packages/">Style guideline for Go packages</a>.</p>
</section>
<section id="function-names">
<h3><span class="section-number">4.1.4.6. </span>Function Names<a class="headerlink" href="#function-names" title="Permalink to this heading"></a></h3>
<p>We follow the Go community’s convention of using <a class="reference external" href="https://go.dev/doc/effective_go#mixed-caps">MixedCaps for function
names</a>. An exception is made for test functions, which may contain underscores
for the purpose of grouping related test cases, e.g.,
<code class="docutils literal notranslate"><span class="pre">TestMyFunction_WhatIsBeingTested</span></code>.</p>
</section>
<section id="import-aliasing">
<h3><span class="section-number">4.1.4.7. </span>Import Aliasing<a class="headerlink" href="#import-aliasing" title="Permalink to this heading"></a></h3>
<p>Import aliasing must be used if the package name does not match the last
element of the import path.</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="s">&quot;net/http&quot;</span>

<span class="w">  </span><span class="nx">client</span><span class="w"> </span><span class="s">&quot;example.com/client-go&quot;</span>
<span class="w">  </span><span class="nx">trace</span><span class="w"> </span><span class="s">&quot;example.com/trace/v2&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
<p>In all other scenarios, import aliases should be avoided unless there is a
direct conflict between imports.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="s">&quot;fmt&quot;</span>
<span class="w">  </span><span class="s">&quot;os&quot;</span>


<span class="w">  </span><span class="nx">nettrace</span><span class="w"> </span><span class="s">&quot;golang.net/x/trace&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="s">&quot;fmt&quot;</span>
<span class="w">  </span><span class="s">&quot;os&quot;</span>
<span class="w">  </span><span class="s">&quot;runtime/trace&quot;</span>

<span class="w">  </span><span class="nx">nettrace</span><span class="w"> </span><span class="s">&quot;golang.net/x/trace&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
<section id="function-grouping-and-ordering">
<h3><span class="section-number">4.1.4.8. </span>Function Grouping and Ordering<a class="headerlink" href="#function-grouping-and-ordering" title="Permalink to this heading"></a></h3>
<ul class="simple">
<li><p>Functions should be sorted in rough call order.</p></li>
<li><p>Functions in a file should be grouped by receiver.</p></li>
</ul>
<p>Therefore, exported functions should appear first in a file, after
<code class="docutils literal notranslate"><span class="pre">struct</span></code>, <code class="docutils literal notranslate"><span class="pre">const</span></code>, <code class="docutils literal notranslate"><span class="pre">var</span></code> definitions.</p>
<p>A <code class="docutils literal notranslate"><span class="pre">newXYZ()</span></code>/<code class="docutils literal notranslate"><span class="pre">NewXYZ()</span></code> may appear after the type is defined, but before the
rest of the methods on the receiver.</p>
<p>Since functions are grouped by receiver, plain utility functions should appear
towards the end of the file.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">something</span><span class="p">)</span><span class="w"> </span><span class="nx">Cost</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">calcCost</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">weights</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">something</span><span class="w"> </span><span class="kd">struct</span><span class="p">{</span><span class="w"> </span><span class="o">...</span><span class="w"> </span><span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">calcCost</span><span class="p">(</span><span class="nx">n</span><span class="w"> </span><span class="p">[]</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="p">{</span><span class="o">...</span><span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">something</span><span class="p">)</span><span class="w"> </span><span class="nx">Stop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="o">...</span><span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">newSomething</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="nx">something</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">something</span><span class="p">{}</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">something</span><span class="w"> </span><span class="kd">struct</span><span class="p">{</span><span class="w"> </span><span class="o">...</span><span class="w"> </span><span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">newSomething</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="nx">something</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">something</span><span class="p">{}</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">something</span><span class="p">)</span><span class="w"> </span><span class="nx">Cost</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">calcCost</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">weights</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">something</span><span class="p">)</span><span class="w"> </span><span class="nx">Stop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="o">...</span><span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">calcCost</span><span class="p">(</span><span class="nx">n</span><span class="w"> </span><span class="p">[]</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="p">{</span><span class="o">...</span><span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
<section id="reduce-nesting">
<h3><span class="section-number">4.1.4.9. </span>Reduce Nesting<a class="headerlink" href="#reduce-nesting" title="Permalink to this heading"></a></h3>
<p>Code should reduce nesting where possible by handling error cases/special
conditions first and returning early or continuing the loop. Reduce the amount
of code that is nested multiple levels.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">v</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">v</span><span class="p">.</span><span class="nx">F1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">v</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">process</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">v</span><span class="p">.</span><span class="nx">Call</span><span class="p">();</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">v</span><span class="p">.</span><span class="nx">Send</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Invalid v: %v&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">v</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">v</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">v</span><span class="p">.</span><span class="nx">F1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Invalid v: %v&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">v</span><span class="p">)</span>
<span class="w">    </span><span class="k">continue</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">v</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">process</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">v</span><span class="p">.</span><span class="nx">Call</span><span class="p">();</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="nx">v</span><span class="p">.</span><span class="nx">Send</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
<section id="unnecessary-else">
<h3><span class="section-number">4.1.4.10. </span>Unnecessary Else<a class="headerlink" href="#unnecessary-else" title="Permalink to this heading"></a></h3>
<p>If a variable is set in both branches of an if, it can be replaced with a
single if.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="kt">int</span>
<span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">a</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">100</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">a</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">10</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">a</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">10</span>
<span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">a</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">100</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
<section id="top-level-variable-declarations">
<h3><span class="section-number">4.1.4.11. </span>Top-level Variable Declarations<a class="headerlink" href="#top-level-variable-declarations" title="Permalink to this heading"></a></h3>
<p>At the top level, use the standard <code class="docutils literal notranslate"><span class="pre">var</span></code> keyword. Do not specify the type,
unless it is not the same type as the expression.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">_s</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">F</span><span class="p">()</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">F</span><span class="p">()</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;A&quot;</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">_s</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">F</span><span class="p">()</span>
<span class="c1">// Since F already states that it returns a string, we don&#39;t need to specify</span>
<span class="c1">// the type again.</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">F</span><span class="p">()</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;A&quot;</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>Specify the type if the type of the expression does not match the desired type
exactly.</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">myError</span><span class="w"> </span><span class="kd">struct</span><span class="p">{}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">myError</span><span class="p">)</span><span class="w"> </span><span class="nx">Error</span><span class="p">()</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;error&quot;</span><span class="w"> </span><span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">F</span><span class="p">()</span><span class="w"> </span><span class="nx">myError</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">myError</span><span class="p">{}</span><span class="w"> </span><span class="p">}</span>

<span class="kd">var</span><span class="w"> </span><span class="nx">_e</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">F</span><span class="p">()</span>
<span class="c1">// F returns an object of type myError but we want error.</span>
</pre></div>
</div>
</section>
<section id="prefix-unexported-globals-with">
<h3><span class="section-number">4.1.4.12. </span>Prefix Unexported Globals with _<a class="headerlink" href="#prefix-unexported-globals-with" title="Permalink to this heading"></a></h3>
<p>Prefix unexported top-level <code class="docutils literal notranslate"><span class="pre">var</span></code>s and <code class="docutils literal notranslate"><span class="pre">const</span></code>s with <code class="docutils literal notranslate"><span class="pre">_</span></code> to make it clear when
they are used that they are global symbols.</p>
<p>Rationale: Top-level variables and constants have a package scope. Using a
generic name makes it easy to accidentally use the wrong value in a different
file.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// foo.go</span>

<span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="nx">defaultPort</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">8080</span>
<span class="w">  </span><span class="nx">defaultUser</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;user&quot;</span>
<span class="p">)</span>

<span class="c1">// bar.go</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">Bar</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">defaultPort</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">9090</span>
<span class="w">  </span><span class="o">...</span>
<span class="w">  </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Default port&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">defaultPort</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// We will not see a compile error if the first line of</span>
<span class="w">  </span><span class="c1">// Bar() is deleted.</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// foo.go</span>

<span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="nx">_defaultPort</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">8080</span>
<span class="w">  </span><span class="nx">_defaultUser</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;user&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p><strong>Exception</strong>: Unexported error values may use the prefix <code class="docutils literal notranslate"><span class="pre">err</span></code> without the underscore.
See <a class="reference external" href="#error-naming">Error Naming</a>.</p>
</section>
<section id="embedding-in-structs">
<h3><span class="section-number">4.1.4.13. </span>Embedding in Structs<a class="headerlink" href="#embedding-in-structs" title="Permalink to this heading"></a></h3>
<p>Embedded types should be at the top of the field list of a
struct, and there must be an empty line separating embedded fields from regular
fields.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Client</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">version</span><span class="w"> </span><span class="kt">int</span>
<span class="w">  </span><span class="nx">http</span><span class="p">.</span><span class="nx">Client</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Client</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">http</span><span class="p">.</span><span class="nx">Client</span>

<span class="w">  </span><span class="nx">version</span><span class="w"> </span><span class="kt">int</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>Embedding should provide tangible benefit, like adding or augmenting
functionality in a semantically-appropriate way. It should do this with zero
adverse user-facing effects (see also: <a class="reference external" href="#avoid-embedding-types-in-public-structs">Avoid Embedding Types in Public Structs</a>).</p>
<p>Exception: Mutexes should not be embedded, even on unexported types. See also: <a class="reference external" href="#zero-value-mutexes-are-valid">Zero-value Mutexes are Valid</a>.</p>
<p>Embedding <strong>should not</strong>:</p>
<ul class="simple">
<li><p>Be purely cosmetic or convenience-oriented.</p></li>
<li><p>Make outer types more difficult to construct or use.</p></li>
<li><p>Affect outer types’ zero values. If the outer type has a useful zero value, it
should still have a useful zero value after embedding the inner type.</p></li>
<li><p>Expose unrelated functions or fields from the outer type as a side-effect of
embedding the inner type.</p></li>
<li><p>Expose unexported types.</p></li>
<li><p>Affect outer types’ copy semantics.</p></li>
<li><p>Change the outer type’s API or type semantics.</p></li>
<li><p>Embed a non-canonical form of the inner type.</p></li>
<li><p>Expose implementation details of the outer type.</p></li>
<li><p>Allow users to observe or control type internals.</p></li>
<li><p>Change the general behavior of inner functions through wrapping in a way that
would reasonably surprise users.</p></li>
</ul>
<p>Simply put, embed consciously and intentionally. A good litmus test is, “would
all of these exported inner methods/fields be added directly to the outer type”;
if the answer is “some” or “no”, don’t embed the inner type - use a field
instead.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">A</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Bad: A.Lock() and A.Unlock() are</span>
<span class="w">    </span><span class="c1">//      now available, provide no</span>
<span class="w">    </span><span class="c1">//      functional benefit, and allow</span>
<span class="w">    </span><span class="c1">//      users to control details about</span>
<span class="w">    </span><span class="c1">//      the internals of A.</span>
<span class="w">    </span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">countingWriteCloser</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Good: Write() is provided at this</span>
<span class="w">    </span><span class="c1">//       outer layer for a specific</span>
<span class="w">    </span><span class="c1">//       purpose, and delegates work</span>
<span class="w">    </span><span class="c1">//       to the inner type&#39;s Write().</span>
<span class="w">    </span><span class="nx">io</span><span class="p">.</span><span class="nx">WriteCloser</span>

<span class="w">    </span><span class="nx">count</span><span class="w"> </span><span class="kt">int</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">w</span><span class="w"> </span><span class="o">*</span><span class="nx">countingWriteCloser</span><span class="p">)</span><span class="w"> </span><span class="nx">Write</span><span class="p">(</span><span class="nx">bs</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">w</span><span class="p">.</span><span class="nx">count</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">bs</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">WriteCloser</span><span class="p">.</span><span class="nx">Write</span><span class="p">(</span><span class="nx">bs</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Book</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Bad: pointer changes zero value usefulness</span>
<span class="w">    </span><span class="nx">io</span><span class="p">.</span><span class="nx">ReadWriter</span>

<span class="w">    </span><span class="c1">// other fields</span>
<span class="p">}</span>

<span class="c1">// later</span>

<span class="kd">var</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="nx">Book</span>
<span class="nx">b</span><span class="p">.</span><span class="nx">Read</span><span class="p">(</span><span class="o">...</span><span class="p">)</span><span class="w">  </span><span class="c1">// panic: nil pointer</span>
<span class="nx">b</span><span class="p">.</span><span class="nx">String</span><span class="p">()</span><span class="w">   </span><span class="c1">// panic: nil pointer</span>
<span class="nx">b</span><span class="p">.</span><span class="nx">Write</span><span class="p">(</span><span class="o">...</span><span class="p">)</span><span class="w"> </span><span class="c1">// panic: nil pointer</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Book</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Good: has useful zero value</span>
<span class="w">    </span><span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span>

<span class="w">    </span><span class="c1">// other fields</span>
<span class="p">}</span>

<span class="c1">// later</span>

<span class="kd">var</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="nx">Book</span>
<span class="nx">b</span><span class="p">.</span><span class="nx">Read</span><span class="p">(</span><span class="o">...</span><span class="p">)</span><span class="w">  </span><span class="c1">// ok</span>
<span class="nx">b</span><span class="p">.</span><span class="nx">String</span><span class="p">()</span><span class="w">   </span><span class="c1">// ok</span>
<span class="nx">b</span><span class="p">.</span><span class="nx">Write</span><span class="p">(</span><span class="o">...</span><span class="p">)</span><span class="w"> </span><span class="c1">// ok</span>
</pre></div>
</div>
</td></tr>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Client</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
<span class="w">    </span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
<span class="w">    </span><span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span>
<span class="w">    </span><span class="nx">url</span><span class="p">.</span><span class="nx">URL</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Client</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">mtx</span><span class="w"> </span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
<span class="w">    </span><span class="nx">wg</span><span class="w">  </span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
<span class="w">    </span><span class="nx">buf</span><span class="w"> </span><span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span>
<span class="w">    </span><span class="nx">url</span><span class="w"> </span><span class="nx">url</span><span class="p">.</span><span class="nx">URL</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
<section id="local-variable-declarations">
<h3><span class="section-number">4.1.4.14. </span>Local Variable Declarations<a class="headerlink" href="#local-variable-declarations" title="Permalink to this heading"></a></h3>
<p>Short variable declarations (<code class="docutils literal notranslate"><span class="pre">:=</span></code>) should be used if a variable is being set to
some value explicitly.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;foo&quot;</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">s</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;foo&quot;</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>However, there are cases where the default value is clearer when the <code class="docutils literal notranslate"><span class="pre">var</span></code>
keyword is used. <a class="reference external" href="https://go.dev/wiki/CodeReviewComments#declaring-empty-slices">Declaring Empty Slices</a>, for example.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">f</span><span class="p">(</span><span class="nx">list</span><span class="w"> </span><span class="p">[]</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">filtered</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="kt">int</span><span class="p">{}</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">v</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">list</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">v</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">filtered</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">filtered</span><span class="p">,</span><span class="w"> </span><span class="nx">v</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">f</span><span class="p">(</span><span class="nx">list</span><span class="w"> </span><span class="p">[]</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">filtered</span><span class="w"> </span><span class="p">[]</span><span class="kt">int</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">v</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">list</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">v</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">filtered</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">filtered</span><span class="p">,</span><span class="w"> </span><span class="nx">v</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
<section id="nil-is-a-valid-slice">
<h3><span class="section-number">4.1.4.15. </span>nil is a valid slice<a class="headerlink" href="#nil-is-a-valid-slice" title="Permalink to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">nil</span></code> is a valid slice of length 0. This means that,</p>
<ul>
<li><p>You should not return a slice of length zero explicitly. Return <code class="docutils literal notranslate"><span class="pre">nil</span></code>
instead.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">[]</span><span class="kt">int</span><span class="p">{}</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table></li>
<li><p>To check if a slice is empty, always use <code class="docutils literal notranslate"><span class="pre">len(s)</span> <span class="pre">==</span> <span class="pre">0</span></code>. Do not check for
<code class="docutils literal notranslate"><span class="pre">nil</span></code>.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="p">[]</span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="p">[]</span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table></li>
<li><p>The zero value (a slice declared with <code class="docutils literal notranslate"><span class="pre">var</span></code>) is usable immediately without
<code class="docutils literal notranslate"><span class="pre">make()</span></code>.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">nums</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="kt">int</span><span class="p">{}</span>
<span class="c1">// or, nums := make([]int)</span>

<span class="k">if</span><span class="w"> </span><span class="nx">add1</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">nums</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">nums</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">if</span><span class="w"> </span><span class="nx">add2</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">nums</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">nums</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">nums</span><span class="w"> </span><span class="p">[]</span><span class="kt">int</span>

<span class="k">if</span><span class="w"> </span><span class="nx">add1</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">nums</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">nums</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">if</span><span class="w"> </span><span class="nx">add2</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">nums</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">nums</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table></li>
</ul>
<p>Remember that, while it is a valid slice, a nil slice is not equivalent to an
allocated slice of length 0 - one is nil and the other is not - and the two may
be treated differently in different situations (such as serialization).</p>
</section>
<section id="reduce-scope-of-variables">
<h3><span class="section-number">4.1.4.16. </span>Reduce Scope of Variables<a class="headerlink" href="#reduce-scope-of-variables" title="Permalink to this heading"></a></h3>
<p>Where possible, reduce scope of variables and constants. Do not reduce the scope if it
conflicts with <a class="reference external" href="#reduce-nesting">Reduce Nesting</a>.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">WriteFile</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="mo">0644</span><span class="p">)</span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">WriteFile</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="mo">0644</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>If you need a result of a function call outside of the if, then you should not
try to reduce the scope.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">ReadFile</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">cfg</span><span class="p">.</span><span class="nx">Decode</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">cfg</span><span class="p">)</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">ReadFile</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="p">}</span>

<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">cfg</span><span class="p">.</span><span class="nx">Decode</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="p">}</span>

<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">cfg</span><span class="p">)</span>
<span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>Constants do not need to be global unless they are used in multiple functions or files
or are part of an external contract of the package.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="nx">_defaultPort</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">8080</span>
<span class="w">  </span><span class="nx">_defaultUser</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;user&quot;</span>
<span class="p">)</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">Bar</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Default port&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">_defaultPort</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">Bar</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="nx">defaultPort</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">8080</span>
<span class="w">    </span><span class="nx">defaultUser</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;user&quot;</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Default port&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">defaultPort</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
<section id="avoid-naked-parameters">
<h3><span class="section-number">4.1.4.17. </span>Avoid Naked Parameters<a class="headerlink" href="#avoid-naked-parameters" title="Permalink to this heading"></a></h3>
<p>Naked parameters in function calls can hurt readability. Add C-style comments
(<code class="docutils literal notranslate"><span class="pre">/*</span> <span class="pre">...</span> <span class="pre">*/</span></code>) for parameter names when their meaning is not obvious.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// func printInfo(name string, isLocal, done bool)</span>

<span class="nx">printInfo</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// func printInfo(name string, isLocal, done bool)</span>

<span class="nx">printInfo</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="cm">/* isLocal */</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="cm">/* done */</span><span class="p">)</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>Better yet, replace naked <code class="docutils literal notranslate"><span class="pre">bool</span></code> types with custom types for more readable and
type-safe code. This allows more than just two states (true/false) for that
parameter in the future.</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Region</span><span class="w"> </span><span class="kt">int</span>

<span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="nx">UnknownRegion</span><span class="w"> </span><span class="nx">Region</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">iota</span>
<span class="w">  </span><span class="nx">Local</span>
<span class="p">)</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">Status</span><span class="w"> </span><span class="kt">int</span>

<span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="nx">StatusReady</span><span class="w"> </span><span class="nx">Status</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">iota</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="nx">StatusDone</span>
<span class="w">  </span><span class="c1">// Maybe we will have a StatusInProgress in the future.</span>
<span class="p">)</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">printInfo</span><span class="p">(</span><span class="nx">name</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">region</span><span class="w"> </span><span class="nx">Region</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="w"> </span><span class="nx">Status</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="use-raw-string-literals-to-avoid-escaping">
<h3><span class="section-number">4.1.4.18. </span>Use Raw String Literals to Avoid Escaping<a class="headerlink" href="#use-raw-string-literals-to-avoid-escaping" title="Permalink to this heading"></a></h3>
<p>Go supports <a class="reference external" href="https://go.dev/ref/spec#raw_string_lit">raw string literals</a>,
which can span multiple lines and include quotes. Use these to avoid
hand-escaped strings which are much harder to read.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">wantError</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;unknown name:\&quot;test\&quot;&quot;</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">wantError</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">`unknown error:&quot;test&quot;`</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
<section id="initializing-structs">
<h3><span class="section-number">4.1.4.19. </span>Initializing Structs<a class="headerlink" href="#initializing-structs" title="Permalink to this heading"></a></h3>
<section id="use-field-names-to-initialize-structs">
<h4><span class="section-number">4.1.4.19.1. </span>Use Field Names to Initialize Structs<a class="headerlink" href="#use-field-names-to-initialize-structs" title="Permalink to this heading"></a></h4>
<p>You should almost always specify field names when initializing structs. This is
now enforced by <a class="reference external" href="https://pkg.go.dev/cmd/vet"><code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">vet</span></code></a>.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">k</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">User</span><span class="p">{</span><span class="s">&quot;John&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Doe&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">k</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">User</span><span class="p">{</span>
<span class="w">    </span><span class="nx">FirstName</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;John&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">LastName</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Doe&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">Admin</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>Exception: Field names <em>may</em> be omitted in test tables when there are 3 or
fewer fields.</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">tests</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="kd">struct</span><span class="p">{</span>
<span class="w">  </span><span class="nx">op</span><span class="w"> </span><span class="nx">Operation</span>
<span class="w">  </span><span class="nx">want</span><span class="w"> </span><span class="kt">string</span>
<span class="p">}{</span>
<span class="w">  </span><span class="p">{</span><span class="nx">Add</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;add&quot;</span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span><span class="nx">Subtract</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;subtract&quot;</span><span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="omit-zero-value-fields-in-structs">
<h4><span class="section-number">4.1.4.19.2. </span>Omit Zero Value Fields in Structs<a class="headerlink" href="#omit-zero-value-fields-in-structs" title="Permalink to this heading"></a></h4>
<p>When initializing structs with field names, omit fields that have zero values
unless they provide meaningful context. Otherwise, let Go set these to zero
values automatically.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">user</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">User</span><span class="p">{</span>
<span class="w">  </span><span class="nx">FirstName</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;John&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">LastName</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Doe&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">MiddleName</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">Admin</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">user</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">User</span><span class="p">{</span>
<span class="w">  </span><span class="nx">FirstName</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;John&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">LastName</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Doe&quot;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>This helps reduce noise for readers by omitting values that are default in
that context. Only meaningful values are specified.</p>
<p>Include zero values where field names provide meaningful context. For example,
test cases in <a class="reference external" href="#test-tables">Test Tables</a> can benefit from names of fields
even when they are zero-valued.</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">tests</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="kd">struct</span><span class="p">{</span>
<span class="w">  </span><span class="nx">give</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="nx">want</span><span class="w"> </span><span class="kt">int</span>
<span class="p">}{</span>
<span class="w">  </span><span class="p">{</span><span class="nx">give</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;0&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">want</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="use-var-for-zero-value-structs">
<h4><span class="section-number">4.1.4.19.3. </span>Use <code class="docutils literal notranslate"><span class="pre">var</span></code> for Zero Value Structs<a class="headerlink" href="#use-var-for-zero-value-structs" title="Permalink to this heading"></a></h4>
<p>When all the fields of a struct are omitted in a declaration, use the <code class="docutils literal notranslate"><span class="pre">var</span></code>
form to declare the struct.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">user</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">User</span><span class="p">{}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="nx">User</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>This differentiates zero valued structs from those with non-zero fields
similar to the distinction created for <a class="reference external" href="#initializing-maps">map initialization</a>, and matches how
we prefer to <a class="reference external" href="https://go.dev/wiki/CodeReviewComments#declaring-empty-slices">declare empty slices</a>.</p>
</section>
<section id="initializing-struct-references">
<h4><span class="section-number">4.1.4.19.4. </span>Initializing Struct References<a class="headerlink" href="#initializing-struct-references" title="Permalink to this heading"></a></h4>
<p>Use <code class="docutils literal notranslate"><span class="pre">&amp;T{}</span></code> instead of <code class="docutils literal notranslate"><span class="pre">new(T)</span></code> when initializing struct references so that it
is consistent with the struct initialization.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">sval</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">T</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;foo&quot;</span><span class="p">}</span>

<span class="c1">// inconsistent</span>
<span class="nx">sptr</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">new</span><span class="p">(</span><span class="nx">T</span><span class="p">)</span>
<span class="nx">sptr</span><span class="p">.</span><span class="nx">Name</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;bar&quot;</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">sval</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">T</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;foo&quot;</span><span class="p">}</span>

<span class="nx">sptr</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">T</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bar&quot;</span><span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
</section>
<section id="initializing-maps">
<h3><span class="section-number">4.1.4.20. </span>Initializing Maps<a class="headerlink" href="#initializing-maps" title="Permalink to this heading"></a></h3>
<p>Prefer <code class="docutils literal notranslate"><span class="pre">make(..)</span></code> for empty maps, and maps populated
programmatically. This makes map initialization visually
distinct from declaration, and it makes it easy to add size
hints later if available.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="c1">// m1 is safe to read and write;</span>
<span class="w">  </span><span class="c1">// m2 will panic on writes.</span>
<span class="w">  </span><span class="nx">m1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="nx">T1</span><span class="p">]</span><span class="nx">T2</span><span class="p">{}</span>
<span class="w">  </span><span class="nx">m2</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="nx">T1</span><span class="p">]</span><span class="nx">T2</span>
<span class="p">)</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="c1">// m1 is safe to read and write;</span>
<span class="w">  </span><span class="c1">// m2 will panic on writes.</span>
<span class="w">  </span><span class="nx">m1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="nx">T1</span><span class="p">]</span><span class="nx">T2</span><span class="p">)</span>
<span class="w">  </span><span class="nx">m2</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="nx">T1</span><span class="p">]</span><span class="nx">T2</span>
<span class="p">)</span>
</pre></div>
</div>
</td></tr>
<tr><td><p>Declaration and initialization are visually similar.</p>
</td><td><p>Declaration and initialization are visually distinct.</p>
</td></tr>
</tbody></table><p>Where possible, provide capacity hints when initializing
maps with <code class="docutils literal notranslate"><span class="pre">make()</span></code>. See
<a class="reference external" href="#specifying-map-capacity-hints">Specifying Map Capacity Hints</a>
for more information.</p>
<p>On the other hand, if the map holds a fixed list of elements,
use map literals to initialize the map.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">m</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="nx">T1</span><span class="p">]</span><span class="nx">T2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span>
<span class="nx">m</span><span class="p">[</span><span class="nx">k1</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">v1</span>
<span class="nx">m</span><span class="p">[</span><span class="nx">k2</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">v2</span>
<span class="nx">m</span><span class="p">[</span><span class="nx">k3</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">v3</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">m</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="nx">T1</span><span class="p">]</span><span class="nx">T2</span><span class="p">{</span>
<span class="w">  </span><span class="nx">k1</span><span class="p">:</span><span class="w"> </span><span class="nx">v1</span><span class="p">,</span>
<span class="w">  </span><span class="nx">k2</span><span class="p">:</span><span class="w"> </span><span class="nx">v2</span><span class="p">,</span>
<span class="w">  </span><span class="nx">k3</span><span class="p">:</span><span class="w"> </span><span class="nx">v3</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>The basic rule of thumb is to use map literals when adding a fixed set of
elements at initialization time, otherwise use <code class="docutils literal notranslate"><span class="pre">make</span></code> (and specify a size hint
if available).</p>
</section>
<section id="format-strings-outside-printf">
<h3><span class="section-number">4.1.4.21. </span>Format Strings outside Printf<a class="headerlink" href="#format-strings-outside-printf" title="Permalink to this heading"></a></h3>
<p>If you declare format strings for <code class="docutils literal notranslate"><span class="pre">Printf</span></code>-style functions outside a string
literal, make them <code class="docutils literal notranslate"><span class="pre">const</span></code> values.</p>
<p>This helps <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">vet</span></code> perform static analysis of the format string.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;unexpected values %v, %v\n&quot;</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;unexpected values %v, %v\n&quot;</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
<section id="naming-printf-style-functions">
<h3><span class="section-number">4.1.4.22. </span>Naming Printf-style Functions<a class="headerlink" href="#naming-printf-style-functions" title="Permalink to this heading"></a></h3>
<p>When you declare a <code class="docutils literal notranslate"><span class="pre">Printf</span></code>-style function, make sure that <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">vet</span></code> can detect
it and check the format string.</p>
<p>This means that you should use predefined <code class="docutils literal notranslate"><span class="pre">Printf</span></code>-style function
names if possible. <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">vet</span></code> will check these by default. See <a class="reference external" href="https://pkg.go.dev/cmd/vet#hdr-Printf_family">Printf family</a>
for more information.</p>
<p>If using the predefined names is not an option, end the name you choose with
f: <code class="docutils literal notranslate"><span class="pre">Wrapf</span></code>, not <code class="docutils literal notranslate"><span class="pre">Wrap</span></code>. <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">vet</span></code> can be asked to check specific <code class="docutils literal notranslate"><span class="pre">Printf</span></code>-style
names but they must end with f.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>go<span class="w"> </span>vet<span class="w"> </span>-printfuncs<span class="o">=</span>wrapf,statusf
</pre></div>
</div>
<p>See also <a class="reference external" href="https://kuzminva.wordpress.com/2017/11/07/go-vet-printf-family-check/">go vet: Printf family check</a>.</p>
</section>
</section>
<section id="patterns">
<h2><span class="section-number">4.1.5. </span>Patterns<a class="headerlink" href="#patterns" title="Permalink to this heading"></a></h2>
<section id="test-tables">
<h3><span class="section-number">4.1.5.1. </span>Test Tables<a class="headerlink" href="#test-tables" title="Permalink to this heading"></a></h3>
<p>Table-driven tests with <a class="reference external" href="https://go.dev/blog/subtests">subtests</a> can be a helpful pattern for writing tests
to avoid duplicating code when the core test logic is repetitive.</p>
<p>If a system under test needs to be tested against <em>multiple conditions</em> where
certain parts of the the inputs and outputs change, a table-driven test should
be used to reduce redundancy and improve readability.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// func TestSplitHostPort(t *testing.T)</span>

<span class="nx">host</span><span class="p">,</span><span class="w"> </span><span class="nx">port</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">net</span><span class="p">.</span><span class="nx">SplitHostPort</span><span class="p">(</span><span class="s">&quot;192.0.2.0:8000&quot;</span><span class="p">)</span>
<span class="nx">require</span><span class="p">.</span><span class="nx">NoError</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;192.0.2.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">host</span><span class="p">)</span>
<span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;8000&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">port</span><span class="p">)</span>

<span class="nx">host</span><span class="p">,</span><span class="w"> </span><span class="nx">port</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">net</span><span class="p">.</span><span class="nx">SplitHostPort</span><span class="p">(</span><span class="s">&quot;192.0.2.0:http&quot;</span><span class="p">)</span>
<span class="nx">require</span><span class="p">.</span><span class="nx">NoError</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;192.0.2.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">host</span><span class="p">)</span>
<span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;http&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">port</span><span class="p">)</span>

<span class="nx">host</span><span class="p">,</span><span class="w"> </span><span class="nx">port</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">net</span><span class="p">.</span><span class="nx">SplitHostPort</span><span class="p">(</span><span class="s">&quot;:8000&quot;</span><span class="p">)</span>
<span class="nx">require</span><span class="p">.</span><span class="nx">NoError</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">host</span><span class="p">)</span>
<span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;8000&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">port</span><span class="p">)</span>

<span class="nx">host</span><span class="p">,</span><span class="w"> </span><span class="nx">port</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">net</span><span class="p">.</span><span class="nx">SplitHostPort</span><span class="p">(</span><span class="s">&quot;1:8&quot;</span><span class="p">)</span>
<span class="nx">require</span><span class="p">.</span><span class="nx">NoError</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;1&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">host</span><span class="p">)</span>
<span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;8&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">port</span><span class="p">)</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// func TestSplitHostPort(t *testing.T)</span>

<span class="nx">tests</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="kd">struct</span><span class="p">{</span>
<span class="w">  </span><span class="nx">give</span><span class="w">     </span><span class="kt">string</span>
<span class="w">  </span><span class="nx">wantHost</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="nx">wantPort</span><span class="w"> </span><span class="kt">string</span>
<span class="p">}{</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nx">give</span><span class="p">:</span><span class="w">     </span><span class="s">&quot;192.0.2.0:8000&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">wantHost</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;192.0.2.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">wantPort</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;8000&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nx">give</span><span class="p">:</span><span class="w">     </span><span class="s">&quot;192.0.2.0:http&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">wantHost</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;192.0.2.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">wantPort</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nx">give</span><span class="p">:</span><span class="w">     </span><span class="s">&quot;:8000&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">wantHost</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">wantPort</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;8000&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nx">give</span><span class="p">:</span><span class="w">     </span><span class="s">&quot;1:8&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">wantHost</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">wantPort</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;8&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">}</span>

<span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">tt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">tests</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">tt</span><span class="p">.</span><span class="nx">give</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">host</span><span class="p">,</span><span class="w"> </span><span class="nx">port</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">net</span><span class="p">.</span><span class="nx">SplitHostPort</span><span class="p">(</span><span class="nx">tt</span><span class="p">.</span><span class="nx">give</span><span class="p">)</span>
<span class="w">    </span><span class="nx">require</span><span class="p">.</span><span class="nx">NoError</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">tt</span><span class="p">.</span><span class="nx">wantHost</span><span class="p">,</span><span class="w"> </span><span class="nx">host</span><span class="p">)</span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">tt</span><span class="p">.</span><span class="nx">wantPort</span><span class="p">,</span><span class="w"> </span><span class="nx">port</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>Test tables make it easier to add context to error messages, reduce duplicate
logic, and add new test cases.</p>
<p>We follow the convention that the slice of structs is referred to as <code class="docutils literal notranslate"><span class="pre">tests</span></code>
and each test case <code class="docutils literal notranslate"><span class="pre">tt</span></code>. Further, we encourage explicating the input and output
values for each test case with <code class="docutils literal notranslate"><span class="pre">give</span></code> and <code class="docutils literal notranslate"><span class="pre">want</span></code> prefixes.</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">tests</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="kd">struct</span><span class="p">{</span>
<span class="w">  </span><span class="nx">give</span><span class="w">     </span><span class="kt">string</span>
<span class="w">  </span><span class="nx">wantHost</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="nx">wantPort</span><span class="w"> </span><span class="kt">string</span>
<span class="p">}{</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>

<span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">tt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">tests</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<section id="avoid-unnecessary-complexity-in-table-tests">
<h4><span class="section-number">4.1.5.1.1. </span>Avoid Unnecessary Complexity in Table Tests<a class="headerlink" href="#avoid-unnecessary-complexity-in-table-tests" title="Permalink to this heading"></a></h4>
<p>Table tests can be difficult to read and maintain if the subtests contain conditional
assertions or other branching logic. Table tests should <strong>NOT</strong> be used whenever
there needs to be complex or conditional logic inside subtests (i.e. complex logic inside the <code class="docutils literal notranslate"><span class="pre">for</span></code> loop).</p>
<p>Large, complex table tests harm readability and maintainability because test readers may
have difficulty debugging test failures that occur.</p>
<p>Table tests like this should be split into either multiple test tables or multiple
individual <code class="docutils literal notranslate"><span class="pre">Test...</span></code> functions.</p>
<p>Some ideals to aim for are:</p>
<ul class="simple">
<li><p>Focus on the narrowest unit of behavior</p></li>
<li><p>Minimize “test depth”, and avoid conditional assertions (see below)</p></li>
<li><p>Ensure that all table fields are used in all tests</p></li>
<li><p>Ensure that all test logic runs for all table cases</p></li>
</ul>
<p>In this context, “test depth” means “within a given test, the number of
successive assertions that require previous assertions to hold” (similar
to cyclomatic complexity).
Having “shallower” tests means that there are fewer relationships between
assertions and, more importantly, that those assertions are less likely
to be conditional by default.</p>
<p>Concretely, table tests can become confusing and difficult to read if they use multiple branching
pathways (e.g. <code class="docutils literal notranslate"><span class="pre">shouldError</span></code>, <code class="docutils literal notranslate"><span class="pre">expectCall</span></code>, etc.), use many <code class="docutils literal notranslate"><span class="pre">if</span></code> statements for
specific mock expectations (e.g. <code class="docutils literal notranslate"><span class="pre">shouldCallFoo</span></code>), or place functions inside the
table (e.g. <code class="docutils literal notranslate"><span class="pre">setupMocks</span> <span class="pre">func(*FooMock)</span></code>).</p>
<p>However, when testing behavior that only
changes based on changed input, it may be preferable to group similar cases
together in a table test to better illustrate how behavior changes across all inputs,
rather than splitting otherwise comparable units into separate tests
and making them harder to compare and contrast.</p>
<p>If the test body is short and straightforward,
it’s acceptable to have a single branching pathway for success versus failure cases
with a table field like <code class="docutils literal notranslate"><span class="pre">shouldErr</span></code> to specify error expectations.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">TestComplicatedTable</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">tests</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">give</span><span class="w">          </span><span class="kt">string</span>
<span class="w">    </span><span class="nx">want</span><span class="w">          </span><span class="kt">string</span>
<span class="w">    </span><span class="nx">wantErr</span><span class="w">       </span><span class="kt">error</span>
<span class="w">    </span><span class="nx">shouldCallX</span><span class="w">   </span><span class="kt">bool</span>
<span class="w">    </span><span class="nx">shouldCallY</span><span class="w">   </span><span class="kt">bool</span>
<span class="w">    </span><span class="nx">giveXResponse</span><span class="w"> </span><span class="kt">string</span>
<span class="w">    </span><span class="nx">giveXErr</span><span class="w">      </span><span class="kt">error</span>
<span class="w">    </span><span class="nx">giveYResponse</span><span class="w"> </span><span class="kt">string</span>
<span class="w">    </span><span class="nx">giveYErr</span><span class="w">      </span><span class="kt">error</span>
<span class="w">  </span><span class="p">}{</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">tt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">tests</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">tt</span><span class="p">.</span><span class="nx">give</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// setup mocks</span>
<span class="w">      </span><span class="nx">ctrl</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">gomock</span><span class="p">.</span><span class="nx">NewController</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
<span class="w">      </span><span class="nx">xMock</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">xmock</span><span class="p">.</span><span class="nx">NewMockX</span><span class="p">(</span><span class="nx">ctrl</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="nx">tt</span><span class="p">.</span><span class="nx">shouldCallX</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">xMock</span><span class="p">.</span><span class="nx">EXPECT</span><span class="p">().</span><span class="nx">Call</span><span class="p">().</span><span class="nx">Return</span><span class="p">(</span>
<span class="w">          </span><span class="nx">tt</span><span class="p">.</span><span class="nx">giveXResponse</span><span class="p">,</span><span class="w"> </span><span class="nx">tt</span><span class="p">.</span><span class="nx">giveXErr</span><span class="p">,</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="nx">yMock</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ymock</span><span class="p">.</span><span class="nx">NewMockY</span><span class="p">(</span><span class="nx">ctrl</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="nx">tt</span><span class="p">.</span><span class="nx">shouldCallY</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">yMock</span><span class="p">.</span><span class="nx">EXPECT</span><span class="p">().</span><span class="nx">Call</span><span class="p">().</span><span class="nx">Return</span><span class="p">(</span>
<span class="w">          </span><span class="nx">tt</span><span class="p">.</span><span class="nx">giveYResponse</span><span class="p">,</span><span class="w"> </span><span class="nx">tt</span><span class="p">.</span><span class="nx">giveYErr</span><span class="p">,</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="nx">got</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">DoComplexThing</span><span class="p">(</span><span class="nx">tt</span><span class="p">.</span><span class="nx">give</span><span class="p">,</span><span class="w"> </span><span class="nx">xMock</span><span class="p">,</span><span class="w"> </span><span class="nx">yMock</span><span class="p">)</span>

<span class="w">      </span><span class="c1">// verify results</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="nx">tt</span><span class="p">.</span><span class="nx">wantErr</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">require</span><span class="p">.</span><span class="nx">EqualError</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">tt</span><span class="p">.</span><span class="nx">wantErr</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="nx">require</span><span class="p">.</span><span class="nx">NoError</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">      </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">want</span><span class="p">,</span><span class="w"> </span><span class="nx">got</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">TestShouldCallX</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// setup mocks</span>
<span class="w">  </span><span class="nx">ctrl</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">gomock</span><span class="p">.</span><span class="nx">NewController</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
<span class="w">  </span><span class="nx">xMock</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">xmock</span><span class="p">.</span><span class="nx">NewMockX</span><span class="p">(</span><span class="nx">ctrl</span><span class="p">)</span>
<span class="w">  </span><span class="nx">xMock</span><span class="p">.</span><span class="nx">EXPECT</span><span class="p">().</span><span class="nx">Call</span><span class="p">().</span><span class="nx">Return</span><span class="p">(</span><span class="s">&quot;XResponse&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="p">)</span>

<span class="w">  </span><span class="nx">yMock</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ymock</span><span class="p">.</span><span class="nx">NewMockY</span><span class="p">(</span><span class="nx">ctrl</span><span class="p">)</span>

<span class="w">  </span><span class="nx">got</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">DoComplexThing</span><span class="p">(</span><span class="s">&quot;inputX&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">xMock</span><span class="p">,</span><span class="w"> </span><span class="nx">yMock</span><span class="p">)</span>

<span class="w">  </span><span class="nx">require</span><span class="p">.</span><span class="nx">NoError</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">  </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;want&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">got</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">TestShouldCallYAndFail</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// setup mocks</span>
<span class="w">  </span><span class="nx">ctrl</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">gomock</span><span class="p">.</span><span class="nx">NewController</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
<span class="w">  </span><span class="nx">xMock</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">xmock</span><span class="p">.</span><span class="nx">NewMockX</span><span class="p">(</span><span class="nx">ctrl</span><span class="p">)</span>

<span class="w">  </span><span class="nx">yMock</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ymock</span><span class="p">.</span><span class="nx">NewMockY</span><span class="p">(</span><span class="nx">ctrl</span><span class="p">)</span>
<span class="w">  </span><span class="nx">yMock</span><span class="p">.</span><span class="nx">EXPECT</span><span class="p">().</span><span class="nx">Call</span><span class="p">().</span><span class="nx">Return</span><span class="p">(</span><span class="s">&quot;YResponse&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="p">)</span>

<span class="w">  </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">DoComplexThing</span><span class="p">(</span><span class="s">&quot;inputY&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">xMock</span><span class="p">,</span><span class="w"> </span><span class="nx">yMock</span><span class="p">)</span>
<span class="w">  </span><span class="nx">assert</span><span class="p">.</span><span class="nx">EqualError</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Y failed&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>This complexity makes it more difficult to change, understand, and prove the
correctness of the test.</p>
<p>While there are no strict guidelines, readability and maintainability should
always be top-of-mind when deciding between Table Tests versus separate tests
for multiple inputs/outputs to a system.</p>
</section>
<section id="parallel-tests">
<h4><span class="section-number">4.1.5.1.2. </span>Parallel Tests<a class="headerlink" href="#parallel-tests" title="Permalink to this heading"></a></h4>
<p>Parallel tests, like some specialized loops (for example, those that spawn
goroutines or capture references as part of the loop body),
must take care to explicitly assign loop variables within the loop’s scope to
ensure that they hold the expected values.</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">tests</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="kd">struct</span><span class="p">{</span>
<span class="w">  </span><span class="nx">give</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}{</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>

<span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">tt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">tests</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">tt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">tt</span><span class="w"> </span><span class="c1">// for t.Parallel</span>
<span class="w">  </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">tt</span><span class="p">.</span><span class="nx">give</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Parallel</span><span class="p">()</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the example above, we must declare a <code class="docutils literal notranslate"><span class="pre">tt</span></code> variable scoped to the loop
iteration because of the use of <code class="docutils literal notranslate"><span class="pre">t.Parallel()</span></code> below.
If we do not do that, most or all tests will receive an unexpected value for
<code class="docutils literal notranslate"><span class="pre">tt</span></code>, or a value that changes as they’re running.</p>
<!-- TODO: Explain how to use _test packages. --></section>
</section>
<section id="functional-options">
<h3><span class="section-number">4.1.5.2. </span>Functional Options<a class="headerlink" href="#functional-options" title="Permalink to this heading"></a></h3>
<p>Functional options is a pattern in which you declare an opaque <code class="docutils literal notranslate"><span class="pre">Option</span></code> type
that records information in some internal struct. You accept a variadic number
of these options and act upon the full information recorded by the options on
the internal struct.</p>
<p>Use this pattern for optional arguments in constructors and other public APIs
that you foresee needing to expand, especially if you already have three or
more arguments on those functions.</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// package db</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">Open</span><span class="p">(</span>
<span class="w">  </span><span class="nx">addr</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">  </span><span class="nx">cache</span><span class="w"> </span><span class="kt">bool</span><span class="p">,</span>
<span class="w">  </span><span class="nx">logger</span><span class="w"> </span><span class="o">*</span><span class="nx">zap</span><span class="p">.</span><span class="nx">Logger</span>
<span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">Connection</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// package db</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">Option</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">WithCache</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="nx">Option</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">WithLogger</span><span class="p">(</span><span class="nx">log</span><span class="w"> </span><span class="o">*</span><span class="nx">zap</span><span class="p">.</span><span class="nx">Logger</span><span class="p">)</span><span class="w"> </span><span class="nx">Option</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>

<span class="c1">// Open creates a connection.</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">Open</span><span class="p">(</span>
<span class="w">  </span><span class="nx">addr</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">  </span><span class="nx">opts</span><span class="w"> </span><span class="o">...</span><span class="nx">Option</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">Connection</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
<tr><td><p>The cache and logger parameters must always be provided, even if the user
wants to use the default.</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">db</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">DefaultCache</span><span class="p">,</span><span class="w"> </span><span class="nx">zap</span><span class="p">.</span><span class="nx">NewNop</span><span class="p">())</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">DefaultCache</span><span class="p">,</span><span class="w"> </span><span class="nx">log</span><span class="p">)</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="cm">/* cache */</span><span class="p">,</span><span class="w"> </span><span class="nx">zap</span><span class="p">.</span><span class="nx">NewNop</span><span class="p">())</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="cm">/* cache */</span><span class="p">,</span><span class="w"> </span><span class="nx">log</span><span class="p">)</span>
</pre></div>
</div>
</td><td><p>Options are provided only if needed.</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">db</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">WithLogger</span><span class="p">(</span><span class="nx">log</span><span class="p">))</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">WithCache</span><span class="p">(</span><span class="kc">false</span><span class="p">))</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span>
<span class="w">  </span><span class="nx">addr</span><span class="p">,</span>
<span class="w">  </span><span class="nx">db</span><span class="p">.</span><span class="nx">WithCache</span><span class="p">(</span><span class="kc">false</span><span class="p">),</span>
<span class="w">  </span><span class="nx">db</span><span class="p">.</span><span class="nx">WithLogger</span><span class="p">(</span><span class="nx">log</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>Our suggested way of implementing this pattern is with an <code class="docutils literal notranslate"><span class="pre">Option</span></code> interface
that holds an unexported method, recording options on an unexported <code class="docutils literal notranslate"><span class="pre">options</span></code>
struct.</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">cache</span><span class="w">  </span><span class="kt">bool</span>
<span class="w">  </span><span class="nx">logger</span><span class="w"> </span><span class="o">*</span><span class="nx">zap</span><span class="p">.</span><span class="nx">Logger</span>
<span class="p">}</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">Option</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">apply</span><span class="p">(</span><span class="o">*</span><span class="nx">options</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">cacheOption</span><span class="w"> </span><span class="kt">bool</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="nx">cacheOption</span><span class="p">)</span><span class="w"> </span><span class="nx">apply</span><span class="p">(</span><span class="nx">opts</span><span class="w"> </span><span class="o">*</span><span class="nx">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">opts</span><span class="p">.</span><span class="nx">cache</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">bool</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">WithCache</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="nx">Option</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">cacheOption</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">loggerOption</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">Log</span><span class="w"> </span><span class="o">*</span><span class="nx">zap</span><span class="p">.</span><span class="nx">Logger</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">l</span><span class="w"> </span><span class="nx">loggerOption</span><span class="p">)</span><span class="w"> </span><span class="nx">apply</span><span class="p">(</span><span class="nx">opts</span><span class="w"> </span><span class="o">*</span><span class="nx">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">opts</span><span class="p">.</span><span class="nx">logger</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">l</span><span class="p">.</span><span class="nx">Log</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">WithLogger</span><span class="p">(</span><span class="nx">log</span><span class="w"> </span><span class="o">*</span><span class="nx">zap</span><span class="p">.</span><span class="nx">Logger</span><span class="p">)</span><span class="w"> </span><span class="nx">Option</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">loggerOption</span><span class="p">{</span><span class="nx">Log</span><span class="p">:</span><span class="w"> </span><span class="nx">log</span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Open creates a connection.</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">Open</span><span class="p">(</span>
<span class="w">  </span><span class="nx">addr</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">  </span><span class="nx">opts</span><span class="w"> </span><span class="o">...</span><span class="nx">Option</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">Connection</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">options</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">options</span><span class="p">{</span>
<span class="w">    </span><span class="nx">cache</span><span class="p">:</span><span class="w">  </span><span class="nx">defaultCache</span><span class="p">,</span>
<span class="w">    </span><span class="nx">logger</span><span class="p">:</span><span class="w"> </span><span class="nx">zap</span><span class="p">.</span><span class="nx">NewNop</span><span class="p">(),</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">o</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">opts</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">o</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">options</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that there’s a method of implementing this pattern with closures but we
believe that the pattern above provides more flexibility for authors and is
easier to debug and test for users. In particular, it allows options to be
compared against each other in tests and mocks, versus closures where this is
impossible. Further, it lets options implement other interfaces, including
<code class="docutils literal notranslate"><span class="pre">fmt.Stringer</span></code> which allows for user-readable string representations of the
options.</p>
<p>See also,</p>
<ul class="simple">
<li><p><a class="reference external" href="https://commandcenter.blogspot.com/2014/01/self-referential-functions-and-design.html">Self-referential functions and the design of options</a></p></li>
<li><p><a class="reference external" href="https://dave.cheney.net/2014/10/17/functional-options-for-friendly-apis">Functional options for friendly APIs</a></p></li>
</ul>
<!-- TODO: replace this with parameter structs and functional options, when to
use one vs other --></section>
</section>
<section id="linting">
<h2><span class="section-number">4.1.6. </span>Linting<a class="headerlink" href="#linting" title="Permalink to this heading"></a></h2>
<p>More importantly than any “blessed” set of linters, lint consistently across a
codebase.</p>
<p>We recommend using the following linters at a minimum, because we feel that they
help to catch the most common issues and also establish a high bar for code
quality without being unnecessarily prescriptive:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/kisielk/errcheck">errcheck</a> to ensure that errors are handled</p></li>
<li><p><a class="reference external" href="https://pkg.go.dev/golang.org/x/tools/cmd/goimports">goimports</a> to format code and manage imports</p></li>
<li><p><a class="reference external" href="https://github.com/golang/lint">golint</a> to point out common style mistakes</p></li>
<li><p><a class="reference external" href="https://pkg.go.dev/cmd/vet">govet</a> to analyze code for common mistakes</p></li>
<li><p><a class="reference external" href="https://staticcheck.dev">staticcheck</a> to do various static analysis checks</p></li>
</ul>
<section id="lint-runners">
<h3><span class="section-number">4.1.6.1. </span>Lint Runners<a class="headerlink" href="#lint-runners" title="Permalink to this heading"></a></h3>
<p>We recommend <a class="reference external" href="https://github.com/golangci/golangci-lint">golangci-lint</a> as the go-to lint runner for Go code, largely due
to its performance in larger codebases and ability to configure and use many
canonical linters at once. This repo has an example <a class="reference external" href="https://github.com/uber-go/guide/blob/master/.golangci.yml">.golangci.yml</a> config file
with recommended linters and settings.</p>
<p>golangci-lint has <a class="reference external" href="https://golangci-lint.run/usage/linters/">various linters</a> available for use. The above linters are
recommended as a base set, and we encourage teams to add any additional linters
that make sense for their projects.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="页脚">
        <a href="../index.html" class="btn btn-neutral float-left" title="4. 编程语言 风格指南" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="../uber_go_cn/index.html" class="btn btn-neutral float-right" title="4.2. Uber: Go语言 风格指南" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2024.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
  
<div class="view_counter">
      <img class="img_view_counter" src="https://s01.flagcounter.com/count2/m02K/bg_FFFFFF/txt_F77B1B/border_CCCCCC/columns_3/maxflags_6/viewers_3/labels_1/pageviews_0/flags_0/percent_0/" alt="View Counter" border="0" />
</div>


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="版本">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Read the Docs</span>
        v: latest
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>版本</dt>
            <dd><a href="#">latest</a></dd>
        </dl>
    </div>
</div>

</body>
</html>