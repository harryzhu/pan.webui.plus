<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>4.2.1. English &mdash; AI 模型国内加速  文档</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/style.css" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/translations.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="author" title="关于这些文档" href="../../about.html" />
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="4.3. Google: Python 风格指南" href="../google-python-styleguide/contents.html" />
    <link rel="prev" title="4.2. Uber: Go语言 风格指南" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            AI 模型国内加速
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" aria-label="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">目录:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../best-practice/index.html">1. 【AI网盘】人工智能资源汇总</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../stable-diffusion/index.html">2. Stable Diffusion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pytorch-guides/index.html">3. Pytorch 教程</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">4. 编程语言 风格指南</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../uber_go/uber_go_style_en.html">4.1. Uber: Go Style Guide - English</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">4.2. Uber: Go语言 风格指南</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">4.2.1. English</a></li>
<li class="toctree-l3"><a class="reference internal" href="#uber-go">4.2.2. Uber Go 语言编码规范</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id1">4.2.3. 版本</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">4.2.4. 目录</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">4.2.5. 介绍</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">4.2.6. 指导原则</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#interface">4.2.6.1. 指向 interface 的指针</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">4.2.6.2. Interface 合理性验证</a></li>
<li class="toctree-l4"><a class="reference internal" href="#receiver">4.2.6.3. 接收器 (receiver) 与接口</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mutex">4.2.6.4. 零值 Mutex 是有效的</a></li>
<li class="toctree-l4"><a class="reference internal" href="#slices-maps">4.2.6.5. 在边界处拷贝 Slices 和 Maps</a></li>
<li class="toctree-l4"><a class="reference internal" href="#defer">4.2.6.6. 使用 defer 释放资源</a></li>
<li class="toctree-l4"><a class="reference internal" href="#channel-size-1">4.2.6.7. Channel 的 size 要么是 1，要么是无缓冲的</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">4.2.6.8. 枚举从 1 开始</a></li>
<li class="toctree-l4"><a class="reference internal" href="#time">4.2.6.9. 使用 time 处理时间</a></li>
<li class="toctree-l4"><a class="reference internal" href="#errors">4.2.6.10. Errors</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id13">4.2.6.11. 处理断言失败</a></li>
<li class="toctree-l4"><a class="reference internal" href="#panic">4.2.6.12. 不要使用 panic</a></li>
<li class="toctree-l4"><a class="reference internal" href="#go-uber-org-atomic">4.2.6.13. 使用 go.uber.org/atomic</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id14">4.2.6.14. 避免可变全局变量</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id15">4.2.6.15. 避免在公共结构中嵌入类型</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id16">4.2.6.16. 避免使用内置名称</a></li>
<li class="toctree-l4"><a class="reference internal" href="#init">4.2.6.17. 避免使用 <code class="docutils literal notranslate"><span class="pre">init()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#id17">4.2.6.18. 追加时优先指定切片容量</a></li>
<li class="toctree-l4"><a class="reference internal" href="#exit">4.2.6.19. 主函数退出方式 (Exit)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id19">4.2.6.20. 在序列化结构中使用字段标记</a></li>
<li class="toctree-l4"><a class="reference internal" href="#goroutine">4.2.6.21. 不要一劳永逸地使用 goroutine</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id20">4.2.7. 性能</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#strconv-fmt">4.2.7.1. 优先使用 strconv 而不是 fmt</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id21">4.2.7.2. 避免字符串到字节的转换</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id22">4.2.7.3. 指定容器容量</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id24">4.2.8. 规范</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id25">4.2.8.1. 避免过长的行</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id26">4.2.8.2. 一致性</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id27">4.2.8.3. 相似的声明放在一组</a></li>
<li class="toctree-l4"><a class="reference internal" href="#import">4.2.8.4. import 分组</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id28">4.2.8.5. 包名</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id29">4.2.8.6. 函数名</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id30">4.2.8.7. 导入别名</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id31">4.2.8.8. 函数分组与顺序</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id32">4.2.8.9. 减少嵌套</a></li>
<li class="toctree-l4"><a class="reference internal" href="#else">4.2.8.10. 不必要的 else</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id33">4.2.8.11. 顶层变量声明</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id34">4.2.8.12. 对于未导出的顶层常量和变量，使用_作为前缀</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id35">4.2.8.13. 结构体中的嵌入</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id36">4.2.8.14. 本地变量声明</a></li>
<li class="toctree-l4"><a class="reference internal" href="#nil-slice">4.2.8.15. nil 是一个有效的 slice</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id37">4.2.8.16. 缩小变量作用域</a></li>
<li class="toctree-l4"><a class="reference internal" href="#avoid-naked-parameters">4.2.8.17. 避免参数语义不明确 (Avoid Naked Parameters)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id38">4.2.8.18. 使用原始字符串字面值，避免转义</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id39">4.2.8.19. 初始化结构体</a></li>
<li class="toctree-l4"><a class="reference internal" href="#maps">4.2.8.20. 初始化 Maps</a></li>
<li class="toctree-l4"><a class="reference internal" href="#string-format">4.2.8.21. 字符串 string format</a></li>
<li class="toctree-l4"><a class="reference internal" href="#printf">4.2.8.22. 命名 Printf 样式的函数</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id42">4.2.9. 编程模式</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id43">4.2.9.1. 表驱动测试</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id44">4.2.9.2. 功能选项</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#linting">4.2.10. Linting</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#lint-runners">4.2.10.1. Lint Runners</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../google-python-styleguide/contents.html">4.3. Google: Python 风格指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../google-shell-styleguide/contents.html">4.4. Google: Shell 风格指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../google-typescript-styleguide/contents.html">4.5. Google: TypeScript 风格指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../google-javascript-styleguide/contents.html">4.6. Google: Javascript 风格指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../google-html-css-styleguide/contents.html">4.7. Google: HTML/CSS 风格指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../google-cpp-styleguide/contents.html">4.8. Google: C++ 风格指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../google-objc-styleguide/contents.html">4.9. Google: Objective-C 风格指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../google-java-styleguide/contents.html">4.10. Google: Java 风格指南</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../coding/index.html">5. 编程语言 语法</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cheatsheet/index.html">6. Cheat Sheet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">7. 关于</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">AI 模型国内加速</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html"><span class="section-number">4. </span>编程语言 风格指南</a></li>
          <li class="breadcrumb-item"><a href="index.html"><span class="section-number">4.2. </span>Uber: Go语言 风格指南</a></li>
      <li class="breadcrumb-item active"><span class="section-number">4.2.1. </span>English</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/style-guides/uber_go_cn/uber_go_cn.md.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <!--

Editing this document:

- Discuss all changes in GitHub issues first.
- Update the table of contents as new sections are added or removed.
- Use tables for side-by-side code samples. See below.

Code Samples:

Use 2 spaces to indent. Horizontal real estate is important in side-by-side
samples.

For side-by-side code samples, use the following snippet.

~~~
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td>

```go
BAD CODE GOES HERE
```

</td><td>

```go
GOOD CODE GOES HERE
```

</td></tr>
</tbody></table>
~~~

(You need the empty lines between the <td> and code samples for it to be
treated as Markdown.)

If you need to add labels or descriptions below the code samples, add another
row before the </tbody></table> line.

~~~
<tr>
<td>DESCRIBE BAD CODE</td>
<td>DESCRIBE GOOD CODE</td>
</tr>
~~~



--><!--
change.md

# 2019-12-17
- 函数选项：推荐 “Option” 接口的结构实现
- 而不是用闭包捕获值。

# 2019-11-26
- 添加针对全局变量变异的指导。

# 2020-01-11
- 为`open（..）`调用添加缺少的参数。

# 2020-02-03
- 使用 `"time"` 处理时间的建议
- 添加有关在公共结构中嵌入类型的指导。

# 2020-02-25
- 添加有关接口验证是否符合编译时检查的指导。

# 2020-06-05
- 添加避免使用内置名称的指导意见

# 2020-06-10
- 添加 init() 指导意见

# 2020-06-16
- 追加时优先指定切片容量
- 添加有关指针接收器可调用性的说明

# 2020-06-17
- map 和切片的联合指导

# 2020-09-15
- Remove main panic

# 2021-03-17
- 结构体初始化

# 2021-04-19
- 程序只能在`main()`中退出，最好最多退出一次

# 2021-11-16

- 添加有关将 `%w` 与 `%v` 与 `fmt.Errorf` 结合使用的指南，以及在何处使用 `errors.New` 或自定义错误类型。

# 2022-01-05
- 修复翻译错误
- 修复部分失效的链接

# 2022-03-30

- 添加有关在封送结构中使用字段标记的指导。
- 
# 2022-10-18

- 管理goroutine生命周期的指导.

# 2023-04-13
- Errors: 只添加一次错误处理指南
--><section id="english">
<h1><span class="section-number">4.2.1. </span><a class="reference external" href="https://github.com/uber-go/guide/blob/master/style.md">English</a><a class="headerlink" href="#english" title="Permalink to this heading"></a></h1>
</section>
<section id="uber-go">
<h1><span class="section-number">4.2.2. </span>Uber Go 语言编码规范<a class="headerlink" href="#uber-go" title="Permalink to this heading"></a></h1>
<p><a class="reference external" href="https://www.uber.com/">Uber</a> 是一家美国硅谷的科技公司，也是 Go 语言的早期 adopter。其开源了很多 golang 项目，诸如被 Gopher 圈熟知的 <a class="reference external" href="https://github.com/uber-go/zap">zap</a>、<a class="reference external" href="https://github.com/jaegertracing/jaeger">jaeger</a> 等。2018 年年末 Uber 将内部的 <a class="reference external" href="https://github.com/uber-go/guide">Go 风格规范</a> 开源到 GitHub，经过一年的积累和更新，该规范已经初具规模，并受到广大 Gopher 的关注。本文是该规范的中文版本。本版本会根据原版实时更新。</p>
</section>
<section id="id1">
<h1><span class="section-number">4.2.3. </span>版本<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h1>
<ul class="simple">
<li><p>当前更新版本：2024-08-10 版本地址：<a class="reference external" href="https://github.com/uber-go/guide/commit/a66b53bed4ec57c695992b14c4ccaafd49bd5296">commit:#217</a></p></li>
<li><p>如果您发现任何更新、问题或改进，请随时 fork 和 PR</p></li>
<li><p>Please feel free to fork and PR if you find any updates, issues or improvement.</p></li>
</ul>
</section>
<section id="id2">
<h1><span class="section-number">4.2.4. </span>目录<a class="headerlink" href="#id2" title="Permalink to this heading"></a></h1>
<ul class="simple">
<li><p><a class="reference external" href="#uber-goguide-%E7%9A%84%E4%B8%AD%E6%96%87%E7%BF%BB%E8%AF%91">uber-go/guide 的中文翻译</a></p></li>
<li><p><a class="reference external" href="#english">English</a></p></li>
<li><p><a class="reference external" href="#uber-go-%E8%AF%AD%E8%A8%80%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83">Uber Go 语言编码规范</a></p></li>
<li><p><a class="reference external" href="#%E7%89%88%E6%9C%AC">版本</a></p></li>
<li><p><a class="reference external" href="#%E7%9B%AE%E5%BD%95">目录</a></p></li>
<li><p><a class="reference external" href="#%E4%BB%8B%E7%BB%8D">介绍</a></p></li>
<li><p><a class="reference external" href="#%E6%8C%87%E5%AF%BC%E5%8E%9F%E5%88%99">指导原则</a></p>
<ul>
<li><p><a class="reference external" href="#%E6%8C%87%E5%90%91-interface-%E7%9A%84%E6%8C%87%E9%92%88">指向 interface 的指针</a></p></li>
<li><p><a class="reference external" href="#interface-%E5%90%88%E7%90%86%E6%80%A7%E9%AA%8C%E8%AF%81">Interface 合理性验证</a></p></li>
<li><p><a class="reference external" href="#%E6%8E%A5%E6%94%B6%E5%99%A8-receiver-%E4%B8%8E%E6%8E%A5%E5%8F%A3">接收器 (receiver) 与接口</a></p></li>
<li><p><a class="reference external" href="#%E9%9B%B6%E5%80%BC-mutex-%E6%98%AF%E6%9C%89%E6%95%88%E7%9A%84">零值 Mutex 是有效的</a></p></li>
<li><p><a class="reference external" href="#%E5%9C%A8%E8%BE%B9%E7%95%8C%E5%A4%84%E6%8B%B7%E8%B4%9D-slices-%E5%92%8C-maps">在边界处拷贝 Slices 和 Maps</a></p>
<ul>
<li><p><a class="reference external" href="#%E6%8E%A5%E6%94%B6-slices-%E5%92%8C-maps">接收 Slices 和 Maps</a></p></li>
<li><p><a class="reference external" href="#%E8%BF%94%E5%9B%9E-slices-%E6%88%96-maps">返回 slices 或 maps</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#%E4%BD%BF%E7%94%A8-defer-%E9%87%8A%E6%94%BE%E8%B5%84%E6%BA%90">使用 defer 释放资源</a></p></li>
<li><p><a class="reference external" href="#channel-%E7%9A%84-size-%E8%A6%81%E4%B9%88%E6%98%AF-1%E8%A6%81%E4%B9%88%E6%98%AF%E6%97%A0%E7%BC%93%E5%86%B2%E7%9A%84">Channel 的 size 要么是 1，要么是无缓冲的</a></p></li>
<li><p><a class="reference external" href="#%E6%9E%9A%E4%B8%BE%E4%BB%8E-1-%E5%BC%80%E5%A7%8B">枚举从 1 开始</a></p></li>
<li><p><a class="reference external" href="#%E4%BD%BF%E7%94%A8-time-%E5%A4%84%E7%90%86%E6%97%B6%E9%97%B4">使用 time 处理时间</a></p>
<ul>
<li><p><a class="reference external" href="#%E4%BD%BF%E7%94%A8-timetime-%E8%A1%A8%E8%BE%BE%E7%9E%AC%E6%97%B6%E6%97%B6%E9%97%B4">使用 <code class="docutils literal notranslate"><span class="pre">time.Time</span></code> 表达瞬时时间</a></p></li>
<li><p><a class="reference external" href="#%E4%BD%BF%E7%94%A8-timeduration-%E8%A1%A8%E8%BE%BE%E6%97%B6%E9%97%B4%E6%AE%B5">使用 <code class="docutils literal notranslate"><span class="pre">time.Duration</span></code> 表达时间段</a></p></li>
<li><p><a class="reference external" href="#%E5%AF%B9%E5%A4%96%E9%83%A8%E7%B3%BB%E7%BB%9F%E4%BD%BF%E7%94%A8-timetime-%E5%92%8C-timeduration">对外部系统使用 <code class="docutils literal notranslate"><span class="pre">time.Time</span></code> 和 <code class="docutils literal notranslate"><span class="pre">time.Duration</span></code></a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#errors">Errors</a></p>
<ul>
<li><p><a class="reference external" href="#%E9%94%99%E8%AF%AF%E7%B1%BB%E5%9E%8B">错误类型</a></p></li>
<li><p><a class="reference external" href="#%E9%94%99%E8%AF%AF%E5%8C%85%E8%A3%85">错误包装</a></p></li>
<li><p><a class="reference external" href="#%E9%94%99%E8%AF%AF%E5%91%BD%E5%90%8D">错误命名</a></p></li>
<li><p><a class="reference external" href="#%E4%B8%80%E6%AC%A1%E5%A4%84%E7%90%86%E9%94%99%E8%AF%AF">一次处理错误</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#%E5%A4%84%E7%90%86%E6%96%AD%E8%A8%80%E5%A4%B1%E8%B4%A5">处理断言失败</a></p></li>
<li><p><a class="reference external" href="#%E4%B8%8D%E8%A6%81%E4%BD%BF%E7%94%A8-panic">不要使用 panic</a></p></li>
<li><p><a class="reference external" href="#%E4%BD%BF%E7%94%A8-gouberorgatomic">使用 go.uber.org/atomic</a></p></li>
<li><p><a class="reference external" href="#%E9%81%BF%E5%85%8D%E5%8F%AF%E5%8F%98%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F">避免可变全局变量</a></p></li>
<li><p><a class="reference external" href="#%E9%81%BF%E5%85%8D%E5%9C%A8%E5%85%AC%E5%85%B1%E7%BB%93%E6%9E%84%E4%B8%AD%E5%B5%8C%E5%85%A5%E7%B1%BB%E5%9E%8B">避免在公共结构中嵌入类型</a></p></li>
<li><p><a class="reference external" href="#%E9%81%BF%E5%85%8D%E4%BD%BF%E7%94%A8%E5%86%85%E7%BD%AE%E5%90%8D%E7%A7%B0">避免使用内置名称</a></p></li>
<li><p><a class="reference external" href="#%E9%81%BF%E5%85%8D%E4%BD%BF%E7%94%A8-init">避免使用 <code class="docutils literal notranslate"><span class="pre">init()</span></code></a></p></li>
<li><p><a class="reference external" href="#%E8%BF%BD%E5%8A%A0%E6%97%B6%E4%BC%98%E5%85%88%E6%8C%87%E5%AE%9A%E5%88%87%E7%89%87%E5%AE%B9%E9%87%8F">追加时优先指定切片容量</a></p></li>
<li><p><a class="reference external" href="#%E4%B8%BB%E5%87%BD%E6%95%B0%E9%80%80%E5%87%BA%E6%96%B9%E5%BC%8F-exit">主函数退出方式 (Exit)</a></p>
<ul>
<li><p><a class="reference external" href="#%E4%B8%80%E6%AC%A1%E6%80%A7%E9%80%80%E5%87%BA">一次性退出</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#%E5%9C%A8%E5%BA%8F%E5%88%97%E5%8C%96%E7%BB%93%E6%9E%84%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%AD%97%E6%AE%B5%E6%A0%87%E8%AE%B0">在序列化结构中使用字段标记</a></p></li>
<li><p><a class="reference external" href="#%E4%B8%8D%E8%A6%81%E4%B8%80%E5%8A%B3%E6%B0%B8%E9%80%B8%E5%9C%B0%E4%BD%BF%E7%94%A8-goroutine">不要一劳永逸地使用 goroutine</a></p>
<ul>
<li><p><a class="reference external" href="#%E7%AD%89%E5%BE%85-goroutines-%E9%80%80%E5%87%BA">等待 goroutines 退出</a></p></li>
<li><p><a class="reference external" href="#%E4%B8%8D%E8%A6%81%E5%9C%A8-init-%E4%BD%BF%E7%94%A8-goroutines">不要在 <code class="docutils literal notranslate"><span class="pre">init()</span></code> 使用 goroutines</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference external" href="#%E6%80%A7%E8%83%BD">性能</a></p>
<ul>
<li><p><a class="reference external" href="#%E4%BC%98%E5%85%88%E4%BD%BF%E7%94%A8-strconv-%E8%80%8C%E4%B8%8D%E6%98%AF-fmt">优先使用 strconv 而不是 fmt</a></p></li>
<li><p><a class="reference external" href="#%E9%81%BF%E5%85%8D%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%88%B0%E5%AD%97%E8%8A%82%E7%9A%84%E8%BD%AC%E6%8D%A2">避免字符串到字节的转换</a></p></li>
<li><p><a class="reference external" href="#%E6%8C%87%E5%AE%9A%E5%AE%B9%E5%99%A8%E5%AE%B9%E9%87%8F">指定容器容量</a></p>
<ul>
<li><p><a class="reference external" href="#%E6%8C%87%E5%AE%9A-map-%E5%AE%B9%E9%87%8F%E6%8F%90%E7%A4%BA">指定 Map 容量提示</a></p></li>
<li><p><a class="reference external" href="#%E6%8C%87%E5%AE%9A%E5%88%87%E7%89%87%E5%AE%B9%E9%87%8F">指定切片容量</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference external" href="#%E8%A7%84%E8%8C%83">规范</a></p>
<ul>
<li><p><a class="reference external" href="#%E9%81%BF%E5%85%8D%E8%BF%87%E9%95%BF%E7%9A%84%E8%A1%8C">避免过长的行</a></p></li>
<li><p><a class="reference external" href="#%E4%B8%80%E8%87%B4%E6%80%A7">一致性</a></p></li>
<li><p><a class="reference external" href="#%E7%9B%B8%E4%BC%BC%E7%9A%84%E5%A3%B0%E6%98%8E%E6%94%BE%E5%9C%A8%E4%B8%80%E7%BB%84">相似的声明放在一组</a></p></li>
<li><p><a class="reference external" href="#import-%E5%88%86%E7%BB%84">import 分组</a></p></li>
<li><p><a class="reference external" href="#%E5%8C%85%E5%90%8D">包名</a></p></li>
<li><p><a class="reference external" href="#%E5%87%BD%E6%95%B0%E5%90%8D">函数名</a></p></li>
<li><p><a class="reference external" href="#%E5%AF%BC%E5%85%A5%E5%88%AB%E5%90%8D">导入别名</a></p></li>
<li><p><a class="reference external" href="#%E5%87%BD%E6%95%B0%E5%88%86%E7%BB%84%E4%B8%8E%E9%A1%BA%E5%BA%8F">函数分组与顺序</a></p></li>
<li><p><a class="reference external" href="#%E5%87%8F%E5%B0%91%E5%B5%8C%E5%A5%97">减少嵌套</a></p></li>
<li><p><a class="reference external" href="#%E4%B8%8D%E5%BF%85%E8%A6%81%E7%9A%84-else">不必要的 else</a></p></li>
<li><p><a class="reference external" href="#%E9%A1%B6%E5%B1%82%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E">顶层变量声明</a></p></li>
<li><p><a class="reference external" href="#%E5%AF%B9%E4%BA%8E%E6%9C%AA%E5%AF%BC%E5%87%BA%E7%9A%84%E9%A1%B6%E5%B1%82%E5%B8%B8%E9%87%8F%E5%92%8C%E5%8F%98%E9%87%8F%E4%BD%BF%E7%94%A8_%E4%BD%9C%E4%B8%BA%E5%89%8D%E7%BC%80">对于未导出的顶层常量和变量，使用_作为前缀</a></p></li>
<li><p><a class="reference external" href="#%E7%BB%93%E6%9E%84%E4%BD%93%E4%B8%AD%E7%9A%84%E5%B5%8C%E5%85%A5">结构体中的嵌入</a></p></li>
<li><p><a class="reference external" href="#%E6%9C%AC%E5%9C%B0%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E">本地变量声明</a></p></li>
<li><p><a class="reference external" href="#nil-%E6%98%AF%E4%B8%80%E4%B8%AA%E6%9C%89%E6%95%88%E7%9A%84-slice">nil 是一个有效的 slice</a></p></li>
<li><p><a class="reference external" href="#%E7%BC%A9%E5%B0%8F%E5%8F%98%E9%87%8F%E4%BD%9C%E7%94%A8%E5%9F%9F">缩小变量作用域</a></p></li>
<li><p><a class="reference external" href="#%E9%81%BF%E5%85%8D%E5%8F%82%E6%95%B0%E8%AF%AD%E4%B9%89%E4%B8%8D%E6%98%8E%E7%A1%AE-avoid-naked-parameters">避免参数语义不明确 (Avoid Naked Parameters)</a></p></li>
<li><p><a class="reference external" href="#%E4%BD%BF%E7%94%A8%E5%8E%9F%E5%A7%8B%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AD%97%E9%9D%A2%E5%80%BC%E9%81%BF%E5%85%8D%E8%BD%AC%E4%B9%89">使用原始字符串字面值，避免转义</a></p></li>
<li><p><a class="reference external" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E7%BB%93%E6%9E%84%E4%BD%93">初始化结构体</a></p>
<ul>
<li><p><a class="reference external" href="#%E4%BD%BF%E7%94%A8%E5%AD%97%E6%AE%B5%E5%90%8D%E5%88%9D%E5%A7%8B%E5%8C%96%E7%BB%93%E6%9E%84">使用字段名初始化结构</a></p></li>
<li><p><a class="reference external" href="#%E7%9C%81%E7%95%A5%E7%BB%93%E6%9E%84%E4%B8%AD%E7%9A%84%E9%9B%B6%E5%80%BC%E5%AD%97%E6%AE%B5">省略结构中的零值字段</a></p></li>
<li><p><a class="reference external" href="#%E5%AF%B9%E9%9B%B6%E5%80%BC%E7%BB%93%E6%9E%84%E4%BD%BF%E7%94%A8-var">对零值结构使用 <code class="docutils literal notranslate"><span class="pre">var</span></code></a></p></li>
<li><p><a class="reference external" href="#%E5%88%9D%E5%A7%8B%E5%8C%96-struct-%E5%BC%95%E7%94%A8">初始化 Struct 引用</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#%E5%88%9D%E5%A7%8B%E5%8C%96-maps">初始化 Maps</a></p></li>
<li><p><a class="reference external" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2-string-format">字符串 string format</a></p></li>
<li><p><a class="reference external" href="#%E5%91%BD%E5%90%8D-printf-%E6%A0%B7%E5%BC%8F%E7%9A%84%E5%87%BD%E6%95%B0">命名 Printf 样式的函数</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#%E7%BC%96%E7%A8%8B%E6%A8%A1%E5%BC%8F">编程模式</a></p>
<ul>
<li><p><a class="reference external" href="#%E8%A1%A8%E9%A9%B1%E5%8A%A8%E6%B5%8B%E8%AF%95">表驱动测试</a></p></li>
<li><p><a class="reference external" href="#%E5%8A%9F%E8%83%BD%E9%80%89%E9%A1%B9">功能选项</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#linting">Linting</a></p>
<ul>
<li><p><a class="reference external" href="#lint-runners">Lint Runners</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#stargazers-over-time">Stargazers over time</a></p></li>
</ul>
</section>
<section id="id3">
<h1><span class="section-number">4.2.5. </span>介绍<a class="headerlink" href="#id3" title="Permalink to this heading"></a></h1>
<p>样式 (style) 是支配我们代码的惯例。术语<code class="docutils literal notranslate"><span class="pre">样式</span></code>有点用词不当，因为这些约定涵盖的范围不限于由 gofmt 替我们处理的源文件格式。</p>
<p>本指南的目的是通过详细描述在 Uber 编写 Go 代码的注意事项来管理这种复杂性。这些规则的存在是为了使代码库易于管理，同时仍然允许工程师更有效地使用 Go 语言功能。</p>
<p>该指南最初由 <a class="reference external" href="https://github.com/prashantv">Prashant Varanasi</a> 和 <a class="reference external" href="https://github.com/nomis52">Simon Newton</a> 编写，目的是使一些同事能快速使用 Go。多年来，该指南已根据其他人的反馈进行了修改。</p>
<p>本文档记录了我们在 Uber 遵循的 Go 代码中的惯用约定。其中许多是 Go 的通用准则，而其他扩展准则依赖于下面外部的指南：</p>
<ol class="simple">
<li><p><a class="reference external" href="https://golang.org/doc/effective_go.html">Effective Go</a></p></li>
<li><p><a class="reference external" href="https://go.dev/wiki/CommonMistakes">Go Common Mistakes</a></p></li>
<li><p><a class="reference external" href="https://go.dev/wiki/CodeReviewComments">Go Code Review Comments</a></p></li>
</ol>
<p>我们的目标是使代码示例能够准确地用于Go的两个发布版本 <a class="reference external" href="https://go.dev/doc/devel/release">releases</a>.</p>
<p>所有代码都应该通过<code class="docutils literal notranslate"><span class="pre">golint</span></code>和<code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">vet</span></code>的检查并无错误。我们建议您将编辑器设置为：</p>
<ul class="simple">
<li><p>保存时运行 <code class="docutils literal notranslate"><span class="pre">goimports</span></code></p></li>
<li><p>运行 <code class="docutils literal notranslate"><span class="pre">golint</span></code> 和 <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">vet</span></code> 检查错误</p></li>
</ul>
<p>您可以在以下 Go 编辑器工具支持页面中找到更为详细的信息：
<a class="reference external" href="https://go.dev/wiki/IDEsAndTextEditorPlugins">https://go.dev/wiki/IDEsAndTextEditorPlugins</a></p>
</section>
<section id="id4">
<h1><span class="section-number">4.2.6. </span>指导原则<a class="headerlink" href="#id4" title="Permalink to this heading"></a></h1>
<section id="interface">
<h2><span class="section-number">4.2.6.1. </span>指向 interface 的指针<a class="headerlink" href="#interface" title="Permalink to this heading"></a></h2>
<p>您几乎不需要指向接口类型的指针。您应该将接口作为值进行传递，在这样的传递过程中，实质上传递的底层数据仍然可以是指针。</p>
<p>接口实质上在底层用两个字段表示：</p>
<ol class="simple">
<li><p>一个指向某些特定类型信息的指针。您可以将其视为”type”。</p></li>
<li><p>数据指针。如果存储的数据是指针，则直接存储。如果存储的数据是一个值，则存储指向该值的指针。</p></li>
</ol>
<p>如果希望接口方法修改基础数据，则必须使用指针传递 (将对象指针赋值给接口变量)。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">F</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">f</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">S1</span><span class="w"> </span><span class="kd">struct</span><span class="p">{}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="nx">S1</span><span class="p">)</span><span class="w"> </span><span class="nx">f</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">S2</span><span class="w"> </span><span class="kd">struct</span><span class="p">{}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">S2</span><span class="p">)</span><span class="w"> </span><span class="nx">f</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>

<span class="c1">// f1.f() 无法修改底层数据</span>
<span class="c1">// f2.f() 可以修改底层数据，给接口变量 f2 赋值时使用的是对象指针</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">f1</span><span class="w"> </span><span class="nx">F</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">S1</span><span class="p">{}</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">f2</span><span class="w"> </span><span class="nx">F</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">S2</span><span class="p">{}</span>
</pre></div>
</div>
<p>永远不要使用指向interface的指针，这个是没有意义的.在go语言中，接口本身就是引用类型，换句话说，接口类型本身就是一个指针。对于我的需求，其实test的参数只要是myinterface就可以了，只需要在传值的时候，传<em>mystruct类型（也只能传</em>mystruct类型）</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">type</span> <span class="n">myinterface</span> <span class="n">interface</span><span class="p">{</span>
	<span class="nb">print</span><span class="p">()</span>
<span class="p">}</span>
<span class="n">func</span> <span class="n">test</span><span class="p">(</span><span class="n">value</span> <span class="o">*</span><span class="n">myinterface</span><span class="p">){</span>
	<span class="o">//</span><span class="n">someting</span> <span class="n">to</span> <span class="n">do</span> <span class="o">...</span>
<span class="p">}</span>

<span class="nb">type</span> <span class="n">mystruct</span> <span class="n">struct</span> <span class="p">{</span>
	<span class="n">i</span> <span class="nb">int</span>
<span class="p">}</span>
<span class="o">//</span><span class="n">实现接口</span>
<span class="n">func</span> <span class="p">(</span><span class="n">this</span> <span class="o">*</span><span class="n">mystruct</span><span class="p">)</span> <span class="nb">print</span><span class="p">(){</span>
	<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
	<span class="n">this</span><span class="o">.</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span>
<span class="p">}</span>
<span class="n">func</span> <span class="n">main</span><span class="p">(){</span>
<span class="n">m</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">mystruct</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span>
<span class="n">test</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="o">//</span><span class="n">错误</span>
<span class="n">test</span><span class="p">(</span><span class="o">*</span><span class="n">m</span><span class="p">)</span><span class="o">//</span><span class="n">错误</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id5">
<h2><span class="section-number">4.2.6.2. </span>Interface 合理性验证<a class="headerlink" href="#id5" title="Permalink to this heading"></a></h2>
<p>在编译时验证接口的符合性。这包括：</p>
<ul class="simple">
<li><p>将实现特定接口的导出类型作为接口 API 的一部分进行检查</p></li>
<li><p>实现同一接口的 (导出和非导出) 类型属于实现类型的集合</p></li>
<li><p>任何违反接口合理性检查的场景，都会终止编译，并通知给用户</p></li>
</ul>
<p>补充：上面 3 条是编译器对接口的检查机制，
大体意思是错误使用接口会在编译期报错。
所以可以利用这个机制让部分问题在编译期暴露。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// 如果 Handler 没有实现 http.Handler，会在运行时报错</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">Handler</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">h</span><span class="w"> </span><span class="o">*</span><span class="nx">Handler</span><span class="p">)</span><span class="w"> </span><span class="nx">ServeHTTP</span><span class="p">(</span>
<span class="w">  </span><span class="nx">w</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span>
<span class="w">  </span><span class="nx">r</span><span class="w"> </span><span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Handler</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
<span class="c1">// 用于触发编译期的接口的合理性检查机制</span>
<span class="c1">// 如果 Handler 没有实现 http.Handler，会在编译期报错</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">Handler</span><span class="p">)(</span><span class="kc">nil</span><span class="p">)</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">h</span><span class="w"> </span><span class="o">*</span><span class="nx">Handler</span><span class="p">)</span><span class="w"> </span><span class="nx">ServeHTTP</span><span class="p">(</span>
<span class="w">  </span><span class="nx">w</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span>
<span class="w">  </span><span class="nx">r</span><span class="w"> </span><span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>如果 <code class="docutils literal notranslate"><span class="pre">*Handler</span></code> 与 <code class="docutils literal notranslate"><span class="pre">http.Handler</span></code> 的接口不匹配，
那么语句 <code class="docutils literal notranslate"><span class="pre">var</span> <span class="pre">_</span> <span class="pre">http.Handler</span> <span class="pre">=</span> <span class="pre">(*Handler)(nil)</span></code> 将无法编译通过。</p>
<p>赋值的右边应该是断言类型的零值。
对于指针类型（如 <code class="docutils literal notranslate"><span class="pre">*Handler</span></code>）、切片和映射，这是 <code class="docutils literal notranslate"><span class="pre">nil</span></code>；
对于结构类型，这是空结构。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">LogHandler</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">h</span><span class="w">   </span><span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span>
<span class="w">  </span><span class="nx">log</span><span class="w"> </span><span class="o">*</span><span class="nx">zap</span><span class="p">.</span><span class="nx">Logger</span>
<span class="p">}</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">LogHandler</span><span class="p">{}</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">h</span><span class="w"> </span><span class="nx">LogHandler</span><span class="p">)</span><span class="w"> </span><span class="nx">ServeHTTP</span><span class="p">(</span>
<span class="w">  </span><span class="nx">w</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span>
<span class="w">  </span><span class="nx">r</span><span class="w"> </span><span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="receiver">
<h2><span class="section-number">4.2.6.3. </span>接收器 (receiver) 与接口<a class="headerlink" href="#receiver" title="Permalink to this heading"></a></h2>
<p>使用值接收器的方法既可以通过值调用，也可以通过指针调用。</p>
<p>带指针接收器的方法只能通过指针或 <a class="reference external" href="https://golang.org/ref/spec#Method_values">addressable values</a> 调用。</p>
<p>例如，</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">S</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">data</span><span class="w"> </span><span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="nx">S</span><span class="p">)</span><span class="w"> </span><span class="nx">Read</span><span class="p">()</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">data</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">S</span><span class="p">)</span><span class="w"> </span><span class="nx">Write</span><span class="p">(</span><span class="nx">str</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">s</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">str</span>
<span class="p">}</span>

<span class="nx">sVals</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="nx">S</span><span class="p">{</span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;A&quot;</span><span class="p">}}</span>

<span class="c1">// 你通过值只能调用 Read</span>
<span class="nx">sVals</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">Read</span><span class="p">()</span>

<span class="c1">// 这不能编译通过：</span>
<span class="c1">//  sVals[1].Write(&quot;test&quot;)</span>

<span class="nx">sPtrs</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="o">*</span><span class="nx">S</span><span class="p">{</span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;A&quot;</span><span class="p">}}</span>

<span class="c1">// 通过指针既可以调用 Read，也可以调用 Write 方法</span>
<span class="nx">sPtrs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">Read</span><span class="p">()</span>
<span class="nx">sPtrs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">Write</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>类似的，即使方法有了值接收器，也同样可以用指针接收器来满足接口。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">F</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">f</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">S1</span><span class="w"> </span><span class="kd">struct</span><span class="p">{}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="nx">S1</span><span class="p">)</span><span class="w"> </span><span class="nx">f</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">S2</span><span class="w"> </span><span class="kd">struct</span><span class="p">{}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">S2</span><span class="p">)</span><span class="w"> </span><span class="nx">f</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>

<span class="nx">s1Val</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">S1</span><span class="p">{}</span>
<span class="nx">s1Ptr</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">S1</span><span class="p">{}</span>
<span class="nx">s2Val</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">S2</span><span class="p">{}</span>
<span class="nx">s2Ptr</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">S2</span><span class="p">{}</span>

<span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="nx">F</span>
<span class="nx">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">s1Val</span>
<span class="nx">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">s1Ptr</span>
<span class="nx">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">s2Ptr</span>

<span class="c1">//  下面代码无法通过编译。因为 s2Val 是一个值，而 S2 的 f 方法中没有使用值接收器</span>
<span class="c1">//   i = s2Val</span>
</pre></div>
</div>
<p><a class="reference external" href="https://golang.org/doc/effective_go.html">Effective Go</a> 中有一段关于 <a class="reference external" href="https://golang.org/doc/effective_go.html#pointers_vs_values">pointers vs. values</a> 的精彩讲解。</p>
<p>补充：</p>
<ul class="simple">
<li><p>一个类型可以有值接收器方法集和指针接收器方法集</p>
<ul>
<li><p>值接收器方法集是指针接收器方法集的子集，反之不是</p></li>
</ul>
</li>
<li><p>规则</p>
<ul>
<li><p>值对象只可以使用值接收器方法集</p></li>
<li><p>指针对象可以使用 值接收器方法集 + 指针接收器方法集</p></li>
</ul>
</li>
<li><p>接口的匹配 (或者叫实现)</p>
<ul>
<li><p>类型实现了接口的所有方法，叫匹配</p></li>
<li><p>具体的讲，要么是类型的值方法集匹配接口，要么是指针方法集匹配接口</p></li>
</ul>
</li>
</ul>
<p>具体的匹配分两种：</p>
<ul class="simple">
<li><p>值方法集和接口匹配</p>
<ul>
<li><p>给接口变量赋值的不管是值还是指针对象，都 ok，因为都包含值方法集</p></li>
</ul>
</li>
<li><p>指针方法集和接口匹配</p>
<ul>
<li><p>只能将指针对象赋值给接口变量，因为只有指针方法集和接口匹配</p></li>
<li><p>如果将值对象赋值给接口变量，会在编译期报错 (会触发接口合理性检查机制)</p></li>
</ul>
</li>
</ul>
<p>为啥 i = s2Val 会报错，因为值方法集和接口不匹配。</p>
</section>
<section id="mutex">
<h2><span class="section-number">4.2.6.4. </span>零值 Mutex 是有效的<a class="headerlink" href="#mutex" title="Permalink to this heading"></a></h2>
<p>零值 <code class="docutils literal notranslate"><span class="pre">sync.Mutex</span></code> 和 <code class="docutils literal notranslate"><span class="pre">sync.RWMutex</span></code> 是有效的。所以指向 mutex 的指针基本是不必要的。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">mu</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">new</span><span class="p">(</span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span><span class="p">)</span>
<span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">mu</span><span class="w"> </span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
<span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>如果你使用结构体指针，mutex 应该作为结构体的非指针字段。即使该结构体不被导出，也不要直接把 mutex 嵌入到结构体中。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">SMap</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>

<span class="w">  </span><span class="nx">data</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">NewSMap</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="nx">SMap</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">SMap</span><span class="p">{</span>
<span class="w">    </span><span class="nx">data</span><span class="p">:</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">),</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">m</span><span class="w"> </span><span class="o">*</span><span class="nx">SMap</span><span class="p">)</span><span class="w"> </span><span class="nx">Get</span><span class="p">(</span><span class="nx">k</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">m</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">  </span><span class="k">defer</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">SMap</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">mu</span><span class="w"> </span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>

<span class="w">  </span><span class="nx">data</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">NewSMap</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="nx">SMap</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">SMap</span><span class="p">{</span>
<span class="w">    </span><span class="nx">data</span><span class="p">:</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">),</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">m</span><span class="w"> </span><span class="o">*</span><span class="nx">SMap</span><span class="p">)</span><span class="w"> </span><span class="nx">Get</span><span class="p">(</span><span class="nx">k</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">m</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">  </span><span class="k">defer</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
<tr><td><p><code class="docutils literal notranslate"><span class="pre">Mutex</span></code> 字段， <code class="docutils literal notranslate"><span class="pre">Lock</span></code> 和 <code class="docutils literal notranslate"><span class="pre">Unlock</span></code> 方法是 <code class="docutils literal notranslate"><span class="pre">SMap</span></code> 导出的 API 中不刻意说明的一部分。</p>
 </td><td><p>mutex 及其方法是 <code class="docutils literal notranslate"><span class="pre">SMap</span></code> 的实现细节，对其调用者不可见。</p>
 </td></tr>
 </tbody></table></section>
<section id="slices-maps">
<h2><span class="section-number">4.2.6.5. </span>在边界处拷贝 Slices 和 Maps<a class="headerlink" href="#slices-maps" title="Permalink to this heading"></a></h2>
<p>slices 和 maps 包含了指向底层数据的指针，因此在需要复制它们时要特别注意。</p>
<section id="id6">
<h3><span class="section-number">4.2.6.5.1. </span>接收 Slices 和 Maps<a class="headerlink" href="#id6" title="Permalink to this heading"></a></h3>
<p>请记住，当 map 或 slice 作为函数参数传入时，如果您存储了对它们的引用，则用户可以对其进行修改。</p>
<table>
<thead><tr><th>Bad</th> <th>Good</th></tr></thead>
<tbody>
<tr>
<td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">d</span><span class="w"> </span><span class="o">*</span><span class="nx">Driver</span><span class="p">)</span><span class="w"> </span><span class="nx">SetTrips</span><span class="p">(</span><span class="nx">trips</span><span class="w"> </span><span class="p">[]</span><span class="nx">Trip</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">d</span><span class="p">.</span><span class="nx">trips</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">trips</span>
<span class="p">}</span>

<span class="nx">trips</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">...</span>
<span class="nx">d1</span><span class="p">.</span><span class="nx">SetTrips</span><span class="p">(</span><span class="nx">trips</span><span class="p">)</span>

<span class="c1">// 你是要修改 d1.trips 吗？</span>
<span class="nx">trips</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">...</span>
</pre></div>
</div>
</td>
<td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">d</span><span class="w"> </span><span class="o">*</span><span class="nx">Driver</span><span class="p">)</span><span class="w"> </span><span class="nx">SetTrips</span><span class="p">(</span><span class="nx">trips</span><span class="w"> </span><span class="p">[]</span><span class="nx">Trip</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">d</span><span class="p">.</span><span class="nx">trips</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">make</span><span class="p">([]</span><span class="nx">Trip</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">trips</span><span class="p">))</span>
<span class="w">  </span><span class="nb">copy</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">trips</span><span class="p">,</span><span class="w"> </span><span class="nx">trips</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">trips</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">...</span>
<span class="nx">d1</span><span class="p">.</span><span class="nx">SetTrips</span><span class="p">(</span><span class="nx">trips</span><span class="p">)</span>

<span class="c1">// 这里我们修改 trips[0]，但不会影响到 d1.trips</span>
<span class="nx">trips</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">...</span>
</pre></div>
</div>
</td>
</tr></tbody>
</table></section>
<section id="id7">
<h3><span class="section-number">4.2.6.5.2. </span>返回 slices 或 maps<a class="headerlink" href="#id7" title="Permalink to this heading"></a></h3>
<p>同样，请注意用户对暴露内部状态的 map 或 slice 的修改。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Stats</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">mu</span><span class="w"> </span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>

<span class="w">  </span><span class="nx">counters</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span>
<span class="p">}</span>

<span class="c1">// Snapshot 返回当前状态。</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Stats</span><span class="p">)</span><span class="w"> </span><span class="nx">Snapshot</span><span class="p">()</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">  </span><span class="k">defer</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">counters</span>
<span class="p">}</span>

<span class="c1">// snapshot 不再受互斥锁保护</span>
<span class="c1">// 因此对 snapshot 的任何访问都将受到数据竞争的影响</span>
<span class="c1">// 影响 stats.counters</span>
<span class="nx">snapshot</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">stats</span><span class="p">.</span><span class="nx">Snapshot</span><span class="p">()</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Stats</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">mu</span><span class="w"> </span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>

<span class="w">  </span><span class="nx">counters</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Stats</span><span class="p">)</span><span class="w"> </span><span class="nx">Snapshot</span><span class="p">()</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">  </span><span class="k">defer</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>

<span class="w">  </span><span class="nx">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">counters</span><span class="p">))</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="nx">k</span><span class="p">,</span><span class="w"> </span><span class="nx">v</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">counters</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">result</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">v</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span>
<span class="p">}</span>

<span class="c1">// snapshot 现在是一个拷贝</span>
<span class="nx">snapshot</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">stats</span><span class="p">.</span><span class="nx">Snapshot</span><span class="p">()</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
</section>
<section id="defer">
<h2><span class="section-number">4.2.6.6. </span>使用 defer 释放资源<a class="headerlink" href="#defer" title="Permalink to this heading"></a></h2>
<p>使用 defer 释放资源，诸如文件和锁。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">p</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="k">if</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">count</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">p</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">count</span>
<span class="p">}</span>

<span class="nx">p</span><span class="p">.</span><span class="nx">count</span><span class="o">++</span>
<span class="nx">newCount</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">count</span>
<span class="nx">p</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>

<span class="k">return</span><span class="w"> </span><span class="nx">newCount</span>

<span class="c1">// 当有多个 return 分支时，很容易遗忘 unlock</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">p</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="k">defer</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>

<span class="k">if</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">count</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">count</span>
<span class="p">}</span>

<span class="nx">p</span><span class="p">.</span><span class="nx">count</span><span class="o">++</span>
<span class="k">return</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">count</span>

<span class="c1">// 更可读</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>Defer 的开销非常小，只有在您可以证明函数执行时间处于纳秒级的程度时，才应避免这样做。使用 defer 提升可读性是值得的，因为使用它们的成本微不足道。尤其适用于那些不仅仅是简单内存访问的较大的方法，在这些方法中其他计算的资源消耗远超过 <code class="docutils literal notranslate"><span class="pre">defer</span></code>。</p>
</section>
<section id="channel-size-1">
<h2><span class="section-number">4.2.6.7. </span>Channel 的 size 要么是 1，要么是无缓冲的<a class="headerlink" href="#channel-size-1" title="Permalink to this heading"></a></h2>
<p>channel 通常 size 应为 1 或是无缓冲的。默认情况下，channel 是无缓冲的，其 size 为零。任何其他尺寸都必须经过严格的审查。我们需要考虑如何确定大小，考虑是什么阻止了 channel 在高负载下和阻塞写时的写入，以及当这种情况发生时系统逻辑有哪些变化。(翻译解释：按照原文意思是需要界定通道边界，竞态条件，以及逻辑上下文梳理)</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// 应该足以满足任何情况！</span>
<span class="nx">c</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">)</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// 大小：1</span>
<span class="nx">c</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c1">// 或者</span>
<span class="c1">// 无缓冲 channel，大小为 0</span>
<span class="nx">c</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
<section id="id8">
<h2><span class="section-number">4.2.6.8. </span>枚举从 1 开始<a class="headerlink" href="#id8" title="Permalink to this heading"></a></h2>
<p>在 Go 中引入枚举的标准方法是声明一个自定义类型和一个使用了 iota 的 const 组。由于变量的默认值为 0，因此通常应以非零值开头枚举。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Operation</span><span class="w"> </span><span class="kt">int</span>

<span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="nx">Add</span><span class="w"> </span><span class="nx">Operation</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">iota</span>
<span class="w">  </span><span class="nx">Subtract</span>
<span class="w">  </span><span class="nx">Multiply</span>
<span class="p">)</span>

<span class="c1">// Add=0, Subtract=1, Multiply=2</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Operation</span><span class="w"> </span><span class="kt">int</span>

<span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="nx">Add</span><span class="w"> </span><span class="nx">Operation</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">iota</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="nx">Subtract</span>
<span class="w">  </span><span class="nx">Multiply</span>
<span class="p">)</span>

<span class="c1">// Add=1, Subtract=2, Multiply=3</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>在某些情况下，使用零值是有意义的（枚举从零开始），例如，当零值是理想的默认行为时。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">LogOutput</span><span class="w"> </span><span class="kt">int</span>

<span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="nx">LogToStdout</span><span class="w"> </span><span class="nx">LogOutput</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">iota</span>
<span class="w">  </span><span class="nx">LogToFile</span>
<span class="w">  </span><span class="nx">LogToRemote</span>
<span class="p">)</span>

<span class="c1">// LogToStdout=0, LogToFile=1, LogToRemote=2</span>
</pre></div>
</div>
</section>
<section id="time">
<h2><span class="section-number">4.2.6.9. </span>使用 time 处理时间<a class="headerlink" href="#time" title="Permalink to this heading"></a></h2>
<p>时间处理很复杂。关于时间的错误假设通常包括以下几点。</p>
<ol class="simple">
<li><p>一天有 24 小时</p></li>
<li><p>一小时有 60 分钟</p></li>
<li><p>一周有七天</p></li>
<li><p>一年 365 天</p></li>
<li><p><a class="reference external" href="https://infiniteundo.com/post/25326999628/falsehoods-programmers-believe-about-time">还有更多</a></p></li>
</ol>
<p>例如，<em>1</em> 表示在一个时间点上加上 24 小时并不总是产生一个新的日历日。</p>
<p>因此，在处理时间时始终使用 <a class="reference external" href="https://pkg.go.dev/time/"><code class="docutils literal notranslate"><span class="pre">&quot;time&quot;</span></code></a> 包，因为它有助于以更安全、更准确的方式处理这些不正确的假设。</p>
<section id="time-time">
<h3><span class="section-number">4.2.6.9.1. </span>使用 <code class="docutils literal notranslate"><span class="pre">time.Time</span></code> 表达瞬时时间<a class="headerlink" href="#time-time" title="Permalink to this heading"></a></h3>
<p>在处理时间的瞬间时使用 <a class="reference external" href="https://pkg.go.dev/time/#Time"><code class="docutils literal notranslate"><span class="pre">time.Time</span></code></a>，在比较、添加或减去时间时使用 <code class="docutils literal notranslate"><span class="pre">time.Time</span></code> 中的方法。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">isActive</span><span class="p">(</span><span class="nx">now</span><span class="p">,</span><span class="w"> </span><span class="nx">start</span><span class="p">,</span><span class="w"> </span><span class="nx">stop</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">now</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">now</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">stop</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">isActive</span><span class="p">(</span><span class="nx">now</span><span class="p">,</span><span class="w"> </span><span class="nx">start</span><span class="p">,</span><span class="w"> </span><span class="nx">stop</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">)</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="nx">start</span><span class="p">.</span><span class="nx">Before</span><span class="p">(</span><span class="nx">now</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">start</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">now</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">now</span><span class="p">.</span><span class="nx">Before</span><span class="p">(</span><span class="nx">stop</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
<section id="time-duration">
<h3><span class="section-number">4.2.6.9.2. </span>使用 <code class="docutils literal notranslate"><span class="pre">time.Duration</span></code> 表达时间段<a class="headerlink" href="#time-duration" title="Permalink to this heading"></a></h3>
<p>在处理时间段时使用 <a class="reference external" href="https://pkg.go.dev/time/#Duration"><code class="docutils literal notranslate"><span class="pre">time.Duration</span></code></a> .</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">poll</span><span class="p">(</span><span class="nx">delay</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">(</span><span class="nx">delay</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
<span class="nx">poll</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="c1">// 是几秒钟还是几毫秒？</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">poll</span><span class="p">(</span><span class="nx">delay</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="nx">delay</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
<span class="nx">poll</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>回到第一个例子，在一个时间瞬间加上 24 小时，我们用于添加时间的方法取决于意图。如果我们想要下一个日历日 (当前天的下一天) 的同一个时间点，我们应该使用 <a class="reference external" href="https://pkg.go.dev/time/#Time.AddDate"><code class="docutils literal notranslate"><span class="pre">Time.AddDate</span></code></a>。但是，如果我们想保证某一时刻比前一时刻晚 24 小时，我们应该使用 <a class="reference external" href="https://pkg.go.dev/time/#Time.Add"><code class="docutils literal notranslate"><span class="pre">Time.Add</span></code></a>。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">newDay</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">AddDate</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="cm">/* years */</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="cm">/* months */</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="cm">/* days */</span><span class="p">)</span>
<span class="nx">maybeNewDay</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="mi">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Hour</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="time-time-time-duration">
<h3><span class="section-number">4.2.6.9.3. </span>对外部系统使用 <code class="docutils literal notranslate"><span class="pre">time.Time</span></code> 和 <code class="docutils literal notranslate"><span class="pre">time.Duration</span></code><a class="headerlink" href="#time-time-time-duration" title="Permalink to this heading"></a></h3>
<p>尽可能在与外部系统的交互中使用 <code class="docutils literal notranslate"><span class="pre">time.Duration</span></code> 和 <code class="docutils literal notranslate"><span class="pre">time.Time</span></code> 例如 :</p>
<ul class="simple">
<li><p>Command-line 标志: <a class="reference external" href="https://pkg.go.dev/flag/"><code class="docutils literal notranslate"><span class="pre">flag</span></code></a> 通过 <a class="reference external" href="https://pkg.go.dev/time/#ParseDuration"><code class="docutils literal notranslate"><span class="pre">time.ParseDuration</span></code></a> 支持 <code class="docutils literal notranslate"><span class="pre">time.Duration</span></code></p></li>
<li><p>JSON: <a class="reference external" href="https://pkg.go.dev/encoding/json/"><code class="docutils literal notranslate"><span class="pre">encoding/json</span></code></a> 通过其 <a class="reference external" href="https://pkg.go.dev/time/#Time.UnmarshalJSON"><code class="docutils literal notranslate"><span class="pre">UnmarshalJSON</span></code> method</a> 方法支持将 <code class="docutils literal notranslate"><span class="pre">time.Time</span></code> 编码为 <a class="reference external" href="https://tools.ietf.org/html/rfc3339">RFC 3339</a> 字符串</p></li>
<li><p>SQL: <a class="reference external" href="https://pkg.go.dev/database/sql/"><code class="docutils literal notranslate"><span class="pre">database/sql</span></code></a> 支持将 <code class="docutils literal notranslate"><span class="pre">DATETIME</span></code> 或 <code class="docutils literal notranslate"><span class="pre">TIMESTAMP</span></code> 列转换为 <code class="docutils literal notranslate"><span class="pre">time.Time</span></code>，如果底层驱动程序支持则返回</p></li>
<li><p>YAML: <a class="reference external" href="https://pkg.go.dev/gopkg.in/yaml.v2"><code class="docutils literal notranslate"><span class="pre">gopkg.in/yaml.v2</span></code></a> 支持将 <code class="docutils literal notranslate"><span class="pre">time.Time</span></code> 作为 <a class="reference external" href="https://tools.ietf.org/html/rfc3339">RFC 3339</a> 字符串，并通过 <a class="reference external" href="https://pkg.go.dev/time/#ParseDuration"><code class="docutils literal notranslate"><span class="pre">time.ParseDuration</span></code></a> 支持 <code class="docutils literal notranslate"><span class="pre">time.Duration</span></code>。</p></li>
</ul>
<p>当不能在这些交互中使用 <code class="docutils literal notranslate"><span class="pre">time.Duration</span></code> 时，请使用 <code class="docutils literal notranslate"><span class="pre">int</span></code> 或 <code class="docutils literal notranslate"><span class="pre">float64</span></code>，并在字段名称中包含单位。</p>
<p>例如，由于 <code class="docutils literal notranslate"><span class="pre">encoding/json</span></code> 不支持 <code class="docutils literal notranslate"><span class="pre">time.Duration</span></code>，因此该单位包含在字段的名称中。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// {&quot;interval&quot;: 2}</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">Interval</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="s">`json:&quot;interval&quot;`</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// {&quot;intervalMillis&quot;: 2000}</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">IntervalMillis</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="s">`json:&quot;intervalMillis&quot;`</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>当在这些交互中不能使用 <code class="docutils literal notranslate"><span class="pre">time.Time</span></code> 时，除非达成一致，否则使用 <code class="docutils literal notranslate"><span class="pre">string</span></code> 和 <a class="reference external" href="https://tools.ietf.org/html/rfc3339">RFC 3339</a> 中定义的格式时间戳。默认情况下，<a class="reference external" href="https://pkg.go.dev/time/#Time.UnmarshalText"><code class="docutils literal notranslate"><span class="pre">Time.UnmarshalText</span></code></a> 使用此格式，并可通过 <a class="reference external" href="https://pkg.go.dev/time/#RFC3339"><code class="docutils literal notranslate"><span class="pre">time.RFC3339</span></code></a> 在 <code class="docutils literal notranslate"><span class="pre">Time.Format</span></code> 和 <code class="docutils literal notranslate"><span class="pre">time.Parse</span></code> 中使用。</p>
<p>尽管这在实践中并不成问题，但请记住，<code class="docutils literal notranslate"><span class="pre">&quot;time&quot;</span></code> 包不支持解析闰秒时间戳（<a class="reference external" href="https://go.dev/issues/8728">8728</a>），也不在计算中考虑闰秒（<a class="reference external" href="https://go.dev/issues/15190">15190</a>）。如果您比较两个时间瞬间，则差异将不包括这两个瞬间之间可能发生的闰秒。</p>
<!-- TODO: section on String methods for enums --></section>
</section>
<section id="errors">
<h2><span class="section-number">4.2.6.10. </span>Errors<a class="headerlink" href="#errors" title="Permalink to this heading"></a></h2>
<section id="id9">
<h3><span class="section-number">4.2.6.10.1. </span>错误类型<a class="headerlink" href="#id9" title="Permalink to this heading"></a></h3>
<p>声明错误的选项很少。
在选择最适合您的用例的选项之前，请考虑以下事项。</p>
<ul class="simple">
<li><p>调用者是否需要匹配错误以便他们可以处理它？
如果是，我们必须通过声明顶级错误变量或自定义类型来支持 <a class="reference external" href="https://pkg.go.dev/errors/#Is"><code class="docutils literal notranslate"><span class="pre">errors.Is</span></code></a> 或 <a class="reference external" href="https://pkg.go.dev/errors/#As"><code class="docutils literal notranslate"><span class="pre">errors.As</span></code></a> 函数。</p></li>
<li><p>错误消息是否为静态字符串，还是需要上下文信息的动态字符串？
如果是静态字符串，我们可以使用 <a class="reference external" href="https://pkg.go.dev/errors/#New"><code class="docutils literal notranslate"><span class="pre">errors.New</span></code></a>，但对于后者，我们必须使用 <a class="reference external" href="https://pkg.go.dev/fmt/#Errorf"><code class="docutils literal notranslate"><span class="pre">fmt.Errorf</span></code></a> 或自定义错误类型。</p></li>
<li><p>我们是否正在传递由下游函数返回的新错误？
如果是这样，请参阅<a class="reference external" href="#%E9%94%99%E8%AF%AF%E5%8C%85%E8%A3%85">错误包装部分</a>。</p></li>
</ul>
<table border="1" class="docutils">
<thead>
<tr>
<th>错误匹配？</th>
<th>错误消息</th>
<th>指导</th>
</tr>
</thead>
<tbody>
<tr>
<td>No</td>
<td>static</td>
<td>[<code>errors.New</code>]</td>
</tr>
<tr>
<td>No</td>
<td>dynamic</td>
<td>[<code>fmt.Errorf</code>]</td>
</tr>
<tr>
<td>Yes</td>
<td>static</td>
<td>top-level <code>var</code> with [<code>errors.New</code>]</td>
</tr>
<tr>
<td>Yes</td>
<td>dynamic</td>
<td>custom <code>error</code> type</td>
</tr>
</tbody>
</table><p>例如，
使用 <a class="reference external" href="https://pkg.go.dev/errors/#New"><code class="docutils literal notranslate"><span class="pre">errors.New</span></code></a> 表示带有静态字符串的错误。
如果调用者需要匹配并处理此错误，则将此错误导出为变量以支持将其与 <code class="docutils literal notranslate"><span class="pre">errors.Is</span></code> 匹配。</p>
<table>
<thead><tr><th>无错误匹配</th><th>错误匹配</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// package foo</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">Open</span><span class="p">()</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;could not open&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// package bar</span>

<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">foo</span><span class="p">.</span><span class="nx">Open</span><span class="p">();</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Can&#39;t handle the error.</span>
<span class="w">  </span><span class="nb">panic</span><span class="p">(</span><span class="s">&quot;unknown error&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// package foo</span>

<span class="kd">var</span><span class="w"> </span><span class="nx">ErrCouldNotOpen</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;could not open&quot;</span><span class="p">)</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">Open</span><span class="p">()</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">ErrCouldNotOpen</span>
<span class="p">}</span>

<span class="c1">// package bar</span>

<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">foo</span><span class="p">.</span><span class="nx">Open</span><span class="p">();</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">foo</span><span class="p">.</span><span class="nx">ErrCouldNotOpen</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// handle the error</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">panic</span><span class="p">(</span><span class="s">&quot;unknown error&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>对于动态字符串的错误，
如果调用者不需要匹配它，则使用 <a class="reference external" href="https://pkg.go.dev/fmt/#Errorf"><code class="docutils literal notranslate"><span class="pre">fmt.Errorf</span></code></a>，
如果调用者确实需要匹配它，则自定义 <code class="docutils literal notranslate"><span class="pre">error</span></code>。</p>
<table>
<thead><tr><th>无错误匹配</th><th>错误匹配</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// package foo</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">Open</span><span class="p">(</span><span class="nx">file</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;file %q not found&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// package bar</span>

<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">foo</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="s">&quot;testfile.txt&quot;</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Can&#39;t handle the error.</span>
<span class="w">  </span><span class="nb">panic</span><span class="p">(</span><span class="s">&quot;unknown error&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// package foo</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">NotFoundError</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">File</span><span class="w"> </span><span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="o">*</span><span class="nx">NotFoundError</span><span class="p">)</span><span class="w"> </span><span class="nx">Error</span><span class="p">()</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;file %q not found&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">File</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">Open</span><span class="p">(</span><span class="nx">file</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">NotFoundError</span><span class="p">{</span><span class="nx">File</span><span class="p">:</span><span class="w"> </span><span class="nx">file</span><span class="p">}</span>
<span class="p">}</span>


<span class="c1">// package bar</span>

<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">foo</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="s">&quot;testfile.txt&quot;</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">notFound</span><span class="w"> </span><span class="o">*</span><span class="nx">NotFoundError</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">As</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">notFound</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// handle the error</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">panic</span><span class="p">(</span><span class="s">&quot;unknown error&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>请注意，如果您从包中导出错误变量或类型，
它们将成为包的公共 API 的一部分。</p>
</section>
<section id="id10">
<h3><span class="section-number">4.2.6.10.2. </span>错误包装<a class="headerlink" href="#id10" title="Permalink to this heading"></a></h3>
<p>如果调用其他方法时出现错误, 通常有三种处理方式可以选择：</p>
<ul class="simple">
<li><p>将原始错误原样返回</p></li>
<li><p>使用 <code class="docutils literal notranslate"><span class="pre">fmt.Errorf</span></code> 搭配 <code class="docutils literal notranslate"><span class="pre">%w</span></code> 将错误添加进上下文后返回</p></li>
<li><p>使用 <code class="docutils literal notranslate"><span class="pre">fmt.Errorf</span></code> 搭配 <code class="docutils literal notranslate"><span class="pre">%v</span></code> 将错误添加进上下文后返回</p></li>
</ul>
<p>如果没有要添加的其他上下文，则按原样返回原始错误。
这将保留原始错误类型和消息。
这非常适合底层错误消息有足够的信息来追踪它来自哪里的错误。</p>
<p>否则，尽可能在错误消息中添加上下文
这样就不会出现诸如“连接被拒绝”之类的模糊错误，
您会收到更多有用的错误，例如“调用服务 foo：连接被拒绝”。</p>
<p>使用 <code class="docutils literal notranslate"><span class="pre">fmt.Errorf</span></code> 为你的错误添加上下文，
根据调用者是否应该能够匹配和提取根本原因，在 <code class="docutils literal notranslate"><span class="pre">%w</span></code> 或 <code class="docutils literal notranslate"><span class="pre">%v</span></code> 动词之间进行选择。</p>
<ul class="simple">
<li><p>如果调用者应该可以访问底层错误，请使用 <code class="docutils literal notranslate"><span class="pre">%w</span></code>。
对于大多数包装错误，这是一个很好的默认值，
但请注意，调用者可能会开始依赖此行为。因此，对于包装错误是已知<code class="docutils literal notranslate"><span class="pre">var</span></code>或类型的情况，请将其作为函数契约的一部分进行记录和测试。</p></li>
<li><p>使用 <code class="docutils literal notranslate"><span class="pre">%v</span></code> 来混淆底层错误。
调用者将无法匹配它，但如果需要，您可以在将来切换到 <code class="docutils literal notranslate"><span class="pre">%w</span></code>。</p></li>
</ul>
<p>在为返回的错误添加上下文时，通过避免使用”failed to”之类的短语来保持上下文简洁，当错误通过堆栈向上渗透时，它会一层一层被堆积起来：</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">s</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">store</span><span class="p">.</span><span class="nx">New</span><span class="p">()</span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span>
<span class="w">        </span><span class="s">&quot;failed to create new store: %w&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">s</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">store</span><span class="p">.</span><span class="nx">New</span><span class="p">()</span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span>
<span class="w">        </span><span class="s">&quot;new store: %w&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr><tr><td><div class="highlight-plain notranslate"><div class="highlight"><pre><span></span>failed to x: failed to y: failed to create new store: the error
</pre></div>
</div>
</td><td><div class="highlight-plain notranslate"><div class="highlight"><pre><span></span>x: y: new store: the error
</pre></div>
</div>
</td></tr>
</tbody></table><p>然而，一旦错误被发送到另一个系统，应该清楚消息是一个错误（例如<code class="docutils literal notranslate"><span class="pre">err</span></code> 标签或日志中的”Failed”前缀）。</p>
<p>另见 <a class="reference external" href="https://dave.cheney.net/2016/04/27/dont-just-check-errors-handle-them-gracefully">不要只检查错误，优雅地处理它们</a>。</p>
</section>
<section id="id11">
<h3><span class="section-number">4.2.6.10.3. </span>错误命名<a class="headerlink" href="#id11" title="Permalink to this heading"></a></h3>
<p>对于存储为全局变量的错误值，
根据是否导出，使用前缀 <code class="docutils literal notranslate"><span class="pre">Err</span></code> 或 <code class="docutils literal notranslate"><span class="pre">err</span></code>。
请看指南 <a class="reference external" href="#%E5%AF%B9%E4%BA%8E%E6%9C%AA%E5%AF%BC%E5%87%BA%E7%9A%84%E9%A1%B6%E5%B1%82%E5%B8%B8%E9%87%8F%E5%92%8C%E5%8F%98%E9%87%8F%E4%BD%BF%E7%94%A8_%E4%BD%9C%E4%B8%BA%E5%89%8D%E7%BC%80">对于未导出的顶层常量和变量，使用_作为前缀</a>。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="c1">// 导出以下两个错误，以便此包的用户可以将它们与 errors.Is 进行匹配。</span>

<span class="w">  </span><span class="nx">ErrBrokenLink</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;link is broken&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="nx">ErrCouldNotOpen</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;could not open&quot;</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// 这个错误没有被导出，因为我们不想让它成为我们公共 API 的一部分。 我们可能仍然在带有错误的包内使用它。</span>

<span class="w">  </span><span class="nx">errNotFound</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;not found&quot;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>对于自定义错误类型，请改用后缀 <code class="docutils literal notranslate"><span class="pre">Error</span></code>。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// 同样，这个错误被导出，以便这个包的用户可以将它与 errors.As 匹配。</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">NotFoundError</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">File</span><span class="w"> </span><span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="o">*</span><span class="nx">NotFoundError</span><span class="p">)</span><span class="w"> </span><span class="nx">Error</span><span class="p">()</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;file %q not found&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">File</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 并且这个错误没有被导出，因为我们不想让它成为公共 API 的一部分。 我们仍然可以在带有 errors.As 的包中使用它。</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">resolveError</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">Path</span><span class="w"> </span><span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="o">*</span><span class="nx">resolveError</span><span class="p">)</span><span class="w"> </span><span class="nx">Error</span><span class="p">()</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;resolve %q&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">Path</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id12">
<h3><span class="section-number">4.2.6.10.4. </span>一次处理错误<a class="headerlink" href="#id12" title="Permalink to this heading"></a></h3>
<p>当调用方从被调用方接收到错误时，它可以根据对错误的了解，以各种不同的方式进行处理。</p>
<p>其中包括但不限于：</p>
<ul class="simple">
<li><p>如果被调用者约定定义了特定的错误，则将错误与<code class="docutils literal notranslate"><span class="pre">errors.Is</span></code>或<code class="docutils literal notranslate"><span class="pre">errors.As</span></code>匹配，并以不同的方式处理分支</p></li>
<li><p>如果错误是可恢复的，则记录错误并正常降级</p></li>
<li><p>如果该错误表示特定于域的故障条件，则返回定义明确的错误</p></li>
<li><p>返回错误，无论是 <a class="reference external" href="#%E9%94%99%E8%AF%AF%E5%8C%85%E8%A3%85">wrapped</a> 还是逐字逐句</p></li>
</ul>
<p>无论调用方如何处理错误，它通常都应该只处理每个错误一次。例如，调用方不应该记录错误然后返回，因为<em>its</em>调用方也可能处理错误。</p>
<p>例如，考虑以下情况：</p>
<table>
<thead><tr><th>Description</th><th>Code</th></tr></thead>
<tbody>
<tr><td><p><strong>Bad</strong>: 记录错误并将其返回</p>
<p>堆栈中的调用程序可能会对该错误采取类似的操作。这样做会在应用程序日志中造成大量噪音，但收效甚微。</p>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">u</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">getUser</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// BAD: See description</span>
<span class="w">  </span><span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Could not get user %q: %v&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
<tr><td><p><strong>Good</strong>: 将错误换行并返回</p>
<p>堆栈中更靠上的调用程序将处理该错误。使用<code class="docutils literal notranslate"><span class="pre">%w</span></code>可确保它们可以将错误与<code class="docutils literal notranslate"><span class="pre">errors.Is</span></code>或<code class="docutils literal notranslate"><span class="pre">errors.As</span></code>相匹配 （如果相关）。</p>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">u</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">getUser</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;get user %q: %w&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
<tr><td><p><strong>Good</strong>: 记录错误并正常降级</p>
<p>如果操作不是绝对必要的，我们可以通过从中恢复来提供降级但不间断的体验。</p>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">emitMetrics</span><span class="p">();</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Failure to write metrics should not</span>
<span class="w">  </span><span class="c1">// break the application.</span>
<span class="w">  </span><span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Could not emit metrics: %v&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
<tr><td><p><strong>Good</strong>: 匹配错误并适当降级</p>
<p>如果被调用者在其约定中定义了一个特定的错误，并且失败是可恢复的，则匹配该错误案例并正常降级。对于所有其他案例，请包装错误并返回。</p>
<p>堆栈中更靠上的调用程序将处理其他错误。</p>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">tz</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">getUserTimeZone</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">ErrUserNotFound</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// User doesn&#39;t exist. Use UTC.</span>
<span class="w">    </span><span class="nx">tz</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">UTC</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;get user %q: %w&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
</section>
<section id="id13">
<h2><span class="section-number">4.2.6.11. </span>处理断言失败<a class="headerlink" href="#id13" title="Permalink to this heading"></a></h2>
<p><a class="reference external" href="https://golang.org/ref/spec#Type_assertions">类型断言</a> 将会在检测到不正确的类型时，以单一返回值形式返回 panic。 因此，请始终使用“逗号 ok”习语。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">t</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">i</span><span class="p">.(</span><span class="kt">string</span><span class="p">)</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">i</span><span class="p">.(</span><span class="kt">string</span><span class="p">)</span>
<span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 优雅地处理错误</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><!-- TODO: There are a few situations where the single assignment form is
fine. --></section>
<section id="panic">
<h2><span class="section-number">4.2.6.12. </span>不要使用 panic<a class="headerlink" href="#panic" title="Permalink to this heading"></a></h2>
<p>在生产环境中运行的代码必须避免出现 panic。panic 是 <a class="reference external" href="https://en.wikipedia.org/wiki/Cascading_failure">级联失败</a> 的主要根源 。如果发生错误，该函数必须返回错误，并允许调用方决定如何处理它。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">run</span><span class="p">(</span><span class="nx">args</span><span class="w"> </span><span class="p">[]</span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">panic</span><span class="p">(</span><span class="s">&quot;an argument is required&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">run</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">run</span><span class="p">(</span><span class="nx">args</span><span class="w"> </span><span class="p">[]</span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;an argument is required&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">run</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintln</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="nx">os</span><span class="p">.</span><span class="nx">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>panic/recover 不是错误处理策略。仅当发生不可恢复的事情（例如：nil 引用）时，程序才必须 panic。程序初始化是一个例外：程序启动时应使程序中止的不良情况可能会引起 panic。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">_statusTemplate</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">template</span><span class="p">.</span><span class="nx">Must</span><span class="p">(</span><span class="nx">template</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">).</span><span class="nx">Parse</span><span class="p">(</span><span class="s">&quot;_statusHTML&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>即使在测试代码中，也优先使用<code class="docutils literal notranslate"><span class="pre">t.Fatal</span></code>或者<code class="docutils literal notranslate"><span class="pre">t.FailNow</span></code>而不是 panic 来确保失败被标记。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// func TestFoo(t *testing.T)</span>

<span class="nx">f</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">CreateTemp</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;test&quot;</span><span class="p">)</span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nb">panic</span><span class="p">(</span><span class="s">&quot;failed to set up test&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// func TestFoo(t *testing.T)</span>

<span class="nx">f</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">CreateTemp</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;test&quot;</span><span class="p">)</span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">t</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">&quot;failed to set up test&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><!-- TODO: Explain how to use _test packages. --></section>
<section id="go-uber-org-atomic">
<h2><span class="section-number">4.2.6.13. </span>使用 go.uber.org/atomic<a class="headerlink" href="#go-uber-org-atomic" title="Permalink to this heading"></a></h2>
<p>使用 <a class="reference external" href="https://pkg.go.dev/sync/atomic/">sync/atomic</a> 包的原子操作对原始类型 (<code class="docutils literal notranslate"><span class="pre">int32</span></code>, <code class="docutils literal notranslate"><span class="pre">int64</span></code>等）进行操作，因为很容易忘记使用原子操作来读取或修改变量。</p>
<p><a class="reference external" href="https://pkg.go.dev/go.uber.org/atomic">go.uber.org/atomic</a> 通过隐藏基础类型为这些操作增加了类型安全性。此外，它包括一个方便的<code class="docutils literal notranslate"><span class="pre">atomic.Bool</span></code>类型。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">foo</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">running</span><span class="w"> </span><span class="kt">int32</span><span class="w">  </span><span class="c1">// atomic</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">f</span><span class="o">*</span><span class="w"> </span><span class="nx">foo</span><span class="p">)</span><span class="w"> </span><span class="nx">start</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">atomic</span><span class="p">.</span><span class="nx">SwapInt32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">f</span><span class="p">.</span><span class="nx">running</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="c1">// already running…</span>
<span class="w">     </span><span class="k">return</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// start the Foo</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">f</span><span class="w"> </span><span class="o">*</span><span class="nx">foo</span><span class="p">)</span><span class="w"> </span><span class="nx">isRunning</span><span class="p">()</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">running</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="c1">// race!</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">foo</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">running</span><span class="w"> </span><span class="nx">atomic</span><span class="p">.</span><span class="nx">Bool</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">f</span><span class="w"> </span><span class="o">*</span><span class="nx">foo</span><span class="p">)</span><span class="w"> </span><span class="nx">start</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">running</span><span class="p">.</span><span class="nx">Swap</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="c1">// already running…</span>
<span class="w">     </span><span class="k">return</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// start the Foo</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">f</span><span class="w"> </span><span class="o">*</span><span class="nx">foo</span><span class="p">)</span><span class="w"> </span><span class="nx">isRunning</span><span class="p">()</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">running</span><span class="p">.</span><span class="nx">Load</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
<section id="id14">
<h2><span class="section-number">4.2.6.14. </span>避免可变全局变量<a class="headerlink" href="#id14" title="Permalink to this heading"></a></h2>
<p>使用选择依赖注入方式避免改变全局变量。
既适用于函数指针又适用于其他值类型</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// sign.go</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">_timeNow</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">sign</span><span class="p">(</span><span class="nx">msg</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">now</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">_timeNow</span><span class="p">()</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">signWithTime</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span><span class="w"> </span><span class="nx">now</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// sign.go</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">signer</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">now</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>
<span class="p">}</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">newSigner</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="nx">signer</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">signer</span><span class="p">{</span>
<span class="w">    </span><span class="nx">now</span><span class="p">:</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">,</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">signer</span><span class="p">)</span><span class="w"> </span><span class="nx">Sign</span><span class="p">(</span><span class="nx">msg</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">now</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">signWithTime</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span><span class="w"> </span><span class="nx">now</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// sign_test.go</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">TestSign</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">oldTimeNow</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">_timeNow</span>
<span class="w">  </span><span class="nx">_timeNow</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">someFixedTime</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">defer</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">_timeNow</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">oldTimeNow</span><span class="w"> </span><span class="p">}()</span>
<span class="w">  </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">want</span><span class="p">,</span><span class="w"> </span><span class="nx">sign</span><span class="p">(</span><span class="nx">give</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// sign_test.go</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">TestSigner</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">s</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">newSigner</span><span class="p">()</span>
<span class="w">  </span><span class="nx">s</span><span class="p">.</span><span class="nx">now</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">someFixedTime</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">want</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">Sign</span><span class="p">(</span><span class="nx">give</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
<section id="id15">
<h2><span class="section-number">4.2.6.15. </span>避免在公共结构中嵌入类型<a class="headerlink" href="#id15" title="Permalink to this heading"></a></h2>
<p>这些嵌入的类型泄漏实现细节、禁止类型演化和模糊的文档。</p>
<p>假设您使用共享的 <code class="docutils literal notranslate"><span class="pre">AbstractList</span></code> 实现了多种列表类型，请避免在具体的列表实现中嵌入 <code class="docutils literal notranslate"><span class="pre">AbstractList</span></code>。
相反，只需手动将方法写入具体的列表，该列表将委托给抽象列表。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">AbstractList</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{}</span>
<span class="c1">// 添加将实体添加到列表中。</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">l</span><span class="w"> </span><span class="o">*</span><span class="nx">AbstractList</span><span class="p">)</span><span class="w"> </span><span class="nx">Add</span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="nx">Entity</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
<span class="c1">// 移除从列表中移除实体。</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">l</span><span class="w"> </span><span class="o">*</span><span class="nx">AbstractList</span><span class="p">)</span><span class="w"> </span><span class="nx">Remove</span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="nx">Entity</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// ConcreteList 是一个实体列表。</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">ConcreteList</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="o">*</span><span class="nx">AbstractList</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// ConcreteList 是一个实体列表。</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">ConcreteList</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">list</span><span class="w"> </span><span class="o">*</span><span class="nx">AbstractList</span>
<span class="p">}</span>
<span class="c1">// 添加将实体添加到列表中。</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">l</span><span class="w"> </span><span class="o">*</span><span class="nx">ConcreteList</span><span class="p">)</span><span class="w"> </span><span class="nx">Add</span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="nx">Entity</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">l</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
<span class="p">}</span>
<span class="c1">// 移除从列表中移除实体。</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">l</span><span class="w"> </span><span class="o">*</span><span class="nx">ConcreteList</span><span class="p">)</span><span class="w"> </span><span class="nx">Remove</span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="nx">Entity</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">l</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">Remove</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>Go 允许 <a class="reference external" href="https://golang.org/doc/effective_go.html#embedding">类型嵌入</a> 作为继承和组合之间的折衷。外部类型获取嵌入类型的方法的隐式副本。默认情况下，这些方法委托给嵌入实例的同一方法。</p>
<p>结构还获得与类型同名的字段。
所以，如果嵌入的类型是 public，那么字段是 public。为了保持向后兼容性，外部类型的每个未来版本都必须保留嵌入类型。</p>
<p>很少需要嵌入类型。
这是一种方便，可以帮助您避免编写冗长的委托方法。</p>
<p>即使嵌入兼容的抽象列表 <em>interface</em>，而不是结构体，这将为开发人员提供更大的灵活性来改变未来，但仍然泄露了具体列表使用抽象实现的细节。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// AbstractList 是各种实体列表的通用实现。</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">AbstractList</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">Add</span><span class="p">(</span><span class="nx">Entity</span><span class="p">)</span>
<span class="w">  </span><span class="nx">Remove</span><span class="p">(</span><span class="nx">Entity</span><span class="p">)</span>
<span class="p">}</span>
<span class="c1">// ConcreteList 是一个实体列表。</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">ConcreteList</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">AbstractList</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// ConcreteList 是一个实体列表。</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">ConcreteList</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">list</span><span class="w"> </span><span class="nx">AbstractList</span>
<span class="p">}</span>
<span class="c1">// 添加将实体添加到列表中。</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">l</span><span class="w"> </span><span class="o">*</span><span class="nx">ConcreteList</span><span class="p">)</span><span class="w"> </span><span class="nx">Add</span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="nx">Entity</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">l</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
<span class="p">}</span>
<span class="c1">// 移除从列表中移除实体。</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">l</span><span class="w"> </span><span class="o">*</span><span class="nx">ConcreteList</span><span class="p">)</span><span class="w"> </span><span class="nx">Remove</span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="nx">Entity</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">l</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">Remove</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>无论是使用嵌入结构还是嵌入接口，都会限制类型的演化。</p>
<ul class="simple">
<li><p>向嵌入接口添加方法是一个破坏性的改变。</p></li>
<li><p>从嵌入结构体删除方法是一个破坏性改变。</p></li>
<li><p>删除嵌入类型是一个破坏性的改变。</p></li>
<li><p>即使使用满足相同接口的类型替换嵌入类型，也是一个破坏性的改变。</p></li>
</ul>
<p>尽管编写这些委托方法是乏味的，但是额外的工作隐藏了实现细节，留下了更多的更改机会，还消除了在文档中发现完整列表接口的间接性操作。</p>
</section>
<section id="id16">
<h2><span class="section-number">4.2.6.16. </span>避免使用内置名称<a class="headerlink" href="#id16" title="Permalink to this heading"></a></h2>
<p>Go <a class="reference external" href="https://golang.org/ref/spec">语言规范</a> 概述了几个内置的，
不应在 Go 项目中使用的 <a class="reference external" href="https://golang.org/ref/spec#Predeclared_identifiers">预先声明的标识符</a>。</p>
<p>根据上下文的不同，将这些标识符作为名称重复使用，
将在当前作用域（或任何嵌套作用域）中隐藏原始标识符，或者混淆代码。
在最好的情况下，编译器会报错；在最坏的情况下，这样的代码可能会引入潜在的、难以恢复的错误。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="kt">string</span>
<span class="c1">// `error` 作用域隐式覆盖</span>

<span class="c1">// or</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">handleErrorMessage</span><span class="p">(</span><span class="kt">error</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// `error` 作用域隐式覆盖</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">errorMessage</span><span class="w"> </span><span class="kt">string</span>
<span class="c1">// `error` 指向内置的非覆盖</span>

<span class="c1">// or</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">handleErrorMessage</span><span class="p">(</span><span class="nx">msg</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// `error` 指向内置的非覆盖</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Foo</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 虽然这些字段在技术上不构成阴影，但`error`或`string`字符串的重映射现在是不明确的。</span>
<span class="w">    </span><span class="kt">error</span><span class="w">  </span><span class="kt">error</span>
<span class="w">    </span><span class="kt">string</span><span class="w"> </span><span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">f</span><span class="w"> </span><span class="nx">Foo</span><span class="p">)</span><span class="w"> </span><span class="nx">Error</span><span class="p">()</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// `error` 和 `f.error` 在视觉上是相似的</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="kt">error</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">f</span><span class="w"> </span><span class="nx">Foo</span><span class="p">)</span><span class="w"> </span><span class="nx">String</span><span class="p">()</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// `string` and `f.string` 在视觉上是相似的</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="kt">string</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Foo</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// `error` and `string` 现在是明确的。</span>
<span class="w">    </span><span class="nx">err</span><span class="w"> </span><span class="kt">error</span>
<span class="w">    </span><span class="nx">str</span><span class="w"> </span><span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">f</span><span class="w"> </span><span class="nx">Foo</span><span class="p">)</span><span class="w"> </span><span class="nx">Error</span><span class="p">()</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">err</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">f</span><span class="w"> </span><span class="nx">Foo</span><span class="p">)</span><span class="w"> </span><span class="nx">String</span><span class="p">()</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">str</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>注意，编译器在使用预先分隔的标识符时不会生成错误，
但是诸如<code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">vet</span></code>之类的工具会正确地指出这些和其他情况下的隐式问题。</p>
</section>
<section id="init">
<h2><span class="section-number">4.2.6.17. </span>避免使用 <code class="docutils literal notranslate"><span class="pre">init()</span></code><a class="headerlink" href="#init" title="Permalink to this heading"></a></h2>
<p>尽可能避免使用<code class="docutils literal notranslate"><span class="pre">init()</span></code>。当<code class="docutils literal notranslate"><span class="pre">init()</span></code>是不可避免或可取的，代码应先尝试：</p>
<ol class="simple">
<li><p>无论程序环境或调用如何，都要完全确定。</p></li>
<li><p>避免依赖于其他<code class="docutils literal notranslate"><span class="pre">init()</span></code>函数的顺序或副作用。虽然<code class="docutils literal notranslate"><span class="pre">init()</span></code>顺序是明确的，但代码可以更改，
因此<code class="docutils literal notranslate"><span class="pre">init()</span></code>函数之间的关系可能会使代码变得脆弱和容易出错。</p></li>
<li><p>避免访问或操作全局或环境状态，如机器信息、环境变量、工作目录、程序参数/输入等。</p></li>
<li><p>避免<code class="docutils literal notranslate"><span class="pre">I/O</span></code>，包括文件系统、网络和系统调用。</p></li>
</ol>
<p>不能满足这些要求的代码可能属于要作为<code class="docutils literal notranslate"><span class="pre">main()</span></code>调用的一部分（或程序生命周期中的其他地方），
或者作为<code class="docutils literal notranslate"><span class="pre">main()</span></code>本身的一部分写入。特别是，打算由其他程序使用的库应该特别注意完全确定性，
而不是执行“init magic”</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Foo</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">_defaultFoo</span><span class="w"> </span><span class="nx">Foo</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">_defaultFoo</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">Foo</span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ...</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">_defaultFoo</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">Foo</span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
<span class="c1">// or，为了更好的可测试性：</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">_defaultFoo</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">defaultFoo</span><span class="p">()</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">defaultFoo</span><span class="p">()</span><span class="w"> </span><span class="nx">Foo</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">Foo</span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ...</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">_config</span><span class="w"> </span><span class="nx">Config</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Bad: 基于当前目录</span>
<span class="w">    </span><span class="nx">cwd</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Getwd</span><span class="p">()</span>
<span class="w">    </span><span class="c1">// Bad: I/O</span>
<span class="w">    </span><span class="nx">raw</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">ReadFile</span><span class="p">(</span>
<span class="w">        </span><span class="nx">path</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="nx">cwd</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;config&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;config.yaml&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="nx">yaml</span><span class="p">.</span><span class="nx">Unmarshal</span><span class="p">(</span><span class="nx">raw</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">_config</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">loadConfig</span><span class="p">()</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">cwd</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Getwd</span><span class="p">()</span>
<span class="w">    </span><span class="c1">// handle err</span>
<span class="w">    </span><span class="nx">raw</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">ReadFile</span><span class="p">(</span>
<span class="w">        </span><span class="nx">path</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="nx">cwd</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;config&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;config.yaml&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="c1">// handle err</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="nx">Config</span>
<span class="w">    </span><span class="nx">yaml</span><span class="p">.</span><span class="nx">Unmarshal</span><span class="p">(</span><span class="nx">raw</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">config</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">config</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>考虑到上述情况，在某些情况下，<code class="docutils literal notranslate"><span class="pre">init()</span></code>可能更可取或是必要的，可能包括：</p>
<ul class="simple">
<li><p>不能表示为单个赋值的复杂表达式。</p></li>
<li><p>可插入的钩子，如<code class="docutils literal notranslate"><span class="pre">database/sql</span></code>、编码类型注册表等。</p></li>
<li><p>对 <a class="reference external" href="https://cloud.google.com/functions/docs/bestpractices/tips#use_global_variables_to_reuse_objects_in_future_invocations">Google Cloud Functions</a> 和其他形式的确定性预计算的优化。</p></li>
</ul>
</section>
<section id="id17">
<h2><span class="section-number">4.2.6.18. </span>追加时优先指定切片容量<a class="headerlink" href="#id17" title="Permalink to this heading"></a></h2>
<p>追加时优先指定切片容量</p>
<p>在尽可能的情况下，在初始化要追加的切片时为<code class="docutils literal notranslate"><span class="pre">make()</span></code>提供一个容量值。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span><span class="w"> </span><span class="nx">n</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">data</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">size</span><span class="p">;</span><span class="w"> </span><span class="nx">k</span><span class="o">++</span><span class="p">{</span>
<span class="w">    </span><span class="nx">data</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">k</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span><span class="w"> </span><span class="nx">n</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">data</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">size</span><span class="p">)</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">size</span><span class="p">;</span><span class="w"> </span><span class="nx">k</span><span class="o">++</span><span class="p">{</span>
<span class="w">    </span><span class="nx">data</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">k</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
<tr><td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">BenchmarkBad</span><span class="o">-</span><span class="mi">4</span>    <span class="mi">100000000</span>    <span class="mf">2.48</span><span class="n">s</span>
</pre></div>
</div>
</td><td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">BenchmarkGood</span><span class="o">-</span><span class="mi">4</span>   <span class="mi">100000000</span>    <span class="mf">0.21</span><span class="n">s</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
<section id="exit">
<h2><span class="section-number">4.2.6.19. </span>主函数退出方式 (Exit)<a class="headerlink" href="#exit" title="Permalink to this heading"></a></h2>
<p>Go 程序使用 <a class="reference external" href="https://pkg.go.dev/os/#Exit"><code class="docutils literal notranslate"><span class="pre">os.Exit</span></code></a> 或者 <a class="reference external" href="https://pkg.go.dev/log/#Fatal"><code class="docutils literal notranslate"><span class="pre">log.Fatal*</span></code></a> 立即退出 (使用<code class="docutils literal notranslate"><span class="pre">panic</span></code>不是退出程序的好方法，请 <a class="reference external" href="#%E4%B8%8D%E8%A6%81%E4%BD%BF%E7%94%A8-panic">不要使用 panic</a>。)</p>
<p><strong>仅在<code class="docutils literal notranslate"><span class="pre">main()</span></code></strong> 中调用其中一个 <code class="docutils literal notranslate"><span class="pre">os.Exit</span></code> 或者 <code class="docutils literal notranslate"><span class="pre">log.Fatal*</span></code>。所有其他函数应将错误返回到信号失败中。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">body</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">readFile</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
<span class="w">  </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">readFile</span><span class="p">(</span><span class="nx">path</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">f</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">ReadAll</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">body</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">readFile</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">readFile</span><span class="p">(</span><span class="nx">path</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">f</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">ReadAll</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>原则上：退出的具有多种功能的程序存在一些问题：</p>
<ul class="simple">
<li><p>不明显的控制流：任何函数都可以退出程序，因此很难对控制流进行推理。</p></li>
<li><p>难以测试：退出程序的函数也将退出调用它的测试。这使得函数很难测试，并引入了跳过 <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">test</span></code> 尚未运行的其他测试的风险。</p></li>
<li><p>跳过清理：当函数退出程序时，会跳过已经进入<code class="docutils literal notranslate"><span class="pre">defer</span></code>队列里的函数调用。这增加了跳过重要清理任务的风险。</p></li>
</ul>
<section id="id18">
<h3><span class="section-number">4.2.6.19.1. </span>一次性退出<a class="headerlink" href="#id18" title="Permalink to this heading"></a></h3>
<p>如果可能的话，你的<code class="docutils literal notranslate"><span class="pre">main（）</span></code>函数中 <strong>最多一次</strong> 调用 <code class="docutils literal notranslate"><span class="pre">os.Exit</span></code>或者<code class="docutils literal notranslate"><span class="pre">log.Fatal</span></code>。如果有多个错误场景停止程序执行，请将该逻辑放在单独的函数下并从中返回错误。
这会缩短 <code class="docutils literal notranslate"><span class="pre">main()</span></code> 函数，并将所有关键业务逻辑放入一个单独的、可测试的函数中。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">args</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">&quot;missing file&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="nx">name</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="w">  </span><span class="nx">f</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">defer</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
<span class="w">  </span><span class="c1">// 如果我们调用 log.Fatal 在这条线之后</span>
<span class="w">  </span><span class="c1">// f.Close 将会被执行。</span>
<span class="w">  </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">ReadAll</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">run</span><span class="p">();</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">run</span><span class="p">()</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">args</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;missing file&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="nx">name</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="w">  </span><span class="nx">f</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">defer</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
<span class="w">  </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">ReadAll</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>上面的示例使用<code class="docutils literal notranslate"><span class="pre">log.Fatal</span></code>，但该指南也适用于<code class="docutils literal notranslate"><span class="pre">os.Exit</span></code>或任何调用<code class="docutils literal notranslate"><span class="pre">os.Exit</span></code>的库代码。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">run</span><span class="p">();</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintln</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="nx">os</span><span class="p">.</span><span class="nx">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>您可以根据需要更改<code class="docutils literal notranslate"><span class="pre">run()</span></code>的签名。例如，如果您的程序必须使用特定的失败退出代码退出，<code class="docutils literal notranslate"><span class="pre">run()</span></code>可能会返回退出代码而不是错误。这也允许单元测试直接验证此行为。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">os</span><span class="p">.</span><span class="nx">Exit</span><span class="p">(</span><span class="nx">run</span><span class="p">(</span><span class="nx">args</span><span class="p">))</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">run</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="nx">exitCode</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>请注意，这些示例中使用的<code class="docutils literal notranslate"><span class="pre">run()</span></code>函数并不是强制性的。
<code class="docutils literal notranslate"><span class="pre">run()</span></code>函数的名称、签名和设置具有灵活性。除其他外，您可以：</p>
<ul class="simple">
<li><p>接受未分析的命令行参数 (e.g., <code class="docutils literal notranslate"><span class="pre">run(os.Args[1:])</span></code>)</p></li>
<li><p>解析<code class="docutils literal notranslate"><span class="pre">main()</span></code>中的命令行参数并将其传递到<code class="docutils literal notranslate"><span class="pre">run</span></code></p></li>
<li><p>使用自定义错误类型将退出代码传回<code class="docutils literal notranslate"><span class="pre">main（）</span></code></p></li>
<li><p>将业务逻辑置于不同的抽象层 <code class="docutils literal notranslate"><span class="pre">package</span> <span class="pre">main</span></code></p></li>
</ul>
<p>本指南只要求在<code class="docutils literal notranslate"><span class="pre">main()</span></code>中有一个位置负责实际的退出流程。</p>
</section>
</section>
<section id="id19">
<h2><span class="section-number">4.2.6.20. </span>在序列化结构中使用字段标记<a class="headerlink" href="#id19" title="Permalink to this heading"></a></h2>
<p>任何序列化到JSON、YAML、，
或其他支持基于标记的字段命名的格式应使用相关标记进行注释。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Stock</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">Price</span><span class="w"> </span><span class="kt">int</span>
<span class="w">  </span><span class="nx">Name</span><span class="w">  </span><span class="kt">string</span>
<span class="p">}</span>
<span class="nx">bytes</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">json</span><span class="p">.</span><span class="nx">Marshal</span><span class="p">(</span><span class="nx">Stock</span><span class="p">{</span>
<span class="w">  </span><span class="nx">Price</span><span class="p">:</span><span class="w"> </span><span class="mi">137</span><span class="p">,</span>
<span class="w">  </span><span class="nx">Name</span><span class="p">:</span><span class="w">  </span><span class="s">&quot;UBER&quot;</span><span class="p">,</span>
<span class="p">})</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Stock</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">Price</span><span class="w"> </span><span class="kt">int</span><span class="w">    </span><span class="s">`json:&quot;price&quot;`</span>
<span class="w">  </span><span class="nx">Name</span><span class="w">  </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;name&quot;`</span>
<span class="w">  </span><span class="c1">// Safe to rename Name to Symbol.</span>
<span class="p">}</span>
<span class="nx">bytes</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">json</span><span class="p">.</span><span class="nx">Marshal</span><span class="p">(</span><span class="nx">Stock</span><span class="p">{</span>
<span class="w">  </span><span class="nx">Price</span><span class="p">:</span><span class="w"> </span><span class="mi">137</span><span class="p">,</span>
<span class="w">  </span><span class="nx">Name</span><span class="p">:</span><span class="w">  </span><span class="s">&quot;UBER&quot;</span><span class="p">,</span>
<span class="p">})</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>理论上：
结构的序列化形式是不同系统之间的契约。
对序列化表单结构（包括字段名）的更改会破坏此约定。在标记中指定字段名使约定明确，
它还可以通过重构或重命名字段来防止意外违反约定。</p>
</section>
<section id="goroutine">
<h2><span class="section-number">4.2.6.21. </span>不要一劳永逸地使用 goroutine<a class="headerlink" href="#goroutine" title="Permalink to this heading"></a></h2>
<p>Goroutines 是轻量级的，但它们不是免费的：
至少，它们会为堆栈和 CPU 的调度消耗内存。
虽然这些成本对于 Goroutines 的使用来说很小，但当它们在没有受控生命周期的情况下大量生成时会导致严重的性能问题。
具有非托管生命周期的 Goroutines 也可能导致其他问题，例如防止未使用的对象被垃圾回收并保留不再使用的资源。</p>
<p>因此，不要在代码中泄漏 goroutine。
使用 <a class="reference external" href="https://pkg.go.dev/go.uber.org/goleak">go.uber.org/goleak</a>
来测试可能产生 goroutine 的包内的 goroutine 泄漏。</p>
<p>一般来说，每个 goroutine:</p>
<ul class="simple">
<li><p>必须有一个可预测的停止运行时间； 或者</p></li>
<li><p>必须有一种方法可以向 goroutine 发出信号它应该停止</p></li>
</ul>
<p>在这两种情况下，都必须有一种方式代码来阻塞并等待 goroutine 完成。</p>
<p>For example:</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">flush</span><span class="p">()</span>
<span class="w">    </span><span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="nx">delay</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}()</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="nx">stop</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kd">struct</span><span class="p">{})</span><span class="w"> </span><span class="c1">// 告诉 goroutine 停止</span>
<span class="w">  </span><span class="nx">done</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kd">struct</span><span class="p">{})</span><span class="w"> </span><span class="c1">// 告诉我们 goroutine 退出了</span>
<span class="p">)</span>
<span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">defer</span><span class="w"> </span><span class="nb">close</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span>
<span class="w">  </span><span class="nx">ticker</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">NewTicker</span><span class="p">(</span><span class="nx">delay</span><span class="p">)</span>
<span class="w">  </span><span class="k">defer</span><span class="w"> </span><span class="nx">ticker</span><span class="p">.</span><span class="nx">Stop</span><span class="p">()</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">tick</span><span class="p">.</span><span class="nx">C</span><span class="p">:</span>
<span class="w">      </span><span class="nx">flush</span><span class="p">()</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">stop</span><span class="p">:</span>
<span class="w">      </span><span class="k">return</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}()</span>
<span class="c1">// 其它...</span>
<span class="nb">close</span><span class="p">(</span><span class="nx">stop</span><span class="p">)</span><span class="w">  </span><span class="c1">// 指示 goroutine 停止</span>
<span class="o">&lt;-</span><span class="nx">done</span><span class="w">       </span><span class="c1">// and wait for it to exit</span>
</pre></div>
</div>
</td></tr>
<tr><td><p>没有办法阻止这个 goroutine。这将一直运行到应用程序退出。</p>
</td><td><p>这个 goroutine 可以用 <code class="docutils literal notranslate"><span class="pre">close(stop)</span></code>,
我们可以等待它退出 <code class="docutils literal notranslate"><span class="pre">&lt;-done</span></code>.</p>
</td></tr>
</tbody></table><section id="goroutines">
<h3><span class="section-number">4.2.6.21.1. </span>等待 goroutines 退出<a class="headerlink" href="#goroutines" title="Permalink to this heading"></a></h3>
<p>给定一个由系统生成的 goroutine，
必须有一种方案能等待 goroutine 的退出。
有两种常用的方法可以做到这一点：</p>
<ul>
<li><p>使用 <code class="docutils literal notranslate"><span class="pre">sync.WaitGroup</span></code>.
如果您要等待多个 goroutine，请执行此操作</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">wg</span><span class="w"> </span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
<span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">N</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">wg</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">  </span><span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">wg</span><span class="p">.</span><span class="nx">Done</span><span class="p">()</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">  </span><span class="p">}()</span>
<span class="p">}</span>

<span class="c1">// To wait for all to finish:</span>
<span class="nx">wg</span><span class="p">.</span><span class="nx">Wait</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p>添加另一个 <code class="docutils literal notranslate"><span class="pre">chan</span> <span class="pre">struct{}</span></code>，goroutine 完成后会关闭它。
如果只有一个 goroutine，请执行此操作。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">done</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kd">struct</span><span class="p">{})</span>
<span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">defer</span><span class="w"> </span><span class="nb">close</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}()</span>

<span class="c1">// To wait for the goroutine to finish:</span>
<span class="o">&lt;-</span><span class="nx">done</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="init-goroutines">
<h3><span class="section-number">4.2.6.21.2. </span>不要在 <code class="docutils literal notranslate"><span class="pre">init()</span></code> 使用 goroutines<a class="headerlink" href="#init-goroutines" title="Permalink to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">init()</span></code> 函数不应该产生 goroutines。
另请参阅 <a class="reference external" href="#%E9%81%BF%E5%85%8D%E4%BD%BF%E7%94%A8-init">避免使用 init()</a>。</p>
<p>如果一个包需要一个后台 goroutine，
它必须公开一个负责管理 goroutine 生命周期的对象。
该对象必须提供一个方法（<code class="docutils literal notranslate"><span class="pre">Close</span></code>、<code class="docutils literal notranslate"><span class="pre">Stop</span></code>、<code class="docutils literal notranslate"><span class="pre">Shutdown</span></code> 等）来指示后台 goroutine 停止并等待它的退出。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">go</span><span class="w"> </span><span class="nx">doWork</span><span class="p">()</span>
<span class="p">}</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">doWork</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Worker</span><span class="w"> </span><span class="kd">struct</span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">}</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">NewWorker</span><span class="p">(</span><span class="o">...</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="nx">Worker</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">w</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">Worker</span><span class="p">{</span>
<span class="w">    </span><span class="nx">stop</span><span class="p">:</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kd">struct</span><span class="p">{}),</span>
<span class="w">    </span><span class="nx">done</span><span class="p">:</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kd">struct</span><span class="p">{}),</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">go</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">doWork</span><span class="p">()</span>
<span class="p">}</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">w</span><span class="w"> </span><span class="o">*</span><span class="nx">Worker</span><span class="p">)</span><span class="w"> </span><span class="nx">doWork</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">defer</span><span class="w"> </span><span class="nb">close</span><span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nx">done</span><span class="p">)</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">w</span><span class="p">.</span><span class="nx">stop</span><span class="p">:</span>
<span class="w">      </span><span class="k">return</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
<span class="c1">// Shutdown 告诉 worker 停止</span>
<span class="c1">// 并等待它完成。</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">w</span><span class="w"> </span><span class="o">*</span><span class="nx">Worker</span><span class="p">)</span><span class="w"> </span><span class="nx">Shutdown</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nb">close</span><span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nx">stop</span><span class="p">)</span>
<span class="w">  </span><span class="o">&lt;-</span><span class="nx">w</span><span class="p">.</span><span class="nx">done</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
<tr><td><p>当用户导出这个包时，无条件地生成一个后台 goroutine。
用户无法控制 goroutine 或停止它的方法。</p>
</td><td><p>仅当用户请求时才生成工作人员。
提供一种关闭工作器的方法，以便用户可以释放工作器使用的资源。</p>
<p>请注意，如果工作人员管理多个 goroutine，则应使用<code class="docutils literal notranslate"><span class="pre">WaitGroup</span></code>。
请参阅 <a class="reference external" href="#%E7%AD%89%E5%BE%85-goroutines-%E9%80%80%E5%87%BA">等待 goroutines 退出</a>。</p>
</td></tr>
</tbody></table></section>
</section>
</section>
<section id="id20">
<h1><span class="section-number">4.2.7. </span>性能<a class="headerlink" href="#id20" title="Permalink to this heading"></a></h1>
<p>性能方面的特定准则只适用于高频场景。</p>
<section id="strconv-fmt">
<h2><span class="section-number">4.2.7.1. </span>优先使用 strconv 而不是 fmt<a class="headerlink" href="#strconv-fmt" title="Permalink to this heading"></a></h2>
<p>将原语转换为字符串或从字符串转换时，<code class="docutils literal notranslate"><span class="pre">strconv</span></code>速度比<code class="docutils literal notranslate"><span class="pre">fmt</span></code>快。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">s</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprint</span><span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nx">Int</span><span class="p">())</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">s</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">strconv</span><span class="p">.</span><span class="nx">Itoa</span><span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nx">Int</span><span class="p">())</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
<tr><td><div class="highlight-plain notranslate"><div class="highlight"><pre><span></span>BenchmarkFmtSprint-4    143 ns/op    2 allocs/op
</pre></div>
</div>
</td><td><div class="highlight-plain notranslate"><div class="highlight"><pre><span></span>BenchmarkStrconv-4    64.2 ns/op    1 allocs/op
</pre></div>
</div>
</td></tr>
</tbody></table></section>
<section id="id21">
<h2><span class="section-number">4.2.7.2. </span>避免字符串到字节的转换<a class="headerlink" href="#id21" title="Permalink to this heading"></a></h2>
<p>不要反复从固定字符串创建字节 slice。相反，请执行一次转换并捕获结果。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">w</span><span class="p">.</span><span class="nx">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;Hello world&quot;</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">data</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;Hello world&quot;</span><span class="p">)</span>
<span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">w</span><span class="p">.</span><span class="nx">Write</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</tr>
<tr><td><div class="highlight-plain notranslate"><div class="highlight"><pre><span></span>BenchmarkBad-4   50000000   22.2 ns/op
</pre></div>
</div>
</td><td><div class="highlight-plain notranslate"><div class="highlight"><pre><span></span>BenchmarkGood-4  500000000   3.25 ns/op
</pre></div>
</div>
</td></tr>
</tbody></table></section>
<section id="id22">
<h2><span class="section-number">4.2.7.3. </span>指定容器容量<a class="headerlink" href="#id22" title="Permalink to this heading"></a></h2>
<p>尽可能指定容器容量，以便为容器预先分配内存。这将在添加元素时最小化后续分配（通过复制和调整容器大小）。</p>
<section id="map">
<h3><span class="section-number">4.2.7.3.1. </span>指定 Map 容量提示<a class="headerlink" href="#map" title="Permalink to this heading"></a></h3>
<p>在尽可能的情况下，在使用 <code class="docutils literal notranslate"><span class="pre">make()</span></code> 初始化的时候提供容量信息</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="nx">T1</span><span class="p">]</span><span class="nx">T2</span><span class="p">,</span><span class="w"> </span><span class="nx">hint</span><span class="p">)</span>
</pre></div>
</div>
<p>向<code class="docutils literal notranslate"><span class="pre">make()</span></code>提供容量提示会在初始化时尝试调整 map 的大小，这将减少在将元素添加到 map 时为 map 重新分配内存。</p>
<p>注意，与 slices 不同。map 容量提示并不保证完全的、预先的分配，而是用于估计所需的 hashmap bucket 的数量。
因此，在将元素添加到 map 时，甚至在指定 map 容量时，仍可能发生分配。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">m</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">os</span><span class="p">.</span><span class="nx">FileInfo</span><span class="p">)</span>

<span class="nx">files</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">ReadDir</span><span class="p">(</span><span class="s">&quot;./files&quot;</span><span class="p">)</span>
<span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">f</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">files</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">m</span><span class="p">[</span><span class="nx">f</span><span class="p">.</span><span class="nx">Name</span><span class="p">()]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">f</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">files</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">ReadDir</span><span class="p">(</span><span class="s">&quot;./files&quot;</span><span class="p">)</span>

<span class="nx">m</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">os</span><span class="p">.</span><span class="nx">FileInfo</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">files</span><span class="p">))</span>
<span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">f</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">files</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">m</span><span class="p">[</span><span class="nx">f</span><span class="p">.</span><span class="nx">Name</span><span class="p">()]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">f</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
<tr><td><p><code class="docutils literal notranslate"><span class="pre">m</span></code> 是在没有大小提示的情况下创建的； 在运行时可能会有更多分配。</p>
</td><td><p><code class="docutils literal notranslate"><span class="pre">m</span></code> 是有大小提示创建的；在运行时可能会有更少的分配。</p>
</td></tr>
</tbody></table></section>
<section id="id23">
<h3><span class="section-number">4.2.7.3.2. </span>指定切片容量<a class="headerlink" href="#id23" title="Permalink to this heading"></a></h3>
<p>在尽可能的情况下，在使用<code class="docutils literal notranslate"><span class="pre">make()</span></code>初始化切片时提供容量信息，特别是在追加切片时。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nb">make</span><span class="p">([]</span><span class="nx">T</span><span class="p">,</span><span class="w"> </span><span class="nx">length</span><span class="p">,</span><span class="w"> </span><span class="nx">capacity</span><span class="p">)</span>
</pre></div>
</div>
<p>与 maps 不同，slice capacity 不是一个提示：编译器将为提供给<code class="docutils literal notranslate"><span class="pre">make()</span></code>的 slice 的容量分配足够的内存，
这意味着后续的<code class="docutils literal notranslate"><span class="pre">append()</span></code>操作将导致零分配（直到 slice 的长度与容量匹配，在此之后，任何 append 都可能调整大小以容纳其他元素）。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span><span class="w"> </span><span class="nx">n</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">data</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">size</span><span class="p">;</span><span class="w"> </span><span class="nx">k</span><span class="o">++</span><span class="p">{</span>
<span class="w">    </span><span class="nx">data</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">k</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span><span class="w"> </span><span class="nx">n</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">data</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">size</span><span class="p">)</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">size</span><span class="p">;</span><span class="w"> </span><span class="nx">k</span><span class="o">++</span><span class="p">{</span>
<span class="w">    </span><span class="nx">data</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">k</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
<tr><td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">BenchmarkBad</span><span class="o">-</span><span class="mi">4</span>    <span class="mi">100000000</span>    <span class="mf">2.48</span><span class="n">s</span>
</pre></div>
</div>
</td><td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">BenchmarkGood</span><span class="o">-</span><span class="mi">4</span>   <span class="mi">100000000</span>    <span class="mf">0.21</span><span class="n">s</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
</section>
</section>
<section id="id24">
<h1><span class="section-number">4.2.8. </span>规范<a class="headerlink" href="#id24" title="Permalink to this heading"></a></h1>
<section id="id25">
<h2><span class="section-number">4.2.8.1. </span>避免过长的行<a class="headerlink" href="#id25" title="Permalink to this heading"></a></h2>
<p>避免使用需要读者水平滚动或过度转动头部的代码行。</p>
<p>我们建议将行长度限制为 <strong>99 characters</strong> (99 个字符).
作者应该在达到这个限制之前换行，
但这不是硬性限制。
允许代码超过此限制。</p>
</section>
<section id="id26">
<h2><span class="section-number">4.2.8.2. </span>一致性<a class="headerlink" href="#id26" title="Permalink to this heading"></a></h2>
<p>本文中概述的一些标准都是客观性的评估，是根据场景、上下文、或者主观性的判断；</p>
<p>但是最重要的是，<strong>保持一致</strong>.</p>
<p>一致性的代码更容易维护、是更合理的、需要更少的学习成本、并且随着新的约定出现或者出现错误后更容易迁移、更新、修复 bug</p>
<p>相反，在一个代码库中包含多个完全不同或冲突的代码风格会导致维护成本开销、不确定性和认知偏差。所有这些都会直接导致速度降低、代码审查痛苦、而且增加 bug 数量。</p>
<p>将这些标准应用于代码库时，建议在 package（或更大）级别进行更改，子包级别的应用程序通过将多个样式引入到同一代码中，违反了上述关注点。</p>
</section>
<section id="id27">
<h2><span class="section-number">4.2.8.3. </span>相似的声明放在一组<a class="headerlink" href="#id27" title="Permalink to this heading"></a></h2>
<p>Go 语言支持将相似的声明放在一个组内。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="s">&quot;a&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="s">&quot;b&quot;</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="s">&quot;a&quot;</span>
<span class="w">  </span><span class="s">&quot;b&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>这同样适用于常量、变量和类型声明：</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span>

<span class="kd">var</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">Area</span><span class="w"> </span><span class="kt">float64</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">Volume</span><span class="w"> </span><span class="kt">float64</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="nx">a</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="nx">b</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span>
<span class="p">)</span>

<span class="kd">var</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="nx">a</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="nx">b</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span>
<span class="p">)</span>

<span class="kd">type</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="nx">Area</span><span class="w"> </span><span class="kt">float64</span>
<span class="w">  </span><span class="nx">Volume</span><span class="w"> </span><span class="kt">float64</span>
<span class="p">)</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>仅将相关的声明放在一组。不要将不相关的声明放在一组。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Operation</span><span class="w"> </span><span class="kt">int</span>

<span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="nx">Add</span><span class="w"> </span><span class="nx">Operation</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">iota</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="nx">Subtract</span>
<span class="w">  </span><span class="nx">Multiply</span>
<span class="w">  </span><span class="nx">EnvVar</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;MY_ENV&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Operation</span><span class="w"> </span><span class="kt">int</span>

<span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="nx">Add</span><span class="w"> </span><span class="nx">Operation</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">iota</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="nx">Subtract</span>
<span class="w">  </span><span class="nx">Multiply</span>
<span class="p">)</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">EnvVar</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;MY_ENV&quot;</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>分组使用的位置没有限制，例如：你可以在函数内部使用它们：</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">f</span><span class="p">()</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">red</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">color</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="mh">0xff0000</span><span class="p">)</span>
<span class="w">  </span><span class="nx">green</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">color</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="mh">0x00ff00</span><span class="p">)</span>
<span class="w">  </span><span class="nx">blue</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">color</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="mh">0x0000ff</span><span class="p">)</span>

<span class="w">  </span><span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">f</span><span class="p">()</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="nx">red</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="nx">color</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="mh">0xff0000</span><span class="p">)</span>
<span class="w">    </span><span class="nx">green</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">color</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="mh">0x00ff00</span><span class="p">)</span>
<span class="w">    </span><span class="nx">blue</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="nx">color</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="mh">0x0000ff</span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>例外：如果变量声明与其他变量相邻，则应将变量声明（尤其是函数内部的声明）分组在一起。对一起声明的变量执行此操作，即使它们不相关。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">client</span><span class="p">)</span><span class="w"> </span><span class="nx">request</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">caller</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">name</span>
<span class="w">  </span><span class="nx">format</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;json&quot;</span>
<span class="w">  </span><span class="nx">timeout</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">5</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="kt">error</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">client</span><span class="p">)</span><span class="w"> </span><span class="nx">request</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="nx">caller</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">name</span>
<span class="w">    </span><span class="nx">format</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;json&quot;</span>
<span class="w">    </span><span class="nx">timeout</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">5</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span>
<span class="w">    </span><span class="nx">err</span><span class="w"> </span><span class="kt">error</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
<section id="import">
<h2><span class="section-number">4.2.8.4. </span>import 分组<a class="headerlink" href="#import" title="Permalink to this heading"></a></h2>
<p>导入应该分为两组：</p>
<ul class="simple">
<li><p>标准库</p></li>
<li><p>其他库</p></li>
</ul>
<p>默认情况下，这是 goimports 应用的分组。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="s">&quot;fmt&quot;</span>
<span class="w">  </span><span class="s">&quot;os&quot;</span>
<span class="w">  </span><span class="s">&quot;go.uber.org/atomic&quot;</span>
<span class="w">  </span><span class="s">&quot;golang.org/x/sync/errgroup&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="s">&quot;fmt&quot;</span>
<span class="w">  </span><span class="s">&quot;os&quot;</span>

<span class="w">  </span><span class="s">&quot;go.uber.org/atomic&quot;</span>
<span class="w">  </span><span class="s">&quot;golang.org/x/sync/errgroup&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
<section id="id28">
<h2><span class="section-number">4.2.8.5. </span>包名<a class="headerlink" href="#id28" title="Permalink to this heading"></a></h2>
<p>当命名包时，请按下面规则选择一个名称：</p>
<ul class="simple">
<li><p>全部小写。没有大写或下划线。</p></li>
<li><p>大多数使用命名导入的情况下，不需要重命名。</p></li>
<li><p>简短而简洁。请记住，在每个使用的地方都完整标识了该名称。</p></li>
<li><p>不用复数。例如<code class="docutils literal notranslate"><span class="pre">net/url</span></code>，而不是<code class="docutils literal notranslate"><span class="pre">net/urls</span></code>。</p></li>
<li><p>不要用“common”，“util”，“shared”或“lib”。这些是不好的，信息量不足的名称。</p></li>
</ul>
<p>另请参阅 <a class="reference external" href="https://go.dev/blog/package-names">Go 包命名规则</a> 和 <a class="reference external" href="https://rakyll.org/style-packages/">Go 包样式指南</a>.</p>
</section>
<section id="id29">
<h2><span class="section-number">4.2.8.6. </span>函数名<a class="headerlink" href="#id29" title="Permalink to this heading"></a></h2>
<p>我们遵循 Go 社区关于使用 <a class="reference external" href="https://golang.org/doc/effective_go.html#mixed-caps">MixedCaps 作为函数名</a> 的约定。有一个例外，为了对相关的测试用例进行分组，函数名可能包含下划线，如：<code class="docutils literal notranslate"><span class="pre">TestMyFunction_WhatIsBeingTested</span></code>.</p>
</section>
<section id="id30">
<h2><span class="section-number">4.2.8.7. </span>导入别名<a class="headerlink" href="#id30" title="Permalink to this heading"></a></h2>
<p>如果程序包名称与导入路径的最后一个元素不匹配，则必须使用导入别名。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="s">&quot;net/http&quot;</span>

<span class="w">  </span><span class="nx">client</span><span class="w"> </span><span class="s">&quot;example.com/client-go&quot;</span>
<span class="w">  </span><span class="nx">trace</span><span class="w"> </span><span class="s">&quot;example.com/trace/v2&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
<p>在所有其他情况下，除非导入之间有直接冲突，否则应避免导入别名。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="s">&quot;fmt&quot;</span>
<span class="w">  </span><span class="s">&quot;os&quot;</span>

<span class="w">  </span><span class="nx">nettrace</span><span class="w"> </span><span class="s">&quot;golang.net/x/trace&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="s">&quot;fmt&quot;</span>
<span class="w">  </span><span class="s">&quot;os&quot;</span>
<span class="w">  </span><span class="s">&quot;runtime/trace&quot;</span>

<span class="w">  </span><span class="nx">nettrace</span><span class="w"> </span><span class="s">&quot;golang.net/x/trace&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
<section id="id31">
<h2><span class="section-number">4.2.8.8. </span>函数分组与顺序<a class="headerlink" href="#id31" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p>函数应按粗略的调用顺序排序。</p></li>
<li><p>同一文件中的函数应按接收者分组。</p></li>
</ul>
<p>因此，导出的函数应先出现在文件中，放在<code class="docutils literal notranslate"><span class="pre">struct</span></code>, <code class="docutils literal notranslate"><span class="pre">const</span></code>, <code class="docutils literal notranslate"><span class="pre">var</span></code>定义的后面。</p>
<p>在定义类型之后，但在接收者的其余方法之前，可能会出现一个 <code class="docutils literal notranslate"><span class="pre">newXYZ()</span></code>/<code class="docutils literal notranslate"><span class="pre">NewXYZ()</span></code></p>
<p>由于函数是按接收者分组的，因此普通工具函数应在文件末尾出现。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">something</span><span class="p">)</span><span class="w"> </span><span class="nx">Cost</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">calcCost</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">weights</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">something</span><span class="w"> </span><span class="kd">struct</span><span class="p">{</span><span class="w"> </span><span class="o">...</span><span class="w"> </span><span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">calcCost</span><span class="p">(</span><span class="nx">n</span><span class="w"> </span><span class="p">[]</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="p">{</span><span class="o">...</span><span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">something</span><span class="p">)</span><span class="w"> </span><span class="nx">Stop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="o">...</span><span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">newSomething</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="nx">something</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">something</span><span class="p">{}</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">something</span><span class="w"> </span><span class="kd">struct</span><span class="p">{</span><span class="w"> </span><span class="o">...</span><span class="w"> </span><span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">newSomething</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="nx">something</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">something</span><span class="p">{}</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">something</span><span class="p">)</span><span class="w"> </span><span class="nx">Cost</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">calcCost</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">weights</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">something</span><span class="p">)</span><span class="w"> </span><span class="nx">Stop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="o">...</span><span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">calcCost</span><span class="p">(</span><span class="nx">n</span><span class="w"> </span><span class="p">[]</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="p">{</span><span class="o">...</span><span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
<section id="id32">
<h2><span class="section-number">4.2.8.9. </span>减少嵌套<a class="headerlink" href="#id32" title="Permalink to this heading"></a></h2>
<p>代码应通过尽可能先处理错误情况/特殊情况并尽早返回或继续循环来减少嵌套。减少嵌套多个级别的代码的代码量。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">v</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">v</span><span class="p">.</span><span class="nx">F1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">v</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">process</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">v</span><span class="p">.</span><span class="nx">Call</span><span class="p">();</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">v</span><span class="p">.</span><span class="nx">Send</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Invalid v: %v&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">v</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">v</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">v</span><span class="p">.</span><span class="nx">F1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Invalid v: %v&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">v</span><span class="p">)</span>
<span class="w">    </span><span class="k">continue</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">v</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">process</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">v</span><span class="p">.</span><span class="nx">Call</span><span class="p">();</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="nx">v</span><span class="p">.</span><span class="nx">Send</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
<section id="else">
<h2><span class="section-number">4.2.8.10. </span>不必要的 else<a class="headerlink" href="#else" title="Permalink to this heading"></a></h2>
<p>如果在 if 的两个分支中都设置了变量，则可以将其替换为单个 if。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="kt">int</span>
<span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">a</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">100</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">a</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">10</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">a</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">10</span>
<span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">a</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">100</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
<section id="id33">
<h2><span class="section-number">4.2.8.11. </span>顶层变量声明<a class="headerlink" href="#id33" title="Permalink to this heading"></a></h2>
<p>在顶层，使用标准<code class="docutils literal notranslate"><span class="pre">var</span></code>关键字。请勿指定类型，除非它与表达式的类型不同。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">_s</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">F</span><span class="p">()</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">F</span><span class="p">()</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;A&quot;</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">_s</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">F</span><span class="p">()</span>
<span class="c1">// 由于 F 已经明确了返回一个字符串类型，因此我们没有必要显式指定_s 的类型</span>
<span class="c1">// 还是那种类型</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">F</span><span class="p">()</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;A&quot;</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>如果表达式的类型与所需的类型不完全匹配，请指定类型。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">myError</span><span class="w"> </span><span class="kd">struct</span><span class="p">{}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">myError</span><span class="p">)</span><span class="w"> </span><span class="nx">Error</span><span class="p">()</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;error&quot;</span><span class="w"> </span><span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">F</span><span class="p">()</span><span class="w"> </span><span class="nx">myError</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">myError</span><span class="p">{}</span><span class="w"> </span><span class="p">}</span>

<span class="kd">var</span><span class="w"> </span><span class="nx">_e</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">F</span><span class="p">()</span>
<span class="c1">// F 返回一个 myError 类型的实例，但是我们要 error 类型</span>
</pre></div>
</div>
</section>
<section id="id34">
<h2><span class="section-number">4.2.8.12. </span>对于未导出的顶层常量和变量，使用_作为前缀<a class="headerlink" href="#id34" title="Permalink to this heading"></a></h2>
<p>在未导出的顶级<code class="docutils literal notranslate"><span class="pre">vars</span></code>和<code class="docutils literal notranslate"><span class="pre">consts</span></code>， 前面加上前缀_，以使它们在使用时明确表示它们是全局符号。</p>
<p>基本依据：顶级变量和常量具有包范围作用域。使用通用名称可能很容易在其他文件中意外使用错误的值。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// foo.go</span>

<span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="nx">defaultPort</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">8080</span>
<span class="w">  </span><span class="nx">defaultUser</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;user&quot;</span>
<span class="p">)</span>

<span class="c1">// bar.go</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">Bar</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">defaultPort</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">9090</span>
<span class="w">  </span><span class="o">...</span>
<span class="w">  </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Default port&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">defaultPort</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// We will not see a compile error if the first line of</span>
<span class="w">  </span><span class="c1">// Bar() is deleted.</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// foo.go</span>

<span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="nx">_defaultPort</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">8080</span>
<span class="w">  </span><span class="nx">_defaultUser</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;user&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p><strong>例外</strong>：未导出的错误值可以使用不带下划线的前缀 <code class="docutils literal notranslate"><span class="pre">err</span></code>。 参见<a class="reference external" href="#%E9%94%99%E8%AF%AF%E5%91%BD%E5%90%8D">错误命名</a>。</p>
</section>
<section id="id35">
<h2><span class="section-number">4.2.8.13. </span>结构体中的嵌入<a class="headerlink" href="#id35" title="Permalink to this heading"></a></h2>
<p>嵌入式类型（例如 mutex）应位于结构体内的字段列表的顶部，并且必须有一个空行将嵌入式字段与常规字段分隔开。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Client</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">version</span><span class="w"> </span><span class="kt">int</span>
<span class="w">  </span><span class="nx">http</span><span class="p">.</span><span class="nx">Client</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Client</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">http</span><span class="p">.</span><span class="nx">Client</span>

<span class="w">  </span><span class="nx">version</span><span class="w"> </span><span class="kt">int</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>内嵌应该提供切实的好处，比如以语义上合适的方式添加或增强功能。
它应该在对用户没有任何不利影响的情况下使用。（另请参见：<a class="reference external" href="#%E9%81%BF%E5%85%8D%E5%9C%A8%E5%85%AC%E5%85%B1%E7%BB%93%E6%9E%84%E4%B8%AD%E5%B5%8C%E5%85%A5%E7%B1%BB%E5%9E%8B">避免在公共结构中嵌入类型</a>）。</p>
<p>例外：即使在未导出类型中，Mutex 也不应该作为内嵌字段。另请参见：<a class="reference external" href="#%E9%9B%B6%E5%80%BC-mutex-%E6%98%AF%E6%9C%89%E6%95%88%E7%9A%84">零值 Mutex 是有效的</a>。</p>
<p>嵌入 <strong>不应该</strong>:</p>
<ul class="simple">
<li><p>纯粹是为了美观或方便。</p></li>
<li><p>使外部类型更难构造或使用。</p></li>
<li><p>影响外部类型的零值。如果外部类型有一个有用的零值，则在嵌入内部类型之后应该仍然有一个有用的零值。</p></li>
<li><p>作为嵌入内部类型的副作用，从外部类型公开不相关的函数或字段。</p></li>
<li><p>公开未导出的类型。</p></li>
<li><p>影响外部类型的复制形式。</p></li>
<li><p>更改外部类型的 API 或类型语义。</p></li>
<li><p>嵌入内部类型的非规范形式。</p></li>
<li><p>公开外部类型的实现详细信息。</p></li>
<li><p>允许用户观察或控制类型内部。</p></li>
<li><p>通过包装的方式改变内部函数的一般行为，这种包装方式会给用户带来一些意料之外情况。</p></li>
</ul>
<p>简单地说，有意识地和有目的地嵌入。一种很好的测试体验是，
“是否所有这些导出的内部方法/字段都将直接添加到外部类型”
如果答案是<code class="docutils literal notranslate"><span class="pre">some</span></code>或<code class="docutils literal notranslate"><span class="pre">no</span></code>，不要嵌入内部类型 - 而是使用字段。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">A</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Bad: A.Lock() and A.Unlock() 现在可用</span>
<span class="w">    </span><span class="c1">// 不提供任何功能性好处，并允许用户控制有关 A 的内部细节。</span>
<span class="w">    </span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">countingWriteCloser</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Good: Write() 在外层提供用于特定目的，</span>
<span class="w">    </span><span class="c1">// 并且委托工作到内部类型的 Write() 中。</span>
<span class="w">    </span><span class="nx">io</span><span class="p">.</span><span class="nx">WriteCloser</span>
<span class="w">    </span><span class="nx">count</span><span class="w"> </span><span class="kt">int</span>
<span class="p">}</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">w</span><span class="w"> </span><span class="o">*</span><span class="nx">countingWriteCloser</span><span class="p">)</span><span class="w"> </span><span class="nx">Write</span><span class="p">(</span><span class="nx">bs</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">w</span><span class="p">.</span><span class="nx">count</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">bs</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">WriteCloser</span><span class="p">.</span><span class="nx">Write</span><span class="p">(</span><span class="nx">bs</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Book</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Bad: 指针更改零值的有用性</span>
<span class="w">    </span><span class="nx">io</span><span class="p">.</span><span class="nx">ReadWriter</span>
<span class="w">    </span><span class="c1">// other fields</span>
<span class="p">}</span>
<span class="c1">// later</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="nx">Book</span>
<span class="nx">b</span><span class="p">.</span><span class="nx">Read</span><span class="p">(</span><span class="o">...</span><span class="p">)</span><span class="w">  </span><span class="c1">// panic: nil pointer</span>
<span class="nx">b</span><span class="p">.</span><span class="nx">String</span><span class="p">()</span><span class="w">   </span><span class="c1">// panic: nil pointer</span>
<span class="nx">b</span><span class="p">.</span><span class="nx">Write</span><span class="p">(</span><span class="o">...</span><span class="p">)</span><span class="w"> </span><span class="c1">// panic: nil pointer</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Book</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Good: 有用的零值</span>
<span class="w">    </span><span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span>
<span class="w">    </span><span class="c1">// other fields</span>
<span class="p">}</span>
<span class="c1">// later</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="nx">Book</span>
<span class="nx">b</span><span class="p">.</span><span class="nx">Read</span><span class="p">(</span><span class="o">...</span><span class="p">)</span><span class="w">  </span><span class="c1">// ok</span>
<span class="nx">b</span><span class="p">.</span><span class="nx">String</span><span class="p">()</span><span class="w">   </span><span class="c1">// ok</span>
<span class="nx">b</span><span class="p">.</span><span class="nx">Write</span><span class="p">(</span><span class="o">...</span><span class="p">)</span><span class="w"> </span><span class="c1">// ok</span>
</pre></div>
</div>
</td></tr>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Client</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
<span class="w">    </span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
<span class="w">    </span><span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span>
<span class="w">    </span><span class="nx">url</span><span class="p">.</span><span class="nx">URL</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Client</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">mtx</span><span class="w"> </span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
<span class="w">    </span><span class="nx">wg</span><span class="w">  </span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
<span class="w">    </span><span class="nx">buf</span><span class="w"> </span><span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span>
<span class="w">    </span><span class="nx">url</span><span class="w"> </span><span class="nx">url</span><span class="p">.</span><span class="nx">URL</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
<section id="id36">
<h2><span class="section-number">4.2.8.14. </span>本地变量声明<a class="headerlink" href="#id36" title="Permalink to this heading"></a></h2>
<p>如果将变量明确设置为某个值，则应使用短变量声明形式 (<code class="docutils literal notranslate"><span class="pre">:=</span></code>)。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;foo&quot;</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">s</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;foo&quot;</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>但是，在某些情况下，<code class="docutils literal notranslate"><span class="pre">var</span></code> 使用关键字时默认值会更清晰。例如，<a class="reference external" href="https://go.dev/wiki/CodeReviewComments#declaring-empty-slices">声明空切片</a>。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">f</span><span class="p">(</span><span class="nx">list</span><span class="w"> </span><span class="p">[]</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">filtered</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="kt">int</span><span class="p">{}</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">v</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">list</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">v</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">filtered</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">filtered</span><span class="p">,</span><span class="w"> </span><span class="nx">v</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">f</span><span class="p">(</span><span class="nx">list</span><span class="w"> </span><span class="p">[]</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">filtered</span><span class="w"> </span><span class="p">[]</span><span class="kt">int</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">v</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">list</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">v</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">filtered</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">filtered</span><span class="p">,</span><span class="w"> </span><span class="nx">v</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
<section id="nil-slice">
<h2><span class="section-number">4.2.8.15. </span>nil 是一个有效的 slice<a class="headerlink" href="#nil-slice" title="Permalink to this heading"></a></h2>
<p><code class="docutils literal notranslate"><span class="pre">nil</span></code> 是一个有效的长度为 0 的 slice，这意味着，</p>
<ul>
<li><p>您不应明确返回长度为零的切片。应该返回<code class="docutils literal notranslate"><span class="pre">nil</span></code> 来代替。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">[]</span><span class="kt">int</span><span class="p">{}</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table></li>
<li><p>要检查切片是否为空，请始终使用<code class="docutils literal notranslate"><span class="pre">len(s)</span> <span class="pre">==</span> <span class="pre">0</span></code>。而非 <code class="docutils literal notranslate"><span class="pre">nil</span></code>。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="p">[]</span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="p">[]</span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table></li>
<li><p>零值切片（用<code class="docutils literal notranslate"><span class="pre">var</span></code>声明的切片）可立即使用，无需调用<code class="docutils literal notranslate"><span class="pre">make()</span></code>创建。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">nums</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="kt">int</span><span class="p">{}</span>
<span class="c1">// or, nums := make([]int)</span>

<span class="k">if</span><span class="w"> </span><span class="nx">add1</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">nums</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">nums</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">if</span><span class="w"> </span><span class="nx">add2</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">nums</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">nums</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">nums</span><span class="w"> </span><span class="p">[]</span><span class="kt">int</span>

<span class="k">if</span><span class="w"> </span><span class="nx">add1</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">nums</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">nums</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">if</span><span class="w"> </span><span class="nx">add2</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">nums</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">nums</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table></li>
</ul>
<p>记住，虽然 nil 切片是有效的切片，但它不等于长度为 0 的切片（一个为 nil，另一个不是），并且在不同的情况下（例如序列化），这两个切片的处理方式可能不同。</p>
</section>
<section id="id37">
<h2><span class="section-number">4.2.8.16. </span>缩小变量作用域<a class="headerlink" href="#id37" title="Permalink to this heading"></a></h2>
<p>如果有可能，尽量缩小变量作用范围。除非它与 <a class="reference external" href="#%E5%87%8F%E5%B0%91%E5%B5%8C%E5%A5%97">减少嵌套</a>的规则冲突。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">WriteFile</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="mo">0644</span><span class="p">)</span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">WriteFile</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="mo">0644</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>如果需要在 if 之外使用函数调用的结果，则不应尝试缩小范围。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">ReadFile</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">cfg</span><span class="p">.</span><span class="nx">Decode</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">cfg</span><span class="p">)</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">ReadFile</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="p">}</span>

<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">cfg</span><span class="p">.</span><span class="nx">Decode</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="p">}</span>

<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">cfg</span><span class="p">)</span>
<span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
<section id="avoid-naked-parameters">
<h2><span class="section-number">4.2.8.17. </span>避免参数语义不明确 (Avoid Naked Parameters)<a class="headerlink" href="#avoid-naked-parameters" title="Permalink to this heading"></a></h2>
<p>函数调用中的<code class="docutils literal notranslate"><span class="pre">意义不明确的参数</span></code>可能会损害可读性。当参数名称的含义不明显时，请为参数添加 C 样式注释 (<code class="docutils literal notranslate"><span class="pre">/*</span> <span class="pre">...</span> <span class="pre">*/</span></code>)</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// func printInfo(name string, isLocal, done bool)</span>

<span class="nx">printInfo</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// func printInfo(name string, isLocal, done bool)</span>

<span class="nx">printInfo</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="cm">/* isLocal */</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="cm">/* done */</span><span class="p">)</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>对于上面的示例代码，还有一种更好的处理方式是将上面的 <code class="docutils literal notranslate"><span class="pre">bool</span></code> 类型换成自定义类型。将来，该参数可以支持不仅仅局限于两个状态（true/false）。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Region</span><span class="w"> </span><span class="kt">int</span>

<span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="nx">UnknownRegion</span><span class="w"> </span><span class="nx">Region</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">iota</span>
<span class="w">  </span><span class="nx">Local</span>
<span class="p">)</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">Status</span><span class="w"> </span><span class="kt">int</span>

<span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="nx">StatusReady</span><span class="w"> </span><span class="nx">Status</span><span class="p">=</span><span class="w"> </span><span class="kc">iota</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="nx">StatusDone</span>
<span class="w">  </span><span class="c1">// Maybe we will have a StatusInProgress in the future.</span>
<span class="p">)</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">printInfo</span><span class="p">(</span><span class="nx">name</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">region</span><span class="w"> </span><span class="nx">Region</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="w"> </span><span class="nx">Status</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id38">
<h2><span class="section-number">4.2.8.18. </span>使用原始字符串字面值，避免转义<a class="headerlink" href="#id38" title="Permalink to this heading"></a></h2>
<p>Go 支持使用 <a class="reference external" href="https://golang.org/ref/spec#raw_string_lit">原始字符串字面值</a>，也就是 “ ` “ 来表示原生字符串，在需要转义的场景下，我们应该尽量使用这种方案来替换。</p>
<p>可以跨越多行并包含引号。使用这些字符串可以避免更难阅读的手工转义的字符串。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">wantError</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;unknown name:\&quot;test\&quot;&quot;</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">wantError</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">`unknown error:&quot;test&quot;`</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
<section id="id39">
<h2><span class="section-number">4.2.8.19. </span>初始化结构体<a class="headerlink" href="#id39" title="Permalink to this heading"></a></h2>
<section id="id40">
<h3><span class="section-number">4.2.8.19.1. </span>使用字段名初始化结构<a class="headerlink" href="#id40" title="Permalink to this heading"></a></h3>
<p>初始化结构时，几乎应该始终指定字段名。目前由 <a class="reference external" href="https://golang.org/cmd/vet/"><code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">vet</span></code></a> 强制执行。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">k</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">User</span><span class="p">{</span><span class="s">&quot;John&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Doe&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">k</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">User</span><span class="p">{</span>
<span class="w">    </span><span class="nx">FirstName</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;John&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">LastName</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Doe&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">Admin</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>例外：当有 3 个或更少的字段时，测试表中的字段名<em>may</em>可以省略。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">tests</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="kd">struct</span><span class="p">{</span>
<span class="w">  </span><span class="nx">op</span><span class="w"> </span><span class="nx">Operation</span>
<span class="w">  </span><span class="nx">want</span><span class="w"> </span><span class="kt">string</span>
<span class="p">}{</span>
<span class="w">  </span><span class="p">{</span><span class="nx">Add</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;add&quot;</span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span><span class="nx">Subtract</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;subtract&quot;</span><span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id41">
<h3><span class="section-number">4.2.8.19.2. </span>省略结构中的零值字段<a class="headerlink" href="#id41" title="Permalink to this heading"></a></h3>
<p>初始化具有字段名的结构时，除非提供有意义的上下文，否则忽略值为零的字段。
也就是，让我们自动将这些设置为零值</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">user</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">User</span><span class="p">{</span>
<span class="w">  </span><span class="nx">FirstName</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;John&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">LastName</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Doe&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">MiddleName</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">Admin</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">user</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">User</span><span class="p">{</span>
<span class="w">  </span><span class="nx">FirstName</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;John&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">LastName</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Doe&quot;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>这有助于通过省略该上下文中的默认值来减少阅读的障碍。只指定有意义的值。</p>
<p>在字段名提供有意义上下文的地方包含零值。例如，<a class="reference external" href="#%E8%A1%A8%E9%A9%B1%E5%8A%A8%E6%B5%8B%E8%AF%95">表驱动测试</a> 中的测试用例可以受益于字段的名称，即使它们是零值的。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">tests</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="kd">struct</span><span class="p">{</span>
<span class="w">  </span><span class="nx">give</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="nx">want</span><span class="w"> </span><span class="kt">int</span>
<span class="p">}{</span>
<span class="w">  </span><span class="p">{</span><span class="nx">give</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;0&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">want</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="var">
<h3><span class="section-number">4.2.8.19.3. </span>对零值结构使用 <code class="docutils literal notranslate"><span class="pre">var</span></code><a class="headerlink" href="#var" title="Permalink to this heading"></a></h3>
<p>如果在声明中省略了结构的所有字段，请使用 <code class="docutils literal notranslate"><span class="pre">var</span></code> 声明结构。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">user</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">User</span><span class="p">{}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="nx">User</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>这将零值结构与那些具有类似于为 <a class="reference external" href="#%E5%88%9D%E5%A7%8B%E5%8C%96-maps">初始化 Maps</a> 创建的，区别于非零值字段的结构区分开来，
我们倾向于<a class="reference external" href="https://go.dev/wiki/CodeReviewComments#declaring-empty-slices">声明一个空切片</a></p>
</section>
<section id="struct">
<h3><span class="section-number">4.2.8.19.4. </span>初始化 Struct 引用<a class="headerlink" href="#struct" title="Permalink to this heading"></a></h3>
<p>在初始化结构引用时，请使用<code class="docutils literal notranslate"><span class="pre">&amp;T{}</span></code>代替<code class="docutils literal notranslate"><span class="pre">new(T)</span></code>，以使其与结构体初始化一致。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">sval</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">T</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;foo&quot;</span><span class="p">}</span>

<span class="c1">// inconsistent</span>
<span class="nx">sptr</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">new</span><span class="p">(</span><span class="nx">T</span><span class="p">)</span>
<span class="nx">sptr</span><span class="p">.</span><span class="nx">Name</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;bar&quot;</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">sval</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">T</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;foo&quot;</span><span class="p">}</span>

<span class="nx">sptr</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">T</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bar&quot;</span><span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
</section>
<section id="maps">
<h2><span class="section-number">4.2.8.20. </span>初始化 Maps<a class="headerlink" href="#maps" title="Permalink to this heading"></a></h2>
<p>对于空 map 请使用 <code class="docutils literal notranslate"><span class="pre">make(..)</span></code> 初始化， 并且 map 是通过编程方式填充的。
这使得 map 初始化在表现上不同于声明，并且它还可以方便地在 make 后添加大小提示。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="c1">// m1 读写安全;</span>
<span class="w">  </span><span class="c1">// m2 在写入时会 panic</span>
<span class="w">  </span><span class="nx">m1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="nx">T1</span><span class="p">]</span><span class="nx">T2</span><span class="p">{}</span>
<span class="w">  </span><span class="nx">m2</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="nx">T1</span><span class="p">]</span><span class="nx">T2</span>
<span class="p">)</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="c1">// m1 读写安全;</span>
<span class="w">  </span><span class="c1">// m2 在写入时会 panic</span>
<span class="w">  </span><span class="nx">m1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="nx">T1</span><span class="p">]</span><span class="nx">T2</span><span class="p">)</span>
<span class="w">  </span><span class="nx">m2</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="nx">T1</span><span class="p">]</span><span class="nx">T2</span>
<span class="p">)</span>
</pre></div>
</div>
</td></tr>
<tr><td><p>声明和初始化看起来非常相似的。</p>
</td><td><p>声明和初始化看起来差别非常大。</p>
</td></tr>
</tbody></table><p>在尽可能的情况下，请在初始化时提供 map 容量大小，详细请看 <a class="reference external" href="#%E6%8C%87%E5%AE%9AMap%E5%AE%B9%E9%87%8F%E6%8F%90%E7%A4%BA">指定 Map 容量提示</a>。</p>
<p>另外，如果 map 包含固定的元素列表，则使用 map literals(map 初始化列表) 初始化映射。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">m</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="nx">T1</span><span class="p">]</span><span class="nx">T2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span>
<span class="nx">m</span><span class="p">[</span><span class="nx">k1</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">v1</span>
<span class="nx">m</span><span class="p">[</span><span class="nx">k2</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">v2</span>
<span class="nx">m</span><span class="p">[</span><span class="nx">k3</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">v3</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">m</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="nx">T1</span><span class="p">]</span><span class="nx">T2</span><span class="p">{</span>
<span class="w">  </span><span class="nx">k1</span><span class="p">:</span><span class="w"> </span><span class="nx">v1</span><span class="p">,</span>
<span class="w">  </span><span class="nx">k2</span><span class="p">:</span><span class="w"> </span><span class="nx">v2</span><span class="p">,</span>
<span class="w">  </span><span class="nx">k3</span><span class="p">:</span><span class="w"> </span><span class="nx">v3</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>基本准则是：在初始化时使用 map 初始化列表 来添加一组固定的元素。否则使用 <code class="docutils literal notranslate"><span class="pre">make</span></code> (如果可以，请尽量指定 map 容量)。</p>
</section>
<section id="string-format">
<h2><span class="section-number">4.2.8.21. </span>字符串 string format<a class="headerlink" href="#string-format" title="Permalink to this heading"></a></h2>
<p>如果你在函数外声明<code class="docutils literal notranslate"><span class="pre">Printf</span></code>-style 函数的格式字符串，请将其设置为<code class="docutils literal notranslate"><span class="pre">const</span></code>常量。</p>
<p>这有助于<code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">vet</span></code>对格式字符串执行静态分析。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;unexpected values %v, %v\n&quot;</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;unexpected values %v, %v\n&quot;</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</td></tr>
</tbody></table></section>
<section id="printf">
<h2><span class="section-number">4.2.8.22. </span>命名 Printf 样式的函数<a class="headerlink" href="#printf" title="Permalink to this heading"></a></h2>
<p>声明<code class="docutils literal notranslate"><span class="pre">Printf</span></code>-style 函数时，请确保<code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">vet</span></code>可以检测到它并检查格式字符串。</p>
<p>这意味着您应尽可能使用预定义的<code class="docutils literal notranslate"><span class="pre">Printf</span></code>-style 函数名称。<code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">vet</span></code>将默认检查这些。有关更多信息，请参见 <a class="reference external" href="https://golang.org/cmd/vet/#hdr-Printf_family">Printf 系列</a>。</p>
<p>如果不能使用预定义的名称，请以 f 结束选择的名称：<code class="docutils literal notranslate"><span class="pre">Wrapf</span></code>，而不是<code class="docutils literal notranslate"><span class="pre">Wrap</span></code>。<code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">vet</span></code>可以要求检查特定的 Printf 样式名称，但名称必须以<code class="docutils literal notranslate"><span class="pre">f</span></code>结尾。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>go<span class="w"> </span>vet<span class="w"> </span>-printfuncs<span class="o">=</span>wrapf,statusf
</pre></div>
</div>
<p>另请参阅 <a class="reference external" href="https://kuzminva.wordpress.com/2017/11/07/go-vet-printf-family-check/">go vet: Printf family check</a>.</p>
</section>
</section>
<section id="id42">
<h1><span class="section-number">4.2.9. </span>编程模式<a class="headerlink" href="#id42" title="Permalink to this heading"></a></h1>
<section id="id43">
<h2><span class="section-number">4.2.9.1. </span>表驱动测试<a class="headerlink" href="#id43" title="Permalink to this heading"></a></h2>
<p>当测试逻辑是重复的时候，通过  <a class="reference external" href="https://go.dev/blog/subtests">subtests</a> 使用 table 驱动的方式编写 case 代码看上去会更简洁。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// func TestSplitHostPort(t *testing.T)</span>

<span class="nx">host</span><span class="p">,</span><span class="w"> </span><span class="nx">port</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">net</span><span class="p">.</span><span class="nx">SplitHostPort</span><span class="p">(</span><span class="s">&quot;192.0.2.0:8000&quot;</span><span class="p">)</span>
<span class="nx">require</span><span class="p">.</span><span class="nx">NoError</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;192.0.2.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">host</span><span class="p">)</span>
<span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;8000&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">port</span><span class="p">)</span>

<span class="nx">host</span><span class="p">,</span><span class="w"> </span><span class="nx">port</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">net</span><span class="p">.</span><span class="nx">SplitHostPort</span><span class="p">(</span><span class="s">&quot;192.0.2.0:http&quot;</span><span class="p">)</span>
<span class="nx">require</span><span class="p">.</span><span class="nx">NoError</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;192.0.2.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">host</span><span class="p">)</span>
<span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;http&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">port</span><span class="p">)</span>

<span class="nx">host</span><span class="p">,</span><span class="w"> </span><span class="nx">port</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">net</span><span class="p">.</span><span class="nx">SplitHostPort</span><span class="p">(</span><span class="s">&quot;:8000&quot;</span><span class="p">)</span>
<span class="nx">require</span><span class="p">.</span><span class="nx">NoError</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">host</span><span class="p">)</span>
<span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;8000&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">port</span><span class="p">)</span>

<span class="nx">host</span><span class="p">,</span><span class="w"> </span><span class="nx">port</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">net</span><span class="p">.</span><span class="nx">SplitHostPort</span><span class="p">(</span><span class="s">&quot;1:8&quot;</span><span class="p">)</span>
<span class="nx">require</span><span class="p">.</span><span class="nx">NoError</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;1&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">host</span><span class="p">)</span>
<span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;8&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">port</span><span class="p">)</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// func TestSplitHostPort(t *testing.T)</span>

<span class="nx">tests</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="kd">struct</span><span class="p">{</span>
<span class="w">  </span><span class="nx">give</span><span class="w">     </span><span class="kt">string</span>
<span class="w">  </span><span class="nx">wantHost</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="nx">wantPort</span><span class="w"> </span><span class="kt">string</span>
<span class="p">}{</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nx">give</span><span class="p">:</span><span class="w">     </span><span class="s">&quot;192.0.2.0:8000&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">wantHost</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;192.0.2.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">wantPort</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;8000&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nx">give</span><span class="p">:</span><span class="w">     </span><span class="s">&quot;192.0.2.0:http&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">wantHost</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;192.0.2.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">wantPort</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nx">give</span><span class="p">:</span><span class="w">     </span><span class="s">&quot;:8000&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">wantHost</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">wantPort</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;8000&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nx">give</span><span class="p">:</span><span class="w">     </span><span class="s">&quot;1:8&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">wantHost</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">wantPort</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;8&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">}</span>

<span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">tt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">tests</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">tt</span><span class="p">.</span><span class="nx">give</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">host</span><span class="p">,</span><span class="w"> </span><span class="nx">port</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">net</span><span class="p">.</span><span class="nx">SplitHostPort</span><span class="p">(</span><span class="nx">tt</span><span class="p">.</span><span class="nx">give</span><span class="p">)</span>
<span class="w">    </span><span class="nx">require</span><span class="p">.</span><span class="nx">NoError</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">tt</span><span class="p">.</span><span class="nx">wantHost</span><span class="p">,</span><span class="w"> </span><span class="nx">host</span><span class="p">)</span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">tt</span><span class="p">.</span><span class="nx">wantPort</span><span class="p">,</span><span class="w"> </span><span class="nx">port</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>很明显，使用 test table 的方式在代码逻辑扩展的时候，比如新增 test case，都会显得更加的清晰。</p>
<p>我们遵循这样的约定：将结构体切片称为<code class="docutils literal notranslate"><span class="pre">tests</span></code>。 每个测试用例称为<code class="docutils literal notranslate"><span class="pre">tt</span></code>。此外，我们鼓励使用<code class="docutils literal notranslate"><span class="pre">give</span></code>和<code class="docutils literal notranslate"><span class="pre">want</span></code>前缀说明每个测试用例的输入和输出值。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">tests</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="kd">struct</span><span class="p">{</span>
<span class="w">  </span><span class="nx">give</span><span class="w">     </span><span class="kt">string</span>
<span class="w">  </span><span class="nx">wantHost</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="nx">wantPort</span><span class="w"> </span><span class="kt">string</span>
<span class="p">}{</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>

<span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">tt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">tests</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>并行测试，比如一些专门的循环（例如，生成goroutine或捕获引用作为循环体的一部分的那些循环）
必须注意在循环的范围内显式地分配循环变量，以确保它们保持预期的值。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">tests</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="kd">struct</span><span class="p">{</span>
<span class="w">  </span><span class="nx">give</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}{</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
<span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">tt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">tests</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">tt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">tt</span><span class="w"> </span><span class="c1">// for t.Parallel</span>
<span class="w">  </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">tt</span><span class="p">.</span><span class="nx">give</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Parallel</span><span class="p">()</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">}</span>
</pre></div>
</div>
<p>在上面的例子中，由于下面使用了<code class="docutils literal notranslate"><span class="pre">t.Parallel()</span></code>，我们必须声明一个作用域为循环迭代的<code class="docutils literal notranslate"><span class="pre">tt</span></code>变量。
如果我们不这样做，大多数或所有测试都会收到一个意外的<code class="docutils literal notranslate"><span class="pre">tt</span></code>值，或者一个在运行时发生变化的值。</p>
</section>
<section id="id44">
<h2><span class="section-number">4.2.9.2. </span>功能选项<a class="headerlink" href="#id44" title="Permalink to this heading"></a></h2>
<p>功能选项是一种模式，您可以在其中声明一个不透明 Option 类型，该类型在某些内部结构中记录信息。您接受这些选项的可变编号，并根据内部结构上的选项记录的全部信息采取行动。</p>
<p>将此模式用于您需要扩展的构造函数和其他公共 API 中的可选参数，尤其是在这些功能上已经具有三个或更多参数的情况下。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// package db</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">Open</span><span class="p">(</span>
<span class="w">  </span><span class="nx">addr</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">  </span><span class="nx">cache</span><span class="w"> </span><span class="kt">bool</span><span class="p">,</span>
<span class="w">  </span><span class="nx">logger</span><span class="w"> </span><span class="o">*</span><span class="nx">zap</span><span class="p">.</span><span class="nx">Logger</span>
<span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">Connection</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</td><td><div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// package db</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">Option</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">WithCache</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="nx">Option</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">WithLogger</span><span class="p">(</span><span class="nx">log</span><span class="w"> </span><span class="o">*</span><span class="nx">zap</span><span class="p">.</span><span class="nx">Logger</span><span class="p">)</span><span class="w"> </span><span class="nx">Option</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>

<span class="c1">// Open creates a connection.</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">Open</span><span class="p">(</span>
<span class="w">  </span><span class="nx">addr</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">  </span><span class="nx">opts</span><span class="w"> </span><span class="o">...</span><span class="nx">Option</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">Connection</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</td></tr>
<tr><td><p>必须始终提供缓存和记录器参数，即使用户希望使用默认值。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">db</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">DefaultCache</span><span class="p">,</span><span class="w"> </span><span class="nx">zap</span><span class="p">.</span><span class="nx">NewNop</span><span class="p">())</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">DefaultCache</span><span class="p">,</span><span class="w"> </span><span class="nx">log</span><span class="p">)</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="cm">/* cache */</span><span class="p">,</span><span class="w"> </span><span class="nx">zap</span><span class="p">.</span><span class="nx">NewNop</span><span class="p">())</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="cm">/* cache */</span><span class="p">,</span><span class="w"> </span><span class="nx">log</span><span class="p">)</span>
</pre></div>
</div>
</td><td><p>只有在需要时才提供选项。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">db</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">WithLogger</span><span class="p">(</span><span class="nx">log</span><span class="p">))</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">WithCache</span><span class="p">(</span><span class="kc">false</span><span class="p">))</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span>
<span class="w">  </span><span class="nx">addr</span><span class="p">,</span>
<span class="w">  </span><span class="nx">db</span><span class="p">.</span><span class="nx">WithCache</span><span class="p">(</span><span class="kc">false</span><span class="p">),</span>
<span class="w">  </span><span class="nx">db</span><span class="p">.</span><span class="nx">WithLogger</span><span class="p">(</span><span class="nx">log</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</td></tr>
</tbody></table><p>我们建议实现此模式的方法是使用一个 <code class="docutils literal notranslate"><span class="pre">Option</span></code> 接口，该接口保存一个未导出的方法，在一个未导出的 <code class="docutils literal notranslate"><span class="pre">options</span></code> 结构上记录选项。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">cache</span><span class="w">  </span><span class="kt">bool</span>
<span class="w">  </span><span class="nx">logger</span><span class="w"> </span><span class="o">*</span><span class="nx">zap</span><span class="p">.</span><span class="nx">Logger</span>
<span class="p">}</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">Option</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">apply</span><span class="p">(</span><span class="o">*</span><span class="nx">options</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">cacheOption</span><span class="w"> </span><span class="kt">bool</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="nx">cacheOption</span><span class="p">)</span><span class="w"> </span><span class="nx">apply</span><span class="p">(</span><span class="nx">opts</span><span class="w"> </span><span class="o">*</span><span class="nx">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">opts</span><span class="p">.</span><span class="nx">cache</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">bool</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">WithCache</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="nx">Option</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">cacheOption</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">loggerOption</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">Log</span><span class="w"> </span><span class="o">*</span><span class="nx">zap</span><span class="p">.</span><span class="nx">Logger</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">l</span><span class="w"> </span><span class="nx">loggerOption</span><span class="p">)</span><span class="w"> </span><span class="nx">apply</span><span class="p">(</span><span class="nx">opts</span><span class="w"> </span><span class="o">*</span><span class="nx">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">opts</span><span class="p">.</span><span class="nx">logger</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">l</span><span class="p">.</span><span class="nx">Log</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">WithLogger</span><span class="p">(</span><span class="nx">log</span><span class="w"> </span><span class="o">*</span><span class="nx">zap</span><span class="p">.</span><span class="nx">Logger</span><span class="p">)</span><span class="w"> </span><span class="nx">Option</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">loggerOption</span><span class="p">{</span><span class="nx">Log</span><span class="p">:</span><span class="w"> </span><span class="nx">log</span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Open creates a connection.</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">Open</span><span class="p">(</span>
<span class="w">  </span><span class="nx">addr</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">  </span><span class="nx">opts</span><span class="w"> </span><span class="o">...</span><span class="nx">Option</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">Connection</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">options</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">options</span><span class="p">{</span>
<span class="w">    </span><span class="nx">cache</span><span class="p">:</span><span class="w">  </span><span class="nx">defaultCache</span><span class="p">,</span>
<span class="w">    </span><span class="nx">logger</span><span class="p">:</span><span class="w"> </span><span class="nx">zap</span><span class="p">.</span><span class="nx">NewNop</span><span class="p">(),</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">o</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">opts</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">o</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">options</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>注意：还有一种使用闭包实现这个模式的方法，但是我们相信上面的模式为作者提供了更多的灵活性，并且更容易对用户进行调试和测试。特别是，我们的这种方式允许在测试和模拟中比较选项，这在闭包实现中几乎是不可能的。此外，它还允许选项实现其他接口，包括 <code class="docutils literal notranslate"><span class="pre">fmt.Stringer</span></code>，允许用户读取选项的字符串表示形式。</p>
<p>还可以参考下面资料：</p>
<ul class="simple">
<li><p><a class="reference external" href="https://commandcenter.blogspot.com/2014/01/self-referential-functions-and-design.html">Self-referential functions and the design of options</a></p></li>
<li><p><a class="reference external" href="https://dave.cheney.net/2014/10/17/functional-options-for-friendly-apis">Functional options for friendly APIs</a></p></li>
</ul>
<!-- TODO: replace this with parameter structs and functional options, when to
use one vs other --></section>
</section>
<section id="linting">
<h1><span class="section-number">4.2.10. </span>Linting<a class="headerlink" href="#linting" title="Permalink to this heading"></a></h1>
<p>比任何 “blessed” linter 集更重要的是，lint 在一个代码库中始终保持一致。</p>
<p>我们建议至少使用以下 linters，因为我认为它们有助于发现最常见的问题，并在不需要规定的情况下为代码质量建立一个高标准：</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/kisielk/errcheck">errcheck</a> 以确保错误得到处理</p></li>
<li><p><a class="reference external" href="https://pkg.go.dev/golang.org/x/tools/cmd/goimports">goimports</a> 格式化代码和管理 imports</p></li>
<li><p><a class="reference external" href="https://github.com/golang/lint">golint</a> 指出常见的文体错误</p></li>
<li><p><a class="reference external" href="https://golang.org/cmd/vet/">govet</a> 分析代码中的常见错误</p></li>
<li><p><a class="reference external" href="https://staticcheck.io/">staticcheck</a> 各种静态分析检查</p></li>
</ul>
<section id="lint-runners">
<h2><span class="section-number">4.2.10.1. </span>Lint Runners<a class="headerlink" href="#lint-runners" title="Permalink to this heading"></a></h2>
<p>我们推荐 <a class="reference external" href="https://github.com/golangci/golangci-lint">golangci-lint</a> 作为 go-to lint 的运行程序，这主要是因为它在较大的代码库中的性能以及能够同时配置和使用许多规范。这个 repo 有一个示例配置文件 <a class="reference external" href="https://github.com/uber-go/guide/blob/master/.golangci.yml">.golangci.yml</a> 和推荐的 linter 设置。</p>
<p>golangci-lint 有 <a class="reference external" href="https://golangci-lint.run/usage/linters/">various-linters</a> 可供使用。建议将上述 linters 作为基本 set，我们鼓励团队添加对他们的项目有意义的任何附加 linters。</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="页脚">
        <a href="index.html" class="btn btn-neutral float-left" title="4.2. Uber: Go语言 风格指南" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="../google-python-styleguide/contents.html" class="btn btn-neutral float-right" title="4.3. Google: Python 风格指南" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2024.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
  
<div class="view_counter">
      <img class="img_view_counter" src="https://s01.flagcounter.com/count2/m02K/bg_FFFFFF/txt_F77B1B/border_CCCCCC/columns_3/maxflags_6/viewers_3/labels_1/pageviews_0/flags_0/percent_0/" alt="View Counter" border="0" />
</div>


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="版本">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Read the Docs</span>
        v: latest
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>版本</dt>
            <dd><a href="#">latest</a></dd>
        </dl>
    </div>
</div>

</body>
</html>